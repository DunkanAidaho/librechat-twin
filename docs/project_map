# Project Map

Alphabetical reference of `api` JS files with call graph and statuses.

## app/clients/AnthropicClient.js
Purpose: External API clients
Inbound Links: none detected
Exports: None
Functions:
- abortHandler: status=сирота; callers: —; Purpose: local helper to abort handler
- buildMessagesPayload: status=используется; callers: app/clients/AnthropicClient.js; Purpose: triggered from app/clients/AnthropicClient.js to build messages payload
- buildPromptBody: status=используется | опасность, дублируется в: app/clients/AnthropicClient.js, app/clients/GoogleClient.js; callers: app/clients/AnthropicClient.js, app/clients/GoogleClient.js; Purpose: triggered from app/clients/AnthropicClient.js, app/clients/GoogleClient.js to build prompt body
- delayBeforeRetry: status=используется; callers: app/clients/AnthropicClient.js; Purpose: triggered from app/clients/AnthropicClient.js to delay before retry
- executeRequest: status=сирота; callers: —; Purpose: local helper to execute request
- processTokens: status=используется; callers: app/clients/AnthropicClient.js; Purpose: triggered from app/clients/AnthropicClient.js to process tokens
- titleChatCompletion: status=используется | опасность, дублируется в: app/clients/AnthropicClient.js, app/clients/OpenAIClient.js; callers: app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js; Purpose: triggered from app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js to title chat completion
Logging status: ❌ нет scoped-логирования; требуется внедрить `logger.scope('clients.anthropic')` для событий `request:start|token|retry|error`.
Outgoing Calls:
- require: count=11; defined_in=external/unknown; Purpose: invokes require
- test: count=9; defined_in=external/unknown; Purpose: invokes test
- debug: count=9; defined_in=external/unknown; Purpose: invokes debug
- getTokenCountForMessage: count=6; defined_in=external/unknown; Purpose: invokes get token count for message
- warn: count=4; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- trim: count=4; defined_in=external/unknown; Purpose: invokes trim
- getTokenCount: count=4; defined_in=external/unknown; Purpose: invokes get token count
- getStreamText: count=3; defined_in=external/unknown; Purpose: invokes get stream text
- assign: count=2; defined_in=external/unknown; Purpose: invokes assign
- reset: count=2; defined_in=external/unknown; Purpose: invokes reset
- reduce: count=2; defined_in=external/unknown; Purpose: invokes reduce
- map: count=2; defined_in=external/unknown; Purpose: invokes map
- push: count=2; defined_in=external/unknown; Purpose: invokes push
- getEncoding: count=2; defined_in=external/unknown; Purpose: invokes get encoding
- pop: count=2; defined_in=external/unknown; Purpose: invokes pop
- unshift: count=2; defined_in=external/unknown; Purpose: invokes unshift
- setImmediate: count=2; defined_in=external/unknown; Purpose: invokes set immediate
- buildPromptBody: count=2; defined_in=app/clients/AnthropicClient.js, app/clients/GoogleClient.js; Purpose: invokes build prompt body
- processTokens: count=2; defined_in=app/clients/AnthropicClient.js; Purpose: invokes process tokens
- replace: count=2; defined_in=external/unknown; Purpose: invokes replace
- create: count=2; defined_in=external/unknown; Purpose: invokes create
- join: count=2; defined_in=external/unknown; Purpose: invokes join
- getClient: count=2; defined_in=external/unknown; Purpose: invokes get client
- createResponse: count=2; defined_in=external/unknown; Purpose: invokes create response
- runWithClientResilience: count=2; defined_in=external/unknown; Purpose: invokes run with client resilience
- truncateText: count=2; defined_in=external/unknown; Purpose: invokes truncate text
- setTimeout: count=1; defined_in=external/unknown; Purpose: invokes set timeout
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- toLowerCase: count=1; defined_in=external/unknown; Purpose: invokes to lower case
- setOptions: count=1; defined_in=external/unknown; Purpose: invokes set options
- matchModelName: count=1; defined_in=external/unknown; Purpose: invokes match model name
- checkPromptCacheSupport: count=1; defined_in=external/unknown; Purpose: invokes check prompt cache support
- checkVisionRequest: count=1; defined_in=external/unknown; Purpose: invokes check vision request
- getModelMaxTokens: count=1; defined_in=external/unknown; Purpose: invokes get model max tokens
- getModelMaxOutputTokens: count=1; defined_in=external/unknown; Purpose: invokes get model max output tokens
- getResponseSender: count=1; defined_in=external/unknown; Purpose: invokes get response sender
- createFetch: count=1; defined_in=external/unknown; Purpose: invokes create fetch
- getClaudeHeaders: count=1; defined_in=external/unknown; Purpose: invokes get claude headers
- values: count=1; defined_in=external/unknown; Purpose: invokes values
- Number: count=1; defined_in=external/unknown; Purpose: invokes number
- isNaN: count=1; defined_in=external/unknown; Purpose: invokes is na n
- validateVisionModel: count=1; defined_in=external/unknown; Purpose: invokes validate vision model
- some: count=1; defined_in=external/unknown; Purpose: invokes some
- ceil: count=1; defined_in=external/unknown; Purpose: invokes ceil
- encodeAndFormat: count=1; defined_in=external/unknown; Purpose: invokes encode and format
- spendStructuredTokens: count=1; defined_in=external/unknown; Purpose: invokes spend structured tokens
- spendTokens: count=1; defined_in=external/unknown; Purpose: invokes spend tokens
- getMessagesForConversation: count=1; defined_in=external/unknown; Purpose: invokes get messages for conversation
- filter: count=1; defined_in=external/unknown; Purpose: invokes filter
- includes: count=1; defined_in=external/unknown; Purpose: invokes includes
- addImageURLs: count=1; defined_in=external/unknown; Purpose: invokes add image urls
- createContextHandlers: count=1; defined_in=external/unknown; Purpose: invokes create context handlers
- formatMessage: count=1; defined_in=external/unknown; Purpose: invokes format message
- calculateImageTokenCost: count=1; defined_in=external/unknown; Purpose: invokes calculate image token cost
- createContext: count=1; defined_in=external/unknown; Purpose: invokes create context
- getMessagesWithinTokenLimit: count=1; defined_in=external/unknown; Purpose: invokes get messages within token limit
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- endsWith: count=1; defined_in=external/unknown; Purpose: invokes ends with
- normalizeInstructionsPayload: count=1; defined_in=app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes normalize instructions payload
- min: count=1; defined_in=external/unknown; Purpose: invokes min
- buildMessagesPayload: count=1; defined_in=app/clients/AnthropicClient.js; Purpose: invokes build messages payload
- shift: count=1; defined_in=external/unknown; Purpose: invokes shift
- startsWith: count=1; defined_in=external/unknown; Purpose: invokes starts with
- parseTextParts: count=1; defined_in=external/unknown; Purpose: invokes parse text parts
- configureReasoning: count=1; defined_in=external/unknown; Purpose: invokes configure reasoning
- addCacheControl: count=1; defined_in=external/unknown; Purpose: invokes add cache control
- createStreamEventHandlers: count=1; defined_in=external/unknown; Purpose: invokes create stream event handlers
- abort: count=1; defined_in=external/unknown; Purpose: invokes abort
- addEventListener: count=1; defined_in=external/unknown; Purpose: invokes add event listener
- has: count=1; defined_in=external/unknown; Purpose: invokes has
- handle: count=1; defined_in=external/unknown; Purpose: invokes handle
- sleep: count=1; defined_in=utils/async.js; Purpose: invokes sleep
- removeEventListener: count=1; defined_in=external/unknown; Purpose: invokes remove event listener
- delayBeforeRetry: count=1; defined_in=app/clients/AnthropicClient.js; Purpose: invokes delay before retry
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- recordTokenUsage: count=1; defined_in=external/unknown; Purpose: invokes record token usage
- parseParamFromPrompt: count=1; defined_in=external/unknown; Purpose: invokes parse param from prompt
- error: count=1; defined_in=external/unknown; Purpose: invokes error
- titleChatCompletion: count=1; defined_in=app/clients/AnthropicClient.js, app/clients/OpenAIClient.js; Purpose: invokes title chat completion

## app/clients/BaseClient.js
Purpose: External API clients
Inbound Links: none detected
Exports: None
Functions:
- computeTokens: status=используется | опасность, дублируется в: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; callers: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: triggered from app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js to compute tokens
- operation: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to operation
- parsePositiveInt: status=используется; callers: app/clients/BaseClient.js; Purpose: triggered from app/clients/BaseClient.js to parse positive int
- processMessage: status=используется; callers: app/clients/BaseClient.js; Purpose: triggered from app/clients/BaseClient.js to process message
- processValue: status=используется; callers: app/clients/BaseClient.js; Purpose: triggered from app/clients/BaseClient.js to process value
- resolveEncoding: status=используется | опасность, дублируется в: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; callers: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: triggered from app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js to resolve encoding
Logging status: ❌ использует mix `debug/warn`; нужно перейти на scoped logger (см. Transparent logging initiative).
Outgoing Calls:
- debug: count=16; defined_in=external/unknown; Purpose: invokes debug
- push: count=12; defined_in=external/unknown; Purpose: invokes push
- require: count=11; defined_in=external/unknown; Purpose: invokes require
- Number: count=9; defined_in=external/unknown; Purpose: invokes number
- warn: count=8; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- getTokenCount: count=7; defined_in=external/unknown; Purpose: invokes get token count
- isFinite: count=6; defined_in=external/unknown; Purpose: invokes is finite
- randomUUID: count=5; defined_in=external/unknown; Purpose: invokes random uuid
- add: count=5; defined_in=external/unknown; Purpose: invokes add
- isArray: count=4; defined_in=external/unknown; Purpose: invokes is array
- has: count=4; defined_in=external/unknown; Purpose: invokes has
- concat: count=4; defined_in=external/unknown; Purpose: invokes concat
- info: count=3; defined_in=external/unknown; Purpose: invokes info
- parsePositiveInt: count=3; defined_in=app/clients/BaseClient.js; Purpose: invokes parse positive int
- getReqData: count=3; defined_in=server/controllers/agents/request.js; Purpose: invokes get req data
- slice: count=3; defined_in=external/unknown; Purpose: invokes slice
- fetch: count=2; defined_in=external/unknown; Purpose: invokes fetch
- split: count=2; defined_in=external/unknown; Purpose: invokes split
- setOptions: count=2; defined_in=external/unknown; Purpose: invokes set options
- trim: count=2; defined_in=external/unknown; Purpose: invokes trim
- safeWarn: count=2; defined_in=external/unknown; Purpose: invokes safe warn
- computeTokens: count=2; defined_in=app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes compute tokens
- updateMessageInDatabase: count=2; defined_in=external/unknown; Purpose: invokes update message in database
- reduce: count=2; defined_in=external/unknown; Purpose: invokes reduce
- reverse: count=2; defined_in=external/unknown; Purpose: invokes reverse
- addInstructions: count=2; defined_in=external/unknown; Purpose: invokes add instructions
- unshift: count=2; defined_in=external/unknown; Purpose: invokes unshift
- saveMessageToDatabase: count=2; defined_in=external/unknown; Purpose: invokes save message to database
- sendCompletion: count=2; defined_in=external/unknown; Purpose: invokes send completion
- all: count=2; defined_in=external/unknown; Purpose: invokes all
- map: count=2; defined_in=external/unknown; Purpose: invokes map
- processValue: count=2; defined_in=app/clients/BaseClient.js; Purpose: invokes process value
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- parseInt: count=1; defined_in=external/unknown; Purpose: invokes parse int
- toLocaleDateString: count=1; defined_in=external/unknown; Purpose: invokes to locale date string
- isAgentsEndpoint: count=1; defined_in=external/unknown; Purpose: invokes is agents endpoint
- assign: count=1; defined_in=external/unknown; Purpose: invokes assign
- getClientTimeoutMs: count=1; defined_in=external/unknown; Purpose: invokes get client timeout ms
- getClientRetryOptions: count=1; defined_in=external/unknown; Purpose: invokes get client retry options
- beforeAttempt: count=1; defined_in=external/unknown; Purpose: invokes before attempt
- resolve: count=1; defined_in=external/unknown; Purpose: invokes resolve
- task: count=1; defined_in=external/unknown; Purpose: invokes task
- withTimeout: count=1; defined_in=server/controllers/agents/client.js, utils/async.js; Purpose: invokes with timeout
- retryAsync: count=1; defined_in=utils/async.js; Purpose: invokes retry async
- onRetry: count=1; defined_in=external/unknown; Purpose: invokes on retry
- processTextStream: count=1; defined_in=external/unknown; Purpose: invokes process text stream
- processOverideIds: count=1; defined_in=external/unknown; Purpose: invokes process overide ids
- getSaveOptions: count=1; defined_in=external/unknown; Purpose: invokes get save options
- loadHistory: count=1; defined_in=external/unknown; Purpose: invokes load history
- endsWith: count=1; defined_in=external/unknown; Purpose: invokes ends with
- setMessageOptions: count=1; defined_in=external/unknown; Purpose: invokes set message options
- createUserMessage: count=1; defined_in=external/unknown; Purpose: invokes create user message
- onStart: count=1; defined_in=external/unknown; Purpose: invokes on start
- encodingResolver: count=1; defined_in=external/unknown; Purpose: invokes encoding resolver
- getEncoding: count=1; defined_in=external/unknown; Purpose: invokes get encoding
- resolveEncoding: count=1; defined_in=app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes resolve encoding
- keys: count=1; defined_in=external/unknown; Purpose: invokes keys
- pop: count=1; defined_in=external/unknown; Purpose: invokes pop
- shift: count=1; defined_in=external/unknown; Purpose: invokes shift
- truncateToolCallOutputs: count=1; defined_in=external/unknown; Purpose: invokes truncate tool call outputs
- bind: count=1; defined_in=external/unknown; Purpose: invokes bind
- getMessagesWithinTokenLimit: count=1; defined_in=external/unknown; Purpose: invokes get messages within token limit
- summarizeMessages: count=1; defined_in=external/unknown; Purpose: invokes summarize messages
- handleStartMethods: count=1; defined_in=external/unknown; Purpose: invokes handle start methods
- call: count=1; defined_in=external/unknown; Purpose: invokes call
- buildMessages: count=1; defined_in=external/unknown; Purpose: invokes build messages
- getBuildMessagesOptions: count=1; defined_in=external/unknown; Purpose: invokes get build messages options
- handleTokenCountMap: count=1; defined_in=external/unknown; Purpose: invokes handle token count map
- getBalanceConfig: count=1; defined_in=external/unknown; Purpose: invokes get balance config
- checkBalance: count=1; defined_in=external/unknown; Purpose: invokes check balance
- getResponseModel: count=1; defined_in=external/unknown; Purpose: invokes get response model
- isParamEndpoint: count=1; defined_in=external/unknown; Purpose: invokes is param endpoint
- mergeEditedContent: count=1; defined_in=external/unknown; Purpose: invokes merge edited content
- join: count=1; defined_in=external/unknown; Purpose: invokes join
- getStreamUsage: count=1; defined_in=external/unknown; Purpose: invokes get stream usage
- updateUserMessageTokenCount: count=1; defined_in=external/unknown; Purpose: invokes update user message token count
- getTokenCountForResponse: count=1; defined_in=external/unknown; Purpose: invokes get token count for response
- recordTokenUsage: count=1; defined_in=external/unknown; Purpose: invokes record token usage
- filter: count=1; defined_in=external/unknown; Purpose: invokes filter
- error: count=1; defined_in=external/unknown; Purpose: invokes error
- calculateCurrentTokenCount: count=1; defined_in=external/unknown; Purpose: invokes calculate current token count
- getMessages: count=1; defined_in=models/Message.js; Purpose: invokes get messages
- getMessageMapMethod: count=1; defined_in=external/unknown; Purpose: invokes get message map method
- getMessagesForConversation: count=1; defined_in=external/unknown; Purpose: invokes get messages for conversation
- addPreviousAttachments: count=1; defined_in=external/unknown; Purpose: invokes add previous attachments
- saveMessage: count=1; defined_in=models/Message.js; Purpose: invokes save message
- getConvo: count=1; defined_in=models/Conversation.js; Purpose: invokes get convo
- saveConvo: count=1; defined_in=external/unknown; Purpose: invokes save convo
- updateMessage: count=1; defined_in=models/Message.js; Purpose: invokes update message
- find: count=1; defined_in=external/unknown; Purpose: invokes find
- toString: count=function toString() { [native code] }11; defined_in=external/unknown; Purpose: invokes to string
- entries: count=1; defined_in=external/unknown; Purpose: invokes entries
- getFiles: count=1; defined_in=external/unknown; Purpose: invokes get files
- addImageURLs: count=1; defined_in=external/unknown; Purpose: invokes add image urls
- processMessage: count=1; defined_in=app/clients/BaseClient.js; Purpose: invokes process message
- checkVisionRequest: count=1; defined_in=external/unknown; Purpose: invokes check vision request
- flat: count=1; defined_in=external/unknown; Purpose: invokes flat
- values: count=1; defined_in=external/unknown; Purpose: invokes values

## app/clients/GoogleClient.js
Purpose: External API clients
Inbound Links: none detected
Exports: None
Functions:
- buildPromptBody: status=используется | опасность, дублируется в: app/clients/AnthropicClient.js, app/clients/GoogleClient.js; callers: app/clients/AnthropicClient.js, app/clients/GoogleClient.js; Purpose: triggered from app/clients/AnthropicClient.js, app/clients/GoogleClient.js to build prompt body
Logging status: ❌ требуется унифицированный логгер для Google Vertex/Gemini (события отправки/stream/ошибок).
Outgoing Calls:
- require: count=16; defined_in=external/unknown; Purpose: invokes require
- push: count=8; defined_in=external/unknown; Purpose: invokes push
- trim: count=7; defined_in=external/unknown; Purpose: invokes trim
- debug: count=7; defined_in=external/unknown; Purpose: invokes debug
- test: count=6; defined_in=external/unknown; Purpose: invokes test
- warn: count=6; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- error: count=4; defined_in=external/unknown; Purpose: invokes error
- getEncoding: count=4; defined_in=external/unknown; Purpose: invokes get encoding
- map: count=4; defined_in=external/unknown; Purpose: invokes map
- getTokenCount: count=4; defined_in=external/unknown; Purpose: invokes get token count
- runWithClientResilience: count=4; defined_in=external/unknown; Purpose: invokes run with client resilience
- parse: count=3; defined_in=external/unknown; Purpose: invokes parse
- normalizeInstructionsPayload: count=3; defined_in=app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes normalize instructions payload
- initializeClient: count=3; defined_in=external/unknown; Purpose: invokes initialize client
- includes: count=3; defined_in=external/unknown; Purpose: invokes includes
- authorize: count=2; defined_in=external/unknown; Purpose: invokes authorize
- concat: count=2; defined_in=external/unknown; Purpose: invokes concat
- addImageURLs: count=2; defined_in=external/unknown; Purpose: invokes add image urls
- buildAugmentedPrompt: count=2; defined_in=external/unknown; Purpose: invokes build augmented prompt
- formatMessage: count=2; defined_in=external/unknown; Purpose: invokes format message
- formatMessages: count=2; defined_in=external/unknown; Purpose: invokes format messages
- unshift: count=2; defined_in=external/unknown; Purpose: invokes unshift
- buildPromptBody: count=2; defined_in=app/clients/AnthropicClient.js, app/clients/GoogleClient.js; Purpose: invokes build prompt body
- replace: count=2; defined_in=external/unknown; Purpose: invokes replace
- getSafetySettings: count=2; defined_in=external/unknown; Purpose: invokes get safety settings
- generateTextStream: count=2; defined_in=external/unknown; Purpose: invokes generate text stream
- isNaN: count=2; defined_in=external/unknown; Purpose: invokes is na n
- truncateText: count=2; defined_in=external/unknown; Purpose: invokes truncate text
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- setOptions: count=1; defined_in=external/unknown; Purpose: invokes set options
- reject: count=1; defined_in=external/unknown; Purpose: invokes reject
- resolve: count=1; defined_in=external/unknown; Purpose: invokes resolve
- checkVisionRequest: count=1; defined_in=external/unknown; Purpose: invokes check vision request
- getModelMaxTokens: count=1; defined_in=external/unknown; Purpose: invokes get model max tokens
- getResponseSender: count=1; defined_in=external/unknown; Purpose: invokes get response sender
- constructUrl: count=1; defined_in=external/unknown; Purpose: invokes construct url
- validateVisionModel: count=1; defined_in=external/unknown; Purpose: invokes validate vision model
- some: count=1; defined_in=external/unknown; Purpose: invokes some
- bind: count=1; defined_in=external/unknown; Purpose: invokes bind
- isArray: count=1; defined_in=external/unknown; Purpose: invokes is array
- encodeAndFormat: count=1; defined_in=external/unknown; Purpose: invokes encode and format
- createContextHandlers: count=1; defined_in=external/unknown; Purpose: invokes create context handlers
- createContext: count=1; defined_in=external/unknown; Purpose: invokes create context
- buildMessagesPrompt: count=1; defined_in=external/unknown; Purpose: invokes build messages prompt
- formatGenerativeMessages: count=1; defined_in=external/unknown; Purpose: invokes format generative messages
- all: count=1; defined_in=external/unknown; Purpose: invokes all
- getTokenCountForMessage: count=1; defined_in=external/unknown; Purpose: invokes get token count for message
- handleContextStrategy: count=1; defined_in=external/unknown; Purpose: invokes handle context strategy
- buildGenerativeMessages: count=1; defined_in=external/unknown; Purpose: invokes build generative messages
- buildVisionMessages: count=1; defined_in=external/unknown; Purpose: invokes build vision messages
- getMessagesForConversation: count=1; defined_in=external/unknown; Purpose: invokes get messages for conversation
- pop: count=1; defined_in=external/unknown; Purpose: invokes pop
- setImmediate: count=1; defined_in=external/unknown; Purpose: invokes set immediate
- shift: count=1; defined_in=external/unknown; Purpose: invokes shift
- min: count=1; defined_in=external/unknown; Purpose: invokes min
- getGenerativeModel: count=1; defined_in=external/unknown; Purpose: invokes get generative model
- createLLM: count=1; defined_in=external/unknown; Purpose: invokes create llm
- addEventListener: count=1; defined_in=external/unknown; Purpose: invokes add event listener
- generateContentStream: count=1; defined_in=external/unknown; Purpose: invokes generate content stream
- assign: count=1; defined_in=external/unknown; Purpose: invokes assign
- text: count=1; defined_in=external/unknown; Purpose: invokes text
- sleep: count=1; defined_in=utils/async.js; Purpose: invokes sleep
- stream: count=1; defined_in=external/unknown; Purpose: invokes stream
- startsWith: count=1; defined_in=external/unknown; Purpose: invokes starts with
- parseTextParts: count=1; defined_in=external/unknown; Purpose: invokes parse text parts
- reduce: count=1; defined_in=external/unknown; Purpose: invokes reduce
- values: count=1; defined_in=external/unknown; Purpose: invokes values
- Number: count=1; defined_in=external/unknown; Purpose: invokes number
- spendTokens: count=1; defined_in=external/unknown; Purpose: invokes spend tokens
- generateContent: count=1; defined_in=external/unknown; Purpose: invokes generate content
- invoke: count=1; defined_in=external/unknown; Purpose: invokes invoke
- recordTokenUsage: count=1; defined_in=external/unknown; Purpose: invokes record token usage
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- buildMessages: count=1; defined_in=external/unknown; Purpose: invokes build messages
- titleChatCompletion: count=1; defined_in=app/clients/AnthropicClient.js, app/clients/OpenAIClient.js; Purpose: invokes title chat completion
- getCompletion: count=1; defined_in=external/unknown; Purpose: invokes get completion
- request: count=1; defined_in=external/unknown; Purpose: invokes request

## app/clients/OpenAIClient.js
Purpose: External API clients
Inbound Links: none detected
Exports: None
Functions:
- errorCallback: status=сирота; callers: —; Purpose: local helper to error callback
- titleChatCompletion: status=используется | опасность, дублируется в: app/clients/AnthropicClient.js, app/clients/OpenAIClient.js; callers: app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js; Purpose: triggered from app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js to title chat completion
Logging status: ❌ legacy `debug`/`warn`; внедрить scoped logger и trace для Azure/OpenAI потоков.
Outgoing Calls:
- debug: count=17; defined_in=external/unknown; Purpose: invokes debug
- require: count=16; defined_in=external/unknown; Purpose: invokes require
- includes: count=11; defined_in=external/unknown; Purpose: invokes includes
- trim: count=9; defined_in=external/unknown; Purpose: invokes trim
- join: count=9; defined_in=external/unknown; Purpose: invokes join
- getStreamText: count=7; defined_in=external/unknown; Purpose: invokes get stream text
- test: count=6; defined_in=external/unknown; Purpose: invokes test
- startsWith: count=5; defined_in=external/unknown; Purpose: invokes starts with
- extractBaseURL: count=5; defined_in=external/unknown; Purpose: invokes extract base url
- error: count=5; defined_in=external/unknown; Purpose: invokes error
- genAzureChatCompletion: count=4; defined_in=external/unknown; Purpose: invokes gen azure chat completion
- getTokenCountForMessage: count=4; defined_in=external/unknown; Purpose: invokes get token count for message
- isArray: count=4; defined_in=external/unknown; Purpose: invokes is array
- replace: count=4; defined_in=external/unknown; Purpose: invokes replace
- on: count=4; defined_in=external/unknown; Purpose: invokes on
- validateVisionModel: count=3; defined_in=external/unknown; Purpose: invokes validate vision model
- split: count=3; defined_in=external/unknown; Purpose: invokes split
- handleOpenAIErrors: count=3; defined_in=external/unknown; Purpose: invokes handle open aierrors
- toLowerCase: count=2; defined_in=external/unknown; Purpose: invokes to lower case
- checkVisionRequest: count=2; defined_in=external/unknown; Purpose: invokes check vision request
- getModelMaxTokens: count=2; defined_in=external/unknown; Purpose: invokes get model max tokens
- floor: count=2; defined_in=external/unknown; Purpose: invokes floor
- getEncoding: count=2; defined_in=external/unknown; Purpose: invokes get encoding
- getTokenCount: count=2; defined_in=external/unknown; Purpose: invokes get token count
- ceil: count=2; defined_in=external/unknown; Purpose: invokes ceil
- formatMessage: count=2; defined_in=external/unknown; Purpose: invokes format message
- findIndex: count=2; defined_in=external/unknown; Purpose: invokes find index
- unshift: count=2; defined_in=external/unknown; Purpose: invokes unshift
- getCompletion: count=2; defined_in=external/unknown; Purpose: invokes get completion
- chatCompletion: count=2; defined_in=external/unknown; Purpose: invokes chat completion
- truncateText: count=2; defined_in=external/unknown; Purpose: invokes truncate text
- mapModelToAzureConfig: count=2; defined_in=external/unknown; Purpose: invokes map model to azure config
- resolveHeaders: count=2; defined_in=external/unknown; Purpose: invokes resolve headers
- titleChatCompletion: count=2; defined_in=app/clients/AnthropicClient.js, app/clients/OpenAIClient.js; Purpose: invokes title chat completion
- initializeLLM: count=2; defined_in=external/unknown; Purpose: invokes initialize llm
- reduce: count=2; defined_in=external/unknown; Purpose: invokes reduce
- spendTokens: count=2; defined_in=external/unknown; Purpose: invokes spend tokens
- forEach: count=2; defined_in=external/unknown; Purpose: invokes for each
- handle: count=2; defined_in=external/unknown; Purpose: invokes handle
- catch: count=2; defined_in=external/unknown; Purpose: invokes catch
- warn: count=2; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- setOptions: count=1; defined_in=external/unknown; Purpose: invokes set options
- assign: count=1; defined_in=external/unknown; Purpose: invokes assign
- then: count=1; defined_in=external/unknown; Purpose: invokes then
- isEnabled: count=1; defined_in=utils/natsClient.js; Purpose: invokes is enabled
- getModelMaxOutputTokens: count=1; defined_in=external/unknown; Purpose: invokes get model max output tokens
- getResponseSender: count=1; defined_in=external/unknown; Purpose: invokes get response sender
- setupTokens: count=1; defined_in=external/unknown; Purpose: invokes setup tokens
- encodeAndFormat: count=1; defined_in=external/unknown; Purpose: invokes encode and format
- getMessagesForConversation: count=1; defined_in=external/unknown; Purpose: invokes get messages for conversation
- addImageURLs: count=1; defined_in=external/unknown; Purpose: invokes add image urls
- createContextHandlers: count=1; defined_in=external/unknown; Purpose: invokes create context handlers
- map: count=1; defined_in=external/unknown; Purpose: invokes map
- calculateImageTokenCost: count=1; defined_in=external/unknown; Purpose: invokes calculate image token cost
- createContext: count=1; defined_in=external/unknown; Purpose: invokes create context
- normalizeInstructionsPayload: count=1; defined_in=app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes normalize instructions payload
- handleContextStrategy: count=1; defined_in=external/unknown; Purpose: invokes handle context strategy
- findLastIndex: count=1; defined_in=external/unknown; Purpose: invokes find last index
- getReqData: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes get req data
- onProgress: count=1; defined_in=external/unknown; Purpose: invokes on progress
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- replaceAll: count=1; defined_in=external/unknown; Purpose: invokes replace all
- sendPayload: count=1; defined_in=external/unknown; Purpose: invokes send payload
- recordTokenUsage: count=1; defined_in=external/unknown; Purpose: invokes record token usage
- runTitleChain: count=1; defined_in=external/unknown; Purpose: invokes run title chain
- abs: count=1; defined_in=external/unknown; Purpose: invokes abs
- values: count=1; defined_in=external/unknown; Purpose: invokes values
- Number: count=1; defined_in=external/unknown; Purpose: invokes number
- isNaN: count=1; defined_in=external/unknown; Purpose: invokes is na n
- getMessagesWithinTokenLimit: count=1; defined_in=external/unknown; Purpose: invokes get messages within token limit
- tokenSplit: count=1; defined_in=external/unknown; Purpose: invokes token split
- summaryBuffer: count=1; defined_in=external/unknown; Purpose: invokes summary buffer
- getRunByConversationId: count=1; defined_in=external/unknown; Purpose: invokes get run by conversation id
- removeRun: count=1; defined_in=external/unknown; Purpose: invokes remove run
- match: count=1; defined_in=external/unknown; Purpose: invokes match
- parseTextParts: count=1; defined_in=external/unknown; Purpose: invokes parse text parts
- constructAzureURL: count=1; defined_in=external/unknown; Purpose: invokes construct azure url
- createFetch: count=1; defined_in=external/unknown; Purpose: invokes create fetch
- splice: count=1; defined_in=external/unknown; Purpose: invokes splice
- createStreamEventHandlers: count=1; defined_in=external/unknown; Purpose: invokes create stream event handlers
- stream: count=1; defined_in=external/unknown; Purpose: invokes stream
- push: count=1; defined_in=external/unknown; Purpose: invokes push
- addSpaceIfNeeded: count=1; defined_in=external/unknown; Purpose: invokes add space if needed
- abort: count=1; defined_in=external/unknown; Purpose: invokes abort
- sleep: count=1; defined_in=utils/async.js; Purpose: invokes sleep
- streamResolve: count=1; defined_in=external/unknown; Purpose: invokes stream resolve
- finalChatCompletion: count=1; defined_in=external/unknown; Purpose: invokes final chat completion
- create: count=1; defined_in=external/unknown; Purpose: invokes create
- removeEventListener: count=1; defined_in=external/unknown; Purpose: invokes remove event listener
- info: count=1; defined_in=external/unknown; Purpose: invokes info

## app/clients/utils/instructions.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: normalizeInstructionsPayload
Functions:
- computeTokens: status=используется | опасность, дублируется в: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; callers: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: triggered from app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js to compute tokens
- normalizeInstructionsPayload: status=используется | опасность, дублируется в: app/clients/utils/instructions.js, server/controllers/agents/client.js; callers: app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, server/controllers/agents/client.js; Purpose: triggered from app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, server/controllers/agents/client.js to normalize instructions payload
- resolveEncoding: status=используется | опасность, дублируется в: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; callers: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: triggered from app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js to resolve encoding
Logging status: ⚠️ частично (warn/info). Нужен scoped logger `clients.instructions` и единый формат warning'ов.
Outgoing Calls:
- warn: count=4; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- require: count=3; defined_in=external/unknown; Purpose: invokes require
- computeTokens: count=2; defined_in=app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes compute tokens
- info: count=2; defined_in=external/unknown; Purpose: invokes info
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- encodingResolver: count=1; defined_in=external/unknown; Purpose: invokes encoding resolver
- resolveEncoding: count=1; defined_in=app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes resolve encoding
- getTokenCount: count=1; defined_in=external/unknown; Purpose: invokes get token count
- trim: count=1; defined_in=external/unknown; Purpose: invokes trim

## db/connect.js
Purpose: Database connectors
Inbound Links: none detected
Exports: connectDb
Functions:
- buildMongoOptions: status=используется; callers: db/connect.js; Purpose: triggered from db/connect.js to build mongo options
- connectDb: status=сирота; callers: —; Purpose: local helper to connect db
Outgoing Calls:
- require: count=4; defined_in=external/unknown; Purpose: invokes require
- info: count=3; defined_in=external/unknown; Purpose: invokes info
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- buildMongoOptions: count=1; defined_in=db/connect.js; Purpose: invokes build mongo options
- set: count=1; defined_in=external/unknown; Purpose: invokes set
- then: count=1; defined_in=external/unknown; Purpose: invokes then
- connect: count=1; defined_in=external/unknown; Purpose: invokes connect
- path: count=1; defined_in=external/unknown; Purpose: invokes path
- add: count=1; defined_in=external/unknown; Purpose: invokes add
- syncIndexes: count=1; defined_in=external/unknown; Purpose: invokes sync indexes
- error: count=1; defined_in=external/unknown; Purpose: invokes error

## db/index.js
Purpose: Database connectors
Inbound Links: none detected
Exports: connectDb, indexSync
Functions: none detected
Outgoing Calls:
- require: count=4; defined_in=external/unknown; Purpose: invokes require
- createModels: count=1; defined_in=external/unknown; Purpose: invokes create models

## db/indexSync.js
Purpose: Database connectors
Inbound Links: none detected
Exports: None
Functions:
- deleteDocumentsWithoutUserField: status=используется; callers: db/indexSync.js; Purpose: triggered from db/indexSync.js to delete documents without user field
- ensureFilterableAttributes: status=используется; callers: db/indexSync.js; Purpose: triggered from db/indexSync.js to ensure filterable attributes
- indexSync: status=сирота; callers: —; Purpose: local helper to index sync
- performSync: status=используется; callers: db/indexSync.js; Purpose: triggered from db/indexSync.js to perform sync
Outgoing Calls:
- info: count=23; defined_in=external/unknown; Purpose: invokes info
- debug: count=9; defined_in=external/unknown; Purpose: invokes debug
- require: count=8; defined_in=external/unknown; Purpose: invokes require
- syncWithMeili: count=6; defined_in=external/unknown; Purpose: invokes sync with meili
- includes: count=5; defined_in=external/unknown; Purpose: invokes includes
- warn: count=5; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- error: count=4; defined_in=external/unknown; Purpose: invokes error
- index: count=4; defined_in=external/unknown; Purpose: invokes index
- search: count=3; defined_in=external/unknown; Purpose: invokes search
- Boolean: count=2; defined_in=external/unknown; Purpose: invokes boolean
- getSettings: count=2; defined_in=external/unknown; Purpose: invokes get settings
- updateSettings: count=2; defined_in=external/unknown; Purpose: invokes update settings
- deleteDocumentsWithoutUserField: count=2; defined_in=db/indexSync.js; Purpose: invokes delete documents without user field
- updateMany: count=2; defined_in=external/unknown; Purpose: invokes update many
- getSyncProgress: count=2; defined_in=external/unknown; Purpose: invokes get sync progress
- countDocuments: count=2; defined_in=external/unknown; Purpose: invokes count documents
- performSync: count=2; defined_in=db/indexSync.js; Purpose: invokes perform sync
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- map: count=1; defined_in=external/unknown; Purpose: invokes map
- filter: count=1; defined_in=external/unknown; Purpose: invokes filter
- deleteDocuments: count=1; defined_in=external/unknown; Purpose: invokes delete documents
- getInstance: count=1; defined_in=external/unknown; Purpose: invokes get instance
- health: count=1; defined_in=external/unknown; Purpose: invokes health
- ensureFilterableAttributes: count=1; defined_in=db/indexSync.js; Purpose: invokes ensure filterable attributes
- deleteFlow: count=1; defined_in=external/unknown; Purpose: invokes delete flow
- getLogStores: count=1; defined_in=external/unknown; Purpose: invokes get log stores
- createFlowWithHandler: count=1; defined_in=external/unknown; Purpose: invokes create flow with handler
- setTimeout: count=1; defined_in=external/unknown; Purpose: invokes set timeout
- on: count=1; defined_in=external/unknown; Purpose: invokes on
- clearTimeout: count=1; defined_in=external/unknown; Purpose: invokes clear timeout

## db/models.js
Purpose: Database models
Inbound Links: none detected
Exports: None
Functions: none detected
Outgoing Calls:
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- createModels: count=1; defined_in=external/unknown; Purpose: invokes create models

## manage_summaries.js
Purpose: General purpose module
Inbound Links: none detected
Exports: None
Functions:
- cleanAssistantText: status=используется | опасность, дублируется в: manage_summaries.js, server/controllers/agents/request.js; callers: manage_summaries.js, server/controllers/agents/request.js; Purpose: triggered from manage_summaries.js, server/controllers/agents/request.js to clean assistant text
- extractText: status=используется | опасность, дублируется в: manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js; callers: manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js; Purpose: triggered from manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js to extract text
- handleReset: status=используется; callers: manage_summaries.js; Purpose: triggered from manage_summaries.js to handle reset
- handleResummarize: status=используется; callers: manage_summaries.js; Purpose: triggered from manage_summaries.js to handle resummarize
- publishSummary: status=используется; callers: manage_summaries.js; Purpose: triggered from manage_summaries.js to publish summary
Outgoing Calls:
- log: count=19; defined_in=external/unknown; Purpose: invokes log
- require: count=5; defined_in=external/unknown; Purpose: invokes require
- error: count=4; defined_in=external/unknown; Purpose: invokes error
- trim: count=4; defined_in=external/unknown; Purpose: invokes trim
- getNumber: count=3; defined_in=server/controllers/agents/client.js; Purpose: invokes get number
- exit: count=2; defined_in=external/unknown; Purpose: invokes exit
- max: count=2; defined_in=external/unknown; Purpose: invokes max
- model: count=2; defined_in=external/unknown; Purpose: invokes model
- includes: count=2; defined_in=external/unknown; Purpose: invokes includes
- split: count=2; defined_in=external/unknown; Purpose: invokes split
- map: count=2; defined_in=external/unknown; Purpose: invokes map
- filter: count=2; defined_in=external/unknown; Purpose: invokes filter
- lean: count=2; defined_in=external/unknown; Purpose: invokes lean
- find: count=2; defined_in=external/unknown; Purpose: invokes find
- slice: count=2; defined_in=external/unknown; Purpose: invokes slice
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- pop: count=1; defined_in=external/unknown; Purpose: invokes pop
- isArray: count=1; defined_in=external/unknown; Purpose: invokes is array
- join: count=1; defined_in=external/unknown; Purpose: invokes join
- cleanAssistantText: count=1; defined_in=manage_summaries.js, server/controllers/agents/request.js; Purpose: invokes clean assistant text
- updateMany: count=1; defined_in=external/unknown; Purpose: invokes update many
- enqueueSummaryTask: count=1; defined_in=utils/temporalClient.js; Purpose: invokes enqueue summary task
- sort: count=1; defined_in=external/unknown; Purpose: invokes sort
- min: count=1; defined_in=external/unknown; Purpose: invokes min
- extractText: count=1; defined_in=manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js; Purpose: invokes extract text
- publishSummary: count=1; defined_in=manage_summaries.js; Purpose: invokes publish summary
- updateOne: count=1; defined_in=external/unknown; Purpose: invokes update one
- connect: count=1; defined_in=external/unknown; Purpose: invokes connect
- handleReset: count=1; defined_in=manage_summaries.js; Purpose: invokes handle reset
- handleResummarize: count=1; defined_in=manage_summaries.js; Purpose: invokes handle resummarize
- disconnect: count=1; defined_in=external/unknown; Purpose: invokes disconnect
- warn: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn

## models/Conversation.js
Purpose: Database models
Inbound Links: none detected
Exports: getConvoFiles, searchConversation, deleteNullOrEmptyConversations, saveConvo, bulkSaveConvos, getConvosByCursor, getConvosQueried, getConvo, getConvoTitle, deleteConvos
Functions:
- deleteNullOrEmptyConversations: status=сирота; callers: —; Purpose: local helper to delete null or empty conversations
- getConvo: status=используется; callers: app/clients/BaseClient.js, models/Conversation.js, server/controllers/agents/request.js, server/routes/convos.js; Purpose: triggered from app/clients/BaseClient.js, models/Conversation.js, server/controllers/agents/request.js, server/routes/convos.js to get convo
- getConvoFiles: status=сирота; callers: —; Purpose: local helper to get convo files
- searchConversation: status=сирота; callers: —; Purpose: local helper to search conversation
Outgoing Calls:
- error: count=12; defined_in=external/unknown; Purpose: invokes error
- push: count=6; defined_in=external/unknown; Purpose: invokes push
- lean: count=5; defined_in=external/unknown; Purpose: invokes lean
- require: count=4; defined_in=external/unknown; Purpose: invokes require
- map: count=4; defined_in=external/unknown; Purpose: invokes map
- findOne: count=3; defined_in=external/unknown; Purpose: invokes find one
- info: count=3; defined_in=external/unknown; Purpose: invokes info
- find: count=3; defined_in=external/unknown; Purpose: invokes find
- path: count=2; defined_in=external/unknown; Purpose: invokes path
- warn: count=2; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- deleteMany: count=2; defined_in=external/unknown; Purpose: invokes delete many
- deleteMessages: count=2; defined_in=models/Message.js; Purpose: invokes delete messages
- isArray: count=2; defined_in=external/unknown; Purpose: invokes is array
- sort: count=2; defined_in=external/unknown; Purpose: invokes sort
- select: count=2; defined_in=external/unknown; Purpose: invokes select
- pop: count=2; defined_in=external/unknown; Purpose: invokes pop
- toISOString: count=2; defined_in=external/unknown; Purpose: invokes to isostring
- add: count=1; defined_in=external/unknown; Purpose: invokes add
- catch: count=1; defined_in=external/unknown; Purpose: invokes catch
- syncIndexes: count=1; defined_in=external/unknown; Purpose: invokes sync indexes
- default: count=1; defined_in=external/unknown; Purpose: invokes default
- debug: count=1; defined_in=external/unknown; Purpose: invokes debug
- getMessages: count=1; defined_in=models/Message.js; Purpose: invokes get messages
- createTempChatExpirationDate: count=1; defined_in=external/unknown; Purpose: invokes create temp chat expiration date
- keys: count=1; defined_in=external/unknown; Purpose: invokes keys
- findOneAndUpdate: count=1; defined_in=external/unknown; Purpose: invokes find one and update
- toObject: count=1; defined_in=external/unknown; Purpose: invokes to object
- bulkWrite: count=1; defined_in=external/unknown; Purpose: invokes bulk write
- meiliSearch: count=1; defined_in=external/unknown; Purpose: invokes meili search
- limit: count=1; defined_in=external/unknown; Purpose: invokes limit
- filter: count=1; defined_in=external/unknown; Purpose: invokes filter
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- forEach: count=1; defined_in=external/unknown; Purpose: invokes for each
- getConvo: count=1; defined_in=models/Conversation.js; Purpose: invokes get convo

## models/MemoryBacklog.js
Purpose: Database models
Inbound Links: none detected
Exports: None
Functions: none detected
Outgoing Calls:
- require: count=1; defined_in=external/unknown; Purpose: invokes require
- index: count=1; defined_in=external/unknown; Purpose: invokes index
- model: count=1; defined_in=external/unknown; Purpose: invokes model

## models/Message.js
Purpose: Database models
Inbound Links: none detected
Exports: saveMessage, bulkSaveMessages, recordMessage, updateMessageText, updateMessage, deleteMessagesSince, getMessages, getMessage, deleteMessages, getBranchCountForConversation, getBranchCountsForConversations
Functions:
- bulkSaveMessages: status=сирота; callers: —; Purpose: local helper to bulk save messages
- deleteMessages: status=используется; callers: models/Conversation.js; Purpose: triggered from models/Conversation.js to delete messages
- deleteMessagesSince: status=сирота; callers: —; Purpose: local helper to delete messages since
- getBranchCountForConversation: status=сирота; callers: —; Purpose: local helper to get branch count for conversation
- getBranchCountsForConversations: status=используется; callers: models/Message.js, server/routes/convos.js; Purpose: triggered from models/Message.js, server/routes/convos.js to get branch counts for conversations
- getMessage: status=сирота; callers: —; Purpose: local helper to get message
- getMessages: status=используется; callers: app/clients/BaseClient.js, models/Conversation.js, server/controllers/agents/request.js, server/routes/convos.js; Purpose: triggered from app/clients/BaseClient.js, models/Conversation.js, server/controllers/agents/request.js, server/routes/convos.js to get messages
- recordMessage: status=сирота; callers: —; Purpose: local helper to record message
- saveMessage: status=используется; callers: app/clients/BaseClient.js, server/controllers/agents/request.js; Purpose: triggered from app/clients/BaseClient.js, server/controllers/agents/request.js to save message
- updateMessage: status=используется; callers: app/clients/BaseClient.js, server/controllers/agents/request.js; Purpose: triggered from app/clients/BaseClient.js, server/controllers/agents/request.js to update message
- updateMessageText: status=сирота; callers: —; Purpose: local helper to update message text
Outgoing Calls:
- error: count=12; defined_in=external/unknown; Purpose: invokes error
- require: count=6; defined_in=external/unknown; Purpose: invokes require
- info: count=6; defined_in=external/unknown; Purpose: invokes info
- warn: count=4; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- lean: count=4; defined_in=external/unknown; Purpose: invokes lean
- findOneAndUpdate: count=3; defined_in=external/unknown; Purpose: invokes find one and update
- findOne: count=3; defined_in=external/unknown; Purpose: invokes find one
- find: count=3; defined_in=external/unknown; Purpose: invokes find
- stringify: count=2; defined_in=external/unknown; Purpose: invokes stringify
- toObject: count=2; defined_in=external/unknown; Purpose: invokes to object
- deleteMany: count=2; defined_in=external/unknown; Purpose: invokes delete many
- sort: count=2; defined_in=external/unknown; Purpose: invokes sort
- debug: count=2; defined_in=external/unknown; Purpose: invokes debug
- getBoolean: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes get boolean
- uuid: count=1; defined_in=external/unknown; Purpose: invokes uuid
- string: count=1; defined_in=external/unknown; Purpose: invokes string
- safeParse: count=1; defined_in=external/unknown; Purpose: invokes safe parse
- createTempChatExpirationDate: count=1; defined_in=external/unknown; Purpose: invokes create temp chat expiration date
- isNaN: count=1; defined_in=external/unknown; Purpose: invokes is na n
- includes: count=1; defined_in=external/unknown; Purpose: invokes includes
- map: count=1; defined_in=external/unknown; Purpose: invokes map
- bulkWrite: count=1; defined_in=external/unknown; Purpose: invokes bulk write
- updateOne: count=1; defined_in=external/unknown; Purpose: invokes update one
- select: count=1; defined_in=external/unknown; Purpose: invokes select
- isArray: count=1; defined_in=external/unknown; Purpose: invokes is array
- aggregate: count=1; defined_in=external/unknown; Purpose: invokes aggregate
- getBranchCountsForConversations: count=1; defined_in=models/Message.js; Purpose: invokes get branch counts for conversations

## server/controllers/agents/client.js
Purpose: Agent orchestration helpers
Inbound Links: none detected
Exports: None
Functions:
- calculateAdaptiveTimeout: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to calculate adaptive timeout
- compressMessagesForRetry: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to compress messages for retry
- computeImportanceScore: status=сирота; callers: —; Purpose: local helper to compute importance score
- computeTokens: status=используется | опасность, дублируется в: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; callers: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: triggered from app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js to compute tokens
- condenseRagQuery: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js to condense rag query
- countTokens: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/services/tokens/TokenCounter.js, server/utils/tokenBreakdown.js; callers: server/utils/tokenBreakdown.js; Purpose: triggered from server/utils/tokenBreakdown.js to count tokens
- createCacheKey: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/tokens/TokenCounter.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/tokens/TokenCounter.js to create cache key
- createSafeLogger: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to create safe logger
- createTokenCounter: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to create token counter
- detectContextOverflow: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to detect context overflow
- extractMessageText: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: server/services/agents/MessageHistoryManager.js; Purpose: triggered from server/services/agents/MessageHistoryManager.js to extract message text
- fetchGraphContext: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/multiStepOrchestrator.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/multiStepOrchestrator.js to fetch graph context
- fetchGraphLinesForEntity: status=сирота; callers: —; Purpose: local helper to fetch graph lines for entity
- getBoolean: status=используется; callers: models/Message.js, server/controllers/agents/client.js, server/routes/convos.js; Purpose: triggered from models/Message.js, server/controllers/agents/client.js, server/routes/convos.js to get boolean
- getNumber: status=используется; callers: manage_summaries.js, server/controllers/agents/client.js, server/controllers/agents/request.js, server/services/Graph/LongTextWorker.js, server/services/RAG/memoryQueue.js, sync_history.js; Purpose: triggered from manage_summaries.js, server/controllers/agents/client.js, server/controllers/agents/request.js, server/services/Graph/LongTextWorker.js, server/services/RAG/memoryQueue.js, sync_history.js to get number
- getString: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to get string
- hashPayload: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/agents/MessageHistoryManager.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/agents/MessageHistoryManager.js to hash payload
- isGoogleModel: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to is google model
- logToolError: status=сирота; callers: —; Purpose: local helper to log tool error
- makeIngestKey: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: server/controllers/agents/client.js, server/services/agents/MessageHistoryManager.js; Purpose: triggered from server/controllers/agents/client.js, server/services/agents/MessageHistoryManager.js to make ingest key
- mapReduceContext: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js to map reduce context
- markMessagesAsStored: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/controllers/agents/request.js; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to mark messages as stored
- noop: status=сирота; callers: —; Purpose: local helper to noop
- normalizeInstructionsPayload: status=используется | опасность, дублируется в: app/clients/utils/instructions.js, server/controllers/agents/client.js; callers: app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, server/controllers/agents/client.js; Purpose: triggered from app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, server/controllers/agents/client.js to normalize instructions payload
- normalizeMemoryText: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: server/services/agents/MessageHistoryManager.js; Purpose: triggered from server/services/agents/MessageHistoryManager.js to normalize memory text
- onClientAbort: status=сирота; callers: —; Purpose: local helper to on client abort
- parseUsdRate: status=используется; callers: server/controllers/agents/client.js, server/services/pricing/PricingCalculator.js; Purpose: triggered from server/controllers/agents/client.js, server/services/pricing/PricingCalculator.js to parse usd rate
- payloadParser: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to payload parser
- pruneExpiredRagCache: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to prune expired rag cache
- resolveEncoding: status=используется | опасность, дублируется в: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; callers: app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: triggered from app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js to resolve encoding
- resolvePricingRates: status=используется; callers: server/controllers/agents/client.js, server/services/pricing/PricingCalculator.js; Purpose: triggered from server/controllers/agents/client.js, server/services/pricing/PricingCalculator.js to resolve pricing rates
- runAgent: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to run agent
- safe: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to safe
- sanitizeGraphContext: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js to sanitize graph context
- sanitizeVectorChunks: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js to sanitize vector chunks
- summarizeMsg: status=сирота; callers: —; Purpose: local helper to summarize msg
- tokenize: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to tokenize
- warn: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: app/clients/AnthropicClient.js, app/clients/BaseClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, app/clients/utils/instructions.js, db/indexSync.js, manage_summaries.js, models/Conversation.js, models/Message.js, server/controllers/agents/client.js, server/controllers/agents/request.js, server/middleware/requestValidators.js, server/routes/convos.js, server/services/Config/ConfigService.js, server/services/Deduplication/clearDedupeKey.js, server/services/Deduplication/ingestDeduplicator.js, server/services/Endpoints/agents/title.js, server/services/Endpoints/google/title.js, server/services/Graph/LongTextWorker.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/condense.js, server/services/RAG/intentAnalyzer.js, server/services/RAG/memoryQueue.js, server/services/RAG/multiStepOrchestrator.js, server/services/agents/MessageHistoryManager.js, server/services/agents/RetryStrategy.js, server/services/agents/historyTrimmer.js, server/services/tokens/TokenCounter.js, server/utils/messageUtils.js, utils/metrics.js, utils/natsClient.js, utils/temporalClient.js; Purpose: triggered from app/clients/AnthropicClient.js, app/clients/BaseClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, app/clients/utils/instructions.js, db/indexSync.js, manage_summaries.js, models/Conversation.js, models/Message.js, server/controllers/agents/client.js, server/controllers/agents/request.js, server/middleware/requestValidators.js, server/routes/convos.js, server/services/Config/ConfigService.js, server/services/Deduplication/clearDedupeKey.js, server/services/Deduplication/ingestDeduplicator.js, server/services/Endpoints/agents/title.js, server/services/Endpoints/google/title.js, server/services/Graph/LongTextWorker.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/condense.js, server/services/RAG/intentAnalyzer.js, server/services/RAG/memoryQueue.js, server/services/RAG/multiStepOrchestrator.js, server/services/agents/MessageHistoryManager.js, server/services/agents/RetryStrategy.js, server/services/agents/historyTrimmer.js, server/services/tokens/TokenCounter.js, server/utils/messageUtils.js, utils/metrics.js, utils/natsClient.js, utils/temporalClient.js to warn
- withTimeout: status=используется | опасность, дублируется в: server/controllers/agents/client.js, utils/async.js; callers: app/clients/BaseClient.js, server/controllers/agents/client.js, server/services/RAG/intentAnalyzer.js, server/services/RAG/multiStepOrchestrator.js, server/utils/resilience.js; Purpose: triggered from app/clients/BaseClient.js, server/controllers/agents/client.js, server/services/RAG/intentAnalyzer.js, server/services/RAG/multiStepOrchestrator.js, server/utils/resilience.js to with timeout
Logging status: ⚠️ есть `createSafeLogger`, но общая система не унифицирована; требуется миграция на новый модуль + requestId context.
Outgoing Calls:
- debug: count=41; defined_in=external/unknown; Purpose: invokes debug
- require: count=35; defined_in=external/unknown; Purpose: invokes require
- Number: count=34; defined_in=external/unknown; Purpose: invokes number
- slice: count=29; defined_in=external/unknown; Purpose: invokes slice
- error: count=25; defined_in=external/unknown; Purpose: invokes error
- map: count=18; defined_in=external/unknown; Purpose: invokes map
- isArray: count=17; defined_in=external/unknown; Purpose: invokes is array
- trim: count=17; defined_in=external/unknown; Purpose: invokes trim
- filter: count=16; defined_in=external/unknown; Purpose: invokes filter
- warn: count=16; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- info: count=16; defined_in=external/unknown; Purpose: invokes info
- join: count=15; defined_in=external/unknown; Purpose: invokes join
- getNumber: count=15; defined_in=server/controllers/agents/client.js; Purpose: invokes get number
- add: count=13; defined_in=external/unknown; Purpose: invokes add
- isFinite: count=11; defined_in=external/unknown; Purpose: invokes is finite
- parseUsdRate: count=10; defined_in=server/controllers/agents/client.js; Purpose: invokes parse usd rate
- get: count=8; defined_in=external/unknown; Purpose: invokes get
- stringify: count=7; defined_in=external/unknown; Purpose: invokes stringify
- String: count=6; defined_in=external/unknown; Purpose: invokes string
- Boolean: count=5; defined_in=external/unknown; Purpose: invokes boolean
- getBoolean: count=5; defined_in=server/controllers/agents/client.js; Purpose: invokes get boolean
- post: count=4; defined_in=external/unknown; Purpose: invokes post
- min: count=4; defined_in=external/unknown; Purpose: invokes min
- getSection: count=4; defined_in=external/unknown; Purpose: invokes get section
- getMemoryConfig: count=3; defined_in=utils/memoryConfig.js; Purpose: invokes get memory config
- hashPayload: count=3; defined_in=server/controllers/agents/client.js; Purpose: invokes hash payload
- toLowerCase: count=3; defined_in=external/unknown; Purpose: invokes to lower case
- now: count=2; defined_in=external/unknown; Purpose: invokes now
- entries: count=2; defined_in=external/unknown; Purpose: invokes entries
- digest: count=2; defined_in=external/unknown; Purpose: invokes digest
- update: count=2; defined_in=external/unknown; Purpose: invokes update
- createHash: count=2; defined_in=external/unknown; Purpose: invokes create hash
- calculateAdaptiveTimeout: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes calculate adaptive timeout
- delete: count=1; defined_in=external/unknown; Purpose: invokes delete
- toString: count=function toString() { [native code] }1; defined_in=external/unknown; Purpose: invokes to string
- push: count=11; defined_in=external/unknown; Purpose: invokes push
- getEncoding: count=10; defined_in=external/unknown; Purpose: invokes get encoding
- safeWarn: count=8; defined_in=external/unknown; Purpose: invokes safe warn
- getTokenCount: count=8; defined_in=external/unknown; Purpose: invokes get token count
- _getType: count=7; defined_in=external/unknown; Purpose: invokes get type
- max: count=6; defined_in=external/unknown; Purpose: invokes max
- includes: count=6; defined_in=external/unknown; Purpose: invokes includes
- assign: count=6; defined_in=external/unknown; Purpose: invokes assign
- replace: count=5; defined_in=external/unknown; Purpose: invokes replace
- floor: count=5; defined_in=external/unknown; Purpose: invokes floor
- setTimeout: count=4; defined_in=external/unknown; Purpose: invokes set timeout
- bind: count=3; defined_in=external/unknown; Purpose: invokes bind
- has: count=3; defined_in=external/unknown; Purpose: invokes has
- getTokenCountForMessage: count=3; defined_in=external/unknown; Purpose: invokes get token count for message
- find: count=3; defined_in=external/unknown; Purpose: invokes find
- some: count=3; defined_in=external/unknown; Purpose: invokes some
- trace: count=3; defined_in=external/unknown; Purpose: invokes trace
- spendTokens: count=3; defined_in=external/unknown; Purpose: invokes spend tokens
- race: count=2; defined_in=external/unknown; Purpose: invokes race
- reject: count=2; defined_in=external/unknown; Purpose: invokes reject
- computeTokens: count=2; defined_in=app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes compute tokens
- safeInfo: count=2; defined_in=external/unknown; Purpose: invokes safe info
- test: count=2; defined_in=external/unknown; Purpose: invokes test
- isAgentsEndpoint: count=2; defined_in=external/unknown; Purpose: invokes is agents endpoint
- parse: count=2; defined_in=external/unknown; Purpose: invokes parse
- withTimeout: count=2; defined_in=server/controllers/agents/client.js, utils/async.js; Purpose: invokes with timeout
- enqueueMemoryTasks: count=2; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes enqueue memory tasks
- observeCache: count=2; defined_in=utils/ragMetrics.js; Purpose: invokes observe cache
- fetchGraphContext: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes fetch graph context
- endsWith: count=2; defined_in=external/unknown; Purpose: invokes ends with
- sanitizeVectorChunks: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes sanitize vector chunks
- observeSegmentTokens: count=2; defined_in=utils/ragMetrics.js; Purpose: invokes observe segment tokens
- setContextLength: count=2; defined_in=utils/ragMetrics.js; Purpose: invokes set context length
- setImmediate: count=2; defined_in=external/unknown; Purpose: invokes set immediate
- normalizeInstructionsPayload: count=2; defined_in=app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes normalize instructions payload
- getBufferString: count=2; defined_in=external/unknown; Purpose: invokes get buffer string
- catch: count=2; defined_in=external/unknown; Purpose: invokes catch
- values: count=2; defined_in=external/unknown; Purpose: invokes values
- once: count=2; defined_in=external/unknown; Purpose: invokes once
- createTokenCounter: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes create token counter
- runAgent: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes run agent
- detectContextOverflow: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes detect context overflow
- tokenCounter: count=2; defined_in=external/unknown; Purpose: invokes token counter
- awaitMemoryWithTimeout: count=2; defined_in=external/unknown; Purpose: invokes await memory with timeout
- from: count=1; defined_in=external/unknown; Purpose: invokes from
- toJSON: count=1; defined_in=external/unknown; Purpose: invokes to json
- ceil: count=1; defined_in=external/unknown; Purpose: invokes ceil
- getCondenseProvidersPreview: count=1; defined_in=server/services/RAG/condense.js; Purpose: invokes get condense providers preview
- ragCondenseContext: count=1; defined_in=external/unknown; Purpose: invokes rag condense context
- getString: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes get string
- createSafeLogger: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes create safe logger
- finally: count=1; defined_in=external/unknown; Purpose: invokes finally
- clearTimeout: count=1; defined_in=external/unknown; Purpose: invokes clear timeout
- resolveEncoding: count=1; defined_in=app/clients/BaseClient.js, app/clients/utils/instructions.js, server/controllers/agents/client.js; Purpose: invokes resolve encoding
- normalize: count=1; defined_in=external/unknown; Purpose: invokes normalize
- split: count=1; defined_in=external/unknown; Purpose: invokes split
- logAxiosError: count=1; defined_in=external/unknown; Purpose: invokes log axios error
- updateMany: count=1; defined_in=external/unknown; Purpose: invokes update many
- safe: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes safe
- payloadParser: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes payload parser
- removeNullishValues: count=1; defined_in=external/unknown; Purpose: invokes remove nullish values
- encodeAndFormat: count=1; defined_in=external/unknown; Purpose: invokes encode and format
- startsWith: count=1; defined_in=external/unknown; Purpose: invokes starts with
- makeIngestKey: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes make ingest key
- safeError: count=1; defined_in=external/unknown; Purpose: invokes safe error
- pruneExpiredRagCache: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes prune expired rag cache
- createCacheKey: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes create cache key
- sanitizeGraphContext: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes sanitize graph context
- condenseRagQuery: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes condense rag query
- mapReduceContext: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes map reduce context
- sanitizeInput: count=1; defined_in=utils/security.js; Purpose: invokes sanitize input
- set: count=1; defined_in=external/unknown; Purpose: invokes set
- getMessagesForConversation: count=1; defined_in=external/unknown; Purpose: invokes get messages for conversation
- processDroppedMessages: count=1; defined_in=external/unknown; Purpose: invokes process dropped messages
- tokenize: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes tokenize
- processMessageHistory: count=1; defined_in=external/unknown; Purpose: invokes process message history
- analyzeIntent: count=1; defined_in=server/services/RAG/intentAnalyzer.js; Purpose: invokes analyze intent
- buildRagContext: count=1; defined_in=external/unknown; Purpose: invokes build rag context
- runMultiStepRag: count=1; defined_in=server/services/RAG/multiStepOrchestrator.js; Purpose: invokes run multi step rag
- addImageURLs: count=1; defined_in=external/unknown; Purpose: invokes add image urls
- createContextHandlers: count=1; defined_in=external/unknown; Purpose: invokes create context handlers
- formatMessage: count=1; defined_in=external/unknown; Purpose: invokes format message
- unshift: count=1; defined_in=external/unknown; Purpose: invokes unshift
- createContext: count=1; defined_in=external/unknown; Purpose: invokes create context
- handleContextStrategy: count=1; defined_in=external/unknown; Purpose: invokes handle context strategy
- getReqData: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes get req data
- useMemory: count=1; defined_in=external/unknown; Purpose: invokes use memory
- checkAccess: count=1; defined_in=external/unknown; Purpose: invokes check access
- loadAgent: count=1; defined_in=external/unknown; Purpose: invokes load agent
- initializeAgent: count=1; defined_in=external/unknown; Purpose: invokes initialize agent
- createMemoryProcessor: count=1; defined_in=external/unknown; Purpose: invokes create memory processor
- removeImageContentFromMessage: count=1; defined_in=external/unknown; Purpose: invokes remove image content from message
- processMemory: count=1; defined_in=external/unknown; Purpose: invokes process memory
- chatCompletion: count=1; defined_in=external/unknown; Purpose: invokes chat completion
- spendStructuredTokens: count=1; defined_in=external/unknown; Purpose: invokes spend structured tokens
- resolvePricingRates: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes resolve pricing rates
- round: count=1; defined_in=external/unknown; Purpose: invokes round
- observeCost: count=1; defined_in=utils/ragMetrics.js; Purpose: invokes observe cost
- toFixed: count=1; defined_in=external/unknown; Purpose: invokes to fixed
- writeTokenReport: count=1; defined_in=utils/tokenReport.js; Purpose: invokes write token report
- reduce: count=1; defined_in=external/unknown; Purpose: invokes reduce
- isNaN: count=1; defined_in=external/unknown; Purpose: invokes is na n
- abort: count=1; defined_in=external/unknown; Purpose: invokes abort
- formatAgentMessages: count=1; defined_in=external/unknown; Purpose: invokes format agent messages
- sort: count=1; defined_in=external/unknown; Purpose: invokes sort
- match: count=1; defined_in=external/unknown; Purpose: invokes match
- formatContentStrings: count=1; defined_in=external/unknown; Purpose: invokes format content strings
- addCacheControl: count=1; defined_in=external/unknown; Purpose: invokes add cache control
- enrichContextWithMemoryAgent: count=1; defined_in=external/unknown; Purpose: invokes enrich context with memory agent
- resolveHeaders: count=1; defined_in=external/unknown; Purpose: invokes resolve headers
- createRun: count=1; defined_in=external/unknown; Purpose: invokes create run
- aggregateContent: count=1; defined_in=external/unknown; Purpose: invokes aggregate content
- sendEvent: count=1; defined_in=external/unknown; Purpose: invokes send event
- processStream: count=1; defined_in=external/unknown; Purpose: invokes process stream
- compressMessagesForRetry: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes compress messages for retry
- checkCapability: count=1; defined_in=external/unknown; Purpose: invokes check capability
- pop: count=1; defined_in=external/unknown; Purpose: invokes pop
- canWrite: count=1; defined_in=server/utils/responseUtils.js; Purpose: invokes can write
- write: count=1; defined_in=external/unknown; Purpose: invokes write
- sseDebug: count=1; defined_in=external/unknown; Purpose: invokes sse debug
- getRunMessages: count=1; defined_in=external/unknown; Purpose: invokes get run messages
- concat: count=1; defined_in=external/unknown; Purpose: invokes concat
- isGoogleModel: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes is google model
- getBalanceConfig: count=1; defined_in=external/unknown; Purpose: invokes get balance config
- getTransactionsConfig: count=1; defined_in=external/unknown; Purpose: invokes get transactions config
- getStreamUsage: count=1; defined_in=external/unknown; Purpose: invokes get stream usage
- recordCollectedUsage: count=1; defined_in=external/unknown; Purpose: invokes record collected usage
- computePromptTokenBreakdown: count=1; defined_in=server/utils/tokenBreakdown.js; Purpose: invokes compute prompt token breakdown
- logPromptTokenBreakdown: count=1; defined_in=server/utils/tokenBreakdown.js; Purpose: invokes log prompt token breakdown

## server/controllers/agents/request.js
Purpose: Agent orchestration helpers
Inbound Links: none detected
Exports: None
Functions:
- AgentController: status=используется; callers: server/routes/agents/chat.js; Purpose: triggered from server/routes/agents/chat.js to agent controller
- acquireSummarizationLock: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to acquire summarization lock
- buildSummarizationPayload: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to build summarization payload
- cleanAssistantText: status=используется | опасность, дублируется в: manage_summaries.js, server/controllers/agents/request.js; callers: manage_summaries.js, server/controllers/agents/request.js; Purpose: triggered from manage_summaries.js, server/controllers/agents/request.js to clean assistant text
- clearDedupeKeyWithLogging: status=сирота; callers: —; Purpose: local helper to clear dedupe key with logging
- disableGoogleStreaming: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to disable google streaming
- enqueueGraphTaskWithResilience: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to enqueue graph task with resilience
- enqueueMemoryTasksSafe: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to enqueue memory tasks safe
- enqueueMemoryTasksWithResilience: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to enqueue memory tasks with resilience
- enqueueSummaryTaskWithResilience: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to enqueue summary task with resilience
- extractDedupeKeys: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to extract dedupe keys
- extractText: status=используется | опасность, дублируется в: manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js; callers: manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js; Purpose: triggered from manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js to extract text
- getOperationConfig: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to get operation config
- getReqData: status=используется; callers: app/clients/BaseClient.js, app/clients/OpenAIClient.js, server/controllers/agents/client.js; Purpose: triggered from app/clients/BaseClient.js, app/clients/OpenAIClient.js, server/controllers/agents/client.js to get req data
- getResilienceConfig: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to get resilience config
- initializeClientWithResilience: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to initialize client with resilience
- isGoogleEndpoint: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to is google endpoint
- makeDedupeKey: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to make dedupe key
- markMessagesAsStored: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/controllers/agents/request.js; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to mark messages as stored
- onClose: status=сирота; callers: —; Purpose: local helper to on close
- performCleanup: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to perform cleanup
- prelimCloseHandler: status=сирота; callers: —; Purpose: local helper to prelim close handler
- processConversationArtifacts: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to process conversation artifacts
- releaseSummarizationLock: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to release summarization lock
- resolveSendMessageLabels: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to resolve send message labels
- saveConvoWithResilience: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to save convo with resilience
- sendMessageWithResilience: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to send message with resilience
- shouldGenerateTitle: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to should generate title
- splitSummarizationJobs: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to split summarization jobs
- triggerSummarization: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to trigger summarization
- trimSummarizationPayload: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to trim summarization payload
Logging status: ⚠️ множественные `debug/info/warn`; необходимо перейти на scoped logger `agents.request` с фазами пайплайна.
Outgoing Calls:
- error: count=23; defined_in=external/unknown; Purpose: invokes error
- require: count=17; defined_in=external/unknown; Purpose: invokes require
- now: count=16; defined_in=external/unknown; Purpose: invokes now
- debug: count=12; defined_in=external/unknown; Purpose: invokes debug
- push: count=10; defined_in=external/unknown; Purpose: invokes push
- info: count=9; defined_in=external/unknown; Purpose: invokes info
- includes: count=8; defined_in=external/unknown; Purpose: invokes includes
- toISOString: count=7; defined_in=external/unknown; Purpose: invokes to isostring
- getSection: count=6; defined_in=external/unknown; Purpose: invokes get section
- getOperationConfig: count=6; defined_in=server/controllers/agents/request.js; Purpose: invokes get operation config
- normalizeLabelValue: count=6; defined_in=server/utils/resilience.js; Purpose: invokes normalize label value
- getResilienceConfig: count=6; defined_in=server/controllers/agents/request.js; Purpose: invokes get resilience config
- runWithResilience: count=6; defined_in=server/utils/resilience.js; Purpose: invokes run with resilience
- trim: count=6; defined_in=external/unknown; Purpose: invokes trim
- saveMessage: count=6; defined_in=models/Message.js; Purpose: invokes save message
- once: count=6; defined_in=external/unknown; Purpose: invokes once
- slice: count=6; defined_in=external/unknown; Purpose: invokes slice
- isArray: count=5; defined_in=external/unknown; Purpose: invokes is array
- warn: count=5; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- map: count=5; defined_in=external/unknown; Purpose: invokes map
- setImmediate: count=5; defined_in=external/unknown; Purpose: invokes set immediate
- sendEvent: count=5; defined_in=external/unknown; Purpose: invokes send event
- byteLength: count=5; defined_in=external/unknown; Purpose: invokes byte length
- stringify: count=5; defined_in=external/unknown; Purpose: invokes stringify
- setTemporalStatus: count=4; defined_in=utils/metrics.js; Purpose: invokes set temporal status
- delete: count=4; defined_in=external/unknown; Purpose: invokes delete
- set: count=4; defined_in=external/unknown; Purpose: invokes set
- end: count=4; defined_in=external/unknown; Purpose: invokes end
- incLongTextTask: count=4; defined_in=utils/metrics.js; Purpose: invokes inc long text task
- removeListener: count=4; defined_in=external/unknown; Purpose: invokes remove listener
- clearDedupeKey: count=3; defined_in=server/services/Deduplication/clearDedupeKey.js; Purpose: invokes clear dedupe key
- enqueueMemoryTasksSafe: count=3; defined_in=server/controllers/agents/request.js; Purpose: invokes enqueue memory tasks safe
- filter: count=3; defined_in=external/unknown; Purpose: invokes filter
- catch: count=3; defined_in=external/unknown; Purpose: invokes catch
- triggerSummarization: count=3; defined_in=server/controllers/agents/request.js; Purpose: invokes trigger summarization
- isGoogleEndpoint: count=3; defined_in=server/controllers/agents/request.js; Purpose: invokes is google endpoint
- initializeClientWithResilience: count=3; defined_in=server/controllers/agents/request.js; Purpose: invokes initialize client with resilience
- register: count=3; defined_in=external/unknown; Purpose: invokes register
- resolveSendMessageLabels: count=3; defined_in=server/controllers/agents/request.js; Purpose: invokes resolve send message labels
- sendMessageWithResilience: count=3; defined_in=server/controllers/agents/request.js; Purpose: invokes send message with resilience
- Boolean: count=2; defined_in=external/unknown; Purpose: invokes boolean
- observeMemoryQueueLatency: count=2; defined_in=utils/metrics.js; Purpose: invokes observe memory queue latency
- observeSummaryEnqueue: count=2; defined_in=utils/metrics.js; Purpose: invokes observe summary enqueue
- observeGraphEnqueue: count=2; defined_in=utils/metrics.js; Purpose: invokes observe graph enqueue
- max: count=2; defined_in=external/unknown; Purpose: invokes max
- get: count=2; defined_in=external/unknown; Purpose: invokes get
- clearTimeout: count=2; defined_in=external/unknown; Purpose: invokes clear timeout
- getConvo: count=2; defined_in=models/Conversation.js; Purpose: invokes get convo
- getMessages: count=2; defined_in=models/Message.js; Purpose: invokes get messages
- makeDedupeKey: count=2; defined_in=server/controllers/agents/request.js; Purpose: invokes make dedupe key
- markAsIngested: count=2; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes mark as ingested
- add: count=2; defined_in=external/unknown; Purpose: invokes add
- join: count=2; defined_in=external/unknown; Purpose: invokes join
- abort: count=2; defined_in=external/unknown; Purpose: invokes abort
- deref: count=2; defined_in=external/unknown; Purpose: invokes deref
- createAbortController: count=2; defined_in=external/unknown; Purpose: invokes create abort controller
- isResponseFinalized: count=2; defined_in=server/utils/responseUtils.js; Purpose: invokes is response finalized
- canWrite: count=2; defined_in=server/utils/responseUtils.js; Purpose: invokes can write
- processConversationArtifacts: count=2; defined_in=server/controllers/agents/request.js; Purpose: invokes process conversation artifacts
- shouldGenerateTitle: count=2; defined_in=server/controllers/agents/request.js; Purpose: invokes should generate title
- addTitle: count=2; defined_in=server/services/Endpoints/agents/title.js, server/services/Endpoints/google/title.js; Purpose: invokes add title
- split: count=2; defined_in=external/unknown; Purpose: invokes split
- trimSummarizationPayload: count=2; defined_in=server/controllers/agents/request.js; Purpose: invokes trim summarization payload
- start: count=1; defined_in=external/unknown; Purpose: invokes start
- getNumber: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes get number
- freeze: count=1; defined_in=external/unknown; Purpose: invokes freeze
- enqueueMemoryTasks: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes enqueue memory tasks
- incMemoryQueueFailure: count=1; defined_in=utils/metrics.js; Purpose: invokes inc memory queue failure
- enqueueSummaryTask: count=1; defined_in=utils/temporalClient.js; Purpose: invokes enqueue summary task
- incSummaryEnqueueTotal: count=1; defined_in=utils/metrics.js; Purpose: invokes inc summary enqueue total
- incSummaryEnqueueFailure: count=1; defined_in=utils/metrics.js; Purpose: invokes inc summary enqueue failure
- enqueueGraphTask: count=1; defined_in=utils/temporalClient.js; Purpose: invokes enqueue graph task
- incGraphEnqueueTotal: count=1; defined_in=utils/metrics.js; Purpose: invokes inc graph enqueue total
- incGraphEnqueueFailure: count=1; defined_in=utils/metrics.js; Purpose: invokes inc graph enqueue failure
- saveConvo: count=1; defined_in=external/unknown; Purpose: invokes save convo
- setTimeout: count=1; defined_in=external/unknown; Purpose: invokes set timeout
- test: count=1; defined_in=external/unknown; Purpose: invokes test
- updateMessage: count=1; defined_in=models/Message.js; Purpose: invokes update message
- extractDedupeKeys: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes extract dedupe keys
- enqueueMemoryTasksWithResilience: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes enqueue memory tasks with resilience
- initializeClient: count=1; defined_in=external/unknown; Purpose: invokes initialize client
- sendMessage: count=1; defined_in=external/unknown; Purpose: invokes send message
- observeSendMessage: count=1; defined_in=utils/metrics.js; Purpose: invokes observe send message
- incSendMessageFailure: count=1; defined_in=utils/metrics.js; Purpose: invokes inc send message failure
- encodeAndFormat: count=1; defined_in=external/unknown; Purpose: invokes encode and format
- startsWith: count=1; defined_in=external/unknown; Purpose: invokes starts with
- markMessagesAsStored: count=1; defined_in=server/controllers/agents/client.js, server/controllers/agents/request.js; Purpose: invokes mark messages as stored
- enqueueGraphTaskWithResilience: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes enqueue graph task with resilience
- handler: count=1; defined_in=external/unknown; Purpose: invokes handler
- from: count=1; defined_in=external/unknown; Purpose: invokes from
- clear: count=1; defined_in=external/unknown; Purpose: invokes clear
- disposeClient: count=1; defined_in=external/unknown; Purpose: invokes dispose client
- toFixed: count=1; defined_in=external/unknown; Purpose: invokes to fixed
- enqueue: count=1; defined_in=external/unknown; Purpose: invokes enqueue
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- disableGoogleStreaming: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes disable google streaming
- getConvoTitle: count=1; defined_in=external/unknown; Purpose: invokes get convo title
- has: count=1; defined_in=external/unknown; Purpose: invokes has
- makeDetachableRes: count=1; defined_in=server/utils/responseUtils.js; Purpose: invokes make detachable res
- setDetached: count=1; defined_in=external/unknown; Purpose: invokes set detached
- handleAbortError: count=1; defined_in=external/unknown; Purpose: invokes handle abort error
- performCleanup: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes perform cleanup
- acquireSummarizationLock: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes acquire summarization lock
- pop: count=1; defined_in=external/unknown; Purpose: invokes pop
- cleanAssistantText: count=1; defined_in=manage_summaries.js, server/controllers/agents/request.js; Purpose: invokes clean assistant text
- extractText: count=1; defined_in=manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js; Purpose: invokes extract text
- splitSummarizationJobs: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes split summarization jobs
- enqueueSummaryTaskWithResilience: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes enqueue summary task with resilience
- saveConvoWithResilience: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes save convo with resilience
- releaseSummarizationLock: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes release summarization lock
- min: count=1; defined_in=external/unknown; Purpose: invokes min
- buildSummarizationPayload: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes build summarization payload

## server/middleware/requestValidators.js
Purpose: General purpose module
Inbound Links: none detected
Exports: validateAgentRequest
Functions:
- appendIssue: status=используется; callers: server/middleware/requestValidators.js; Purpose: triggered from server/middleware/requestValidators.js to append issue
- getFileSize: status=используется; callers: server/middleware/requestValidators.js; Purpose: triggered from server/middleware/requestValidators.js to get file size
- getNumericEnv: status=используется; callers: server/middleware/requestValidators.js; Purpose: triggered from server/middleware/requestValidators.js to get numeric env
- isNonEmptyString: status=используется; callers: server/middleware/requestValidators.js; Purpose: triggered from server/middleware/requestValidators.js to is non empty string
- isPlainObject: status=используется; callers: server/middleware/requestValidators.js; Purpose: triggered from server/middleware/requestValidators.js to is plain object
- validateAgentRequest: status=сирота; callers: —; Purpose: local helper to validate agent request
- validateEndpointOption: status=используется; callers: server/middleware/requestValidators.js; Purpose: triggered from server/middleware/requestValidators.js to validate endpoint option
- validateIdentifiers: status=используется; callers: server/middleware/requestValidators.js; Purpose: triggered from server/middleware/requestValidators.js to validate identifiers
Logging status: ❌ (штучные warn/info). Добавить scoped logger `middleware.requestValidators` + requestId.
Outgoing Calls:
- appendIssue: count=11; defined_in=server/middleware/requestValidators.js; Purpose: invokes append issue
- isNaN: count=4; defined_in=external/unknown; Purpose: invokes is na n
- getNumericEnv: count=4; defined_in=server/middleware/requestValidators.js; Purpose: invokes get numeric env
- isArray: count=4; defined_in=external/unknown; Purpose: invokes is array
- parseInt: count=3; defined_in=external/unknown; Purpose: invokes parse int
- get: count=3; defined_in=external/unknown; Purpose: invokes get
- json: count=3; defined_in=external/unknown; Purpose: invokes json
- status: count=3; defined_in=external/unknown; Purpose: invokes status
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- isFinite: count=2; defined_in=external/unknown; Purpose: invokes is finite
- isPlainObject: count=2; defined_in=server/middleware/requestValidators.js; Purpose: invokes is plain object
- isNonEmptyString: count=2; defined_in=server/middleware/requestValidators.js; Purpose: invokes is non empty string
- warn: count=2; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- toFixed: count=2; defined_in=external/unknown; Purpose: invokes to fixed
- trim: count=1; defined_in=external/unknown; Purpose: invokes trim
- push: count=1; defined_in=external/unknown; Purpose: invokes push
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- info: count=1; defined_in=external/unknown; Purpose: invokes info
- forEach: count=1; defined_in=external/unknown; Purpose: invokes for each
- getFileSize: count=1; defined_in=server/middleware/requestValidators.js; Purpose: invokes get file size
- validateEndpointOption: count=1; defined_in=server/middleware/requestValidators.js; Purpose: invokes validate endpoint option
- validateIdentifiers: count=1; defined_in=server/middleware/requestValidators.js; Purpose: invokes validate identifiers
- next: count=1; defined_in=external/unknown; Purpose: invokes next

## server/routes/agents/chat.js
Purpose: Agent orchestration helpers
Inbound Links: none detected
Exports: None
Functions:
- controller: status=сирота; callers: —; Purpose: local helper to controller
Logging status: ❌ отсутствует requestId middleware и unified logger.
Outgoing Calls:
- require: count=12; defined_in=external/unknown; Purpose: invokes require
- use: count=7; defined_in=external/unknown; Purpose: invokes use
- send: count=3; defined_in=external/unknown; Purpose: invokes send
- status: count=3; defined_in=external/unknown; Purpose: invokes status
- error: count=3; defined_in=external/unknown; Purpose: invokes error
- post: count=2; defined_in=external/unknown; Purpose: invokes post
- get: count=2; defined_in=external/unknown; Purpose: invokes get
- slice: count=2; defined_in=external/unknown; Purpose: invokes slice
- json: count=2; defined_in=external/unknown; Purpose: invokes json
- Router: count=1; defined_in=external/unknown; Purpose: invokes router
- generateCheckAccess: count=1; defined_in=external/unknown; Purpose: invokes generate check access
- canAccessAgentFromBody: count=1; defined_in=external/unknown; Purpose: invokes can access agent from body
- AgentController: count=1; defined_in=server/controllers/agents/request.js; Purpose: invokes agent controller
- startsWith: count=1; defined_in=external/unknown; Purpose: invokes starts with
- renderMetrics: count=1; defined_in=utils/metrics.js; Purpose: invokes render metrics
- setHeader: count=1; defined_in=external/unknown; Purpose: invokes set header
- initialize: count=1; defined_in=server/routes/files/index.js, server/routes/files/rag.js, server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes initialize
- getAllIngestMarks: count=1; defined_in=external/unknown; Purpose: invokes get all ingest marks
- catch: count=1; defined_in=external/unknown; Purpose: invokes catch
- shutdown: count=1; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes shutdown

## server/routes/convos.js
Purpose: Express routes
Inbound Links: none detected
Exports: None
Functions:
- extractText: status=используется | опасность, дублируется в: manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js; callers: manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js; Purpose: triggered from manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js to extract text
- isBadTitle: status=используется; callers: server/routes/convos.js; Purpose: triggered from server/routes/convos.js to is bad title
- sendDeleteTaskToRedis: status=используется; callers: server/routes/convos.js; Purpose: triggered from server/routes/convos.js to send delete task to redis
- stripQuotes: status=используется; callers: server/routes/convos.js; Purpose: triggered from server/routes/convos.js to strip quotes
- tighten: status=используется; callers: server/routes/convos.js; Purpose: triggered from server/routes/convos.js to tighten
Logging status: ❌ (console/debug/warn). Внедрить scoped logger `routes.convos` и request context.
Outgoing Calls:
- require: count=21; defined_in=external/unknown; Purpose: invokes require
- status: count=21; defined_in=external/unknown; Purpose: invokes status
- json: count=14; defined_in=external/unknown; Purpose: invokes json
- error: count=13; defined_in=external/unknown; Purpose: invokes error
- debug: count=12; defined_in=external/unknown; Purpose: invokes debug
- send: count=7; defined_in=external/unknown; Purpose: invokes send
- post: count=5; defined_in=external/unknown; Purpose: invokes post
- get: count=4; defined_in=external/unknown; Purpose: invokes get
- String: count=4; defined_in=external/unknown; Purpose: invokes string
- map: count=4; defined_in=external/unknown; Purpose: invokes map
- delete: count=4; defined_in=external/unknown; Purpose: invokes delete
- replace: count=3; defined_in=external/unknown; Purpose: invokes replace
- extractText: count=3; defined_in=manage_summaries.js, server/controllers/agents/request.js, server/routes/convos.js; Purpose: invokes extract text
- trim: count=2; defined_in=external/unknown; Purpose: invokes trim
- toLowerCase: count=2; defined_in=external/unknown; Purpose: invokes to lower case
- includes: count=2; defined_in=external/unknown; Purpose: invokes includes
- startsWith: count=2; defined_in=external/unknown; Purpose: invokes starts with
- isArray: count=2; defined_in=external/unknown; Purpose: invokes is array
- tighten: count=2; defined_in=server/routes/convos.js; Purpose: invokes tighten
- saveConvo: count=2; defined_in=external/unknown; Purpose: invokes save convo
- warn: count=2; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- info: count=2; defined_in=external/unknown; Purpose: invokes info
- deleteConvos: count=2; defined_in=external/unknown; Purpose: invokes delete convos
- deleteToolCalls: count=2; defined_in=external/unknown; Purpose: invokes delete tool calls
- getBoolean: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes get boolean
- Router: count=1; defined_in=external/unknown; Purpose: invokes router
- use: count=1; defined_in=external/unknown; Purpose: invokes use
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- join: count=1; defined_in=external/unknown; Purpose: invokes join
- filter: count=1; defined_in=external/unknown; Purpose: invokes filter
- parseInt: count=1; defined_in=external/unknown; Purpose: invokes parse int
- isEnabled: count=1; defined_in=utils/natsClient.js; Purpose: invokes is enabled
- decodeURIComponent: count=1; defined_in=external/unknown; Purpose: invokes decode uricomponent
- getConvosByCursor: count=1; defined_in=external/unknown; Purpose: invokes get convos by cursor
- getBranchCountsForConversations: count=1; defined_in=models/Message.js; Purpose: invokes get branch counts for conversations
- getConvo: count=1; defined_in=models/Conversation.js; Purpose: invokes get convo
- end: count=1; defined_in=external/unknown; Purpose: invokes end
- getLogStores: count=1; defined_in=external/unknown; Purpose: invokes get log stores
- stripQuotes: count=1; defined_in=server/routes/convos.js; Purpose: invokes strip quotes
- isBadTitle: count=1; defined_in=server/routes/convos.js; Purpose: invokes is bad title
- getMessages: count=1; defined_in=models/Message.js; Purpose: invokes get messages
- find: count=1; defined_in=external/unknown; Purpose: invokes find
- getRedisClient: count=1; defined_in=utils/rag_redis.js; Purpose: invokes get redis client
- rpush: count=1; defined_in=external/unknown; Purpose: invokes rpush
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- call: count=1; defined_in=external/unknown; Purpose: invokes call
- initializeClient: count=1; defined_in=external/unknown; Purpose: invokes initialize client
- enqueueMemoryTasks: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes enqueue memory tasks
- now: count=1; defined_in=external/unknown; Purpose: invokes now
- getConversations: count=1; defined_in=external/unknown; Purpose: invokes get conversations
- sendDeleteTaskToRedis: count=1; defined_in=server/routes/convos.js; Purpose: invokes send delete task to redis
- createImportLimiters: count=1; defined_in=external/unknown; Purpose: invokes create import limiters
- createForkLimiters: count=1; defined_in=external/unknown; Purpose: invokes create fork limiters
- multer: count=1; defined_in=external/unknown; Purpose: invokes multer
- single: count=1; defined_in=external/unknown; Purpose: invokes single
- importConversations: count=1; defined_in=external/unknown; Purpose: invokes import conversations
- forkConversation: count=1; defined_in=external/unknown; Purpose: invokes fork conversation
- duplicateConversation: count=1; defined_in=external/unknown; Purpose: invokes duplicate conversation

## server/routes/files/index.js
Purpose: Express routes
Inbound Links: none detected
Exports: initialize
Functions:
- initialize: status=используется | опасность, дублируется в: server/routes/files/index.js, server/routes/files/rag.js, server/services/Deduplication/ingestDeduplicator.js; callers: server/routes/agents/chat.js, server/routes/files/index.js, server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/routes/agents/chat.js, server/routes/files/index.js, server/services/Deduplication/ingestDeduplicator.js to initialize
Outgoing Calls:
- use: count=11; defined_in=external/unknown; Purpose: invokes use
- require: count=10; defined_in=external/unknown; Purpose: invokes require
- post: count=7; defined_in=external/unknown; Purpose: invokes post
- single: count=6; defined_in=external/unknown; Purpose: invokes single
- Router: count=1; defined_in=external/unknown; Purpose: invokes router
- initialize: count=1; defined_in=server/routes/files/index.js, server/routes/files/rag.js, server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes initialize
- createMulterInstance: count=1; defined_in=external/unknown; Purpose: invokes create multer instance
- createFileLimiters: count=1; defined_in=external/unknown; Purpose: invokes create file limiters

## server/routes/files/rag.js
Purpose: Express routes
Inbound Links: none detected
Exports: initialize
Functions:
- initialize: status=используется | опасность, дублируется в: server/routes/files/index.js, server/routes/files/rag.js, server/services/Deduplication/ingestDeduplicator.js; callers: server/routes/agents/chat.js, server/routes/files/index.js, server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/routes/agents/chat.js, server/routes/files/index.js, server/services/Deduplication/ingestDeduplicator.js to initialize
- internalOrJwtAuth: status=используется; callers: server/routes/files/rag.js; Purpose: triggered from server/routes/files/rag.js to internal or jwt auth
Outgoing Calls:
- json: count=11; defined_in=external/unknown; Purpose: invokes json
- status: count=9; defined_in=external/unknown; Purpose: invokes status
- require: count=7; defined_in=external/unknown; Purpose: invokes require
- info: count=6; defined_in=external/unknown; Purpose: invokes info
- error: count=5; defined_in=external/unknown; Purpose: invokes error
- get: count=4; defined_in=external/unknown; Purpose: invokes get
- post: count=4; defined_in=external/unknown; Purpose: invokes post
- use: count=2; defined_in=external/unknown; Purpose: invokes use
- keys: count=2; defined_in=external/unknown; Purpose: invokes keys
- next: count=1; defined_in=external/unknown; Purpose: invokes next
- requireJwtAuth: count=1; defined_in=external/unknown; Purpose: invokes require jwt auth
- Router: count=1; defined_in=external/unknown; Purpose: invokes router
- internalOrJwtAuth: count=1; defined_in=server/routes/files/rag.js; Purpose: invokes internal or jwt auth
- multer: count=1; defined_in=external/unknown; Purpose: invokes multer
- memoryStorage: count=1; defined_in=external/unknown; Purpose: invokes memory storage
- cb: count=1; defined_in=external/unknown; Purpose: invokes cb
- single: count=1; defined_in=external/unknown; Purpose: invokes single

## server/services/agents/ContextCompressor.js
Purpose: Agent orchestration helpers
Inbound Links: none detected
Exports: ContextCompressor, CompressionStrategy, MessageCompressorBridge
Functions:
- getContentLength: status=используется; callers: server/services/agents/ContextCompressor.js; Purpose: triggered from server/services/agents/ContextCompressor.js to get content length
Logging status: ❌ нет логов — добавить trace для сжатия/эвикций.
Outgoing Calls:
- includes: count=5; defined_in=external/unknown; Purpose: invokes includes
- floor: count=5; defined_in=external/unknown; Purpose: invokes floor
- slice: count=5; defined_in=external/unknown; Purpose: invokes slice
- isArray: count=3; defined_in=external/unknown; Purpose: invokes is array
- _getType: count=3; defined_in=external/unknown; Purpose: invokes get type
- push: count=3; defined_in=external/unknown; Purpose: invokes push
- reduce: count=3; defined_in=external/unknown; Purpose: invokes reduce
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- filter: count=2; defined_in=external/unknown; Purpose: invokes filter
- max: count=2; defined_in=external/unknown; Purpose: invokes max
- getContentLength: count=2; defined_in=server/services/agents/ContextCompressor.js; Purpose: invokes get content length
- toLowerCase: count=1; defined_in=external/unknown; Purpose: invokes to lower case
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- getReductionFactor: count=1; defined_in=external/unknown; Purpose: invokes get reduction factor
- find: count=1; defined_in=external/unknown; Purpose: invokes find
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- map: count=1; defined_in=external/unknown; Purpose: invokes map
- info: count=1; defined_in=external/unknown; Purpose: invokes info

## server/services/agents/historyTrimmer.js
Purpose: Agent orchestration helpers
Inbound Links: none detected
Exports: HistoryTrimmer, ensureTokenCount
Functions:
- ensureTokenCount: status=используется; callers: server/services/agents/historyTrimmer.js; Purpose: triggered from server/services/agents/historyTrimmer.js to ensure token count
- sortByOriginalIndex: status=используется; callers: server/services/agents/historyTrimmer.js; Purpose: triggered from server/services/agents/historyTrimmer.js to sort by original index
- stableSortByImportance: status=используется; callers: server/services/agents/historyTrimmer.js; Purpose: triggered from server/services/agents/historyTrimmer.js to stable sort by importance
Logging status: ❌ отсутствует. Добавить scoped logger `agents.historyTrimmer` и эмитить события truncation.
Outgoing Calls:
- push: count=10; defined_in=external/unknown; Purpose: invokes push
- map: count=7; defined_in=external/unknown; Purpose: invokes map
- isArray: count=3; defined_in=external/unknown; Purpose: invokes is array
- assign: count=3; defined_in=external/unknown; Purpose: invokes assign
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- getTokenCount: count=2; defined_in=external/unknown; Purpose: invokes get token count
- floor: count=2; defined_in=external/unknown; Purpose: invokes floor
- forEach: count=2; defined_in=external/unknown; Purpose: invokes for each
- ensureTokenCount: count=2; defined_in=server/services/agents/historyTrimmer.js; Purpose: invokes ensure token count
- sort: count=2; defined_in=external/unknown; Purpose: invokes sort
- sortByOriginalIndex: count=2; defined_in=server/services/agents/historyTrimmer.js; Purpose: invokes sort by original index
- join: count=1; defined_in=external/unknown; Purpose: invokes join
- filter: count=1; defined_in=external/unknown; Purpose: invokes filter
- warn: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- max: count=1; defined_in=external/unknown; Purpose: invokes max
- importanceScorer: count=1; defined_in=external/unknown; Purpose: invokes importance scorer
- stableSortByImportance: count=1; defined_in=server/services/agents/historyTrimmer.js; Purpose: invokes stable sort by importance
- compress: count=1; defined_in=external/unknown; Purpose: invokes compress
- error: count=1; defined_in=external/unknown; Purpose: invokes error
- flat: count=1; defined_in=external/unknown; Purpose: invokes flat
- reduce: count=1; defined_in=external/unknown; Purpose: invokes reduce

## server/services/agents/InstructionsBuilder.js
Purpose: Agent orchestration helpers
Parse status: failed (needs manual review).
Logging status: ❌ неизвестно, требуется аудит файла.

## server/services/agents/MessageHistoryManager.js
Purpose: Agent orchestration helpers
Inbound Links: none detected
Exports: None
Functions: none detected
Logging status: ⚠️ info/warn присутствуют, но нужна унификация формата и привязка requestId/conversationId.
Outgoing Calls:
- info: count=6; defined_in=external/unknown; Purpose: invokes info
- slice: count=5; defined_in=external/unknown; Purpose: invokes slice
- require: count=4; defined_in=external/unknown; Purpose: invokes require
- error: count=3; defined_in=external/unknown; Purpose: invokes error
- max: count=3; defined_in=external/unknown; Purpose: invokes max
- extractMessageText: count=2; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes extract message text
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- toString: count=function toString() { [native code] }1; defined_in=external/unknown; Purpose: invokes to string
- test: count=3; defined_in=external/unknown; Purpose: invokes test
- normalizeMemoryText: count=2; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes normalize memory text
- makeIngestKey: count=2; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes make ingest key
- has: count=2; defined_in=external/unknown; Purpose: invokes has
- add: count=2; defined_in=external/unknown; Purpose: invokes add
- hashPayload: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes hash payload
- push: count=2; defined_in=external/unknown; Purpose: invokes push
- enqueueMemoryTasks: count=2; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes enqueue memory tasks
- isArray: count=2; defined_in=external/unknown; Purpose: invokes is array
- warn: count=2; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- Number: count=2; defined_in=external/unknown; Purpose: invokes number
- map: count=2; defined_in=external/unknown; Purpose: invokes map
- filter: count=2; defined_in=external/unknown; Purpose: invokes filter
- digest: count=1; defined_in=external/unknown; Purpose: invokes digest
- update: count=1; defined_in=external/unknown; Purpose: invokes update
- createHash: count=1; defined_in=external/unknown; Purpose: invokes create hash
- some: count=1; defined_in=external/unknown; Purpose: invokes some
- trim: count=1; defined_in=external/unknown; Purpose: invokes trim
- debug: count=1; defined_in=external/unknown; Purpose: invokes debug
- buildLayers: count=1; defined_in=external/unknown; Purpose: invokes build layers
- compressLayers: count=1; defined_in=external/unknown; Purpose: invokes compress layers
- selectWithinBudget: count=1; defined_in=external/unknown; Purpose: invokes select within budget
- reduce: count=1; defined_in=external/unknown; Purpose: invokes reduce
- find: count=1; defined_in=external/unknown; Purpose: invokes find

## server/services/agents/RetryStrategy.js
Purpose: Agent orchestration helpers
Inbound Links: none detected
Exports: None
Functions: none detected
Logging status: ❌ нет явных логов. Добавить debug-level события retry/backoff.
Outgoing Calls:
- includes: count=5; defined_in=external/unknown; Purpose: invokes includes
- require: count=1; defined_in=external/unknown; Purpose: invokes require
- pow: count=1; defined_in=external/unknown; Purpose: invokes pow
- min: count=1; defined_in=external/unknown; Purpose: invokes min
- fn: count=1; defined_in=external/unknown; Purpose: invokes fn
- retryCondition: count=1; defined_in=external/unknown; Purpose: invokes retry condition
- error: count=1; defined_in=external/unknown; Purpose: invokes error
- calculateDelay: count=1; defined_in=external/unknown; Purpose: invokes calculate delay
- warn: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- setTimeout: count=1; defined_in=external/unknown; Purpose: invokes set timeout
- toLowerCase: count=1; defined_in=external/unknown; Purpose: invokes to lower case
- String: count=1; defined_in=external/unknown; Purpose: invokes string

## server/services/Config/ConfigService.js
Purpose: Server services
Inbound Links: none detected
Exports: None
Functions:
- deepFreeze: status=используется; callers: server/services/Config/ConfigService.js; Purpose: triggered from server/services/Config/ConfigService.js to deep freeze
- parseOptionalBool: status=используется; callers: server/services/Config/ConfigService.js; Purpose: triggered from server/services/Config/ConfigService.js to parse optional bool
- parseOptionalFloat: status=используется; callers: server/services/Config/ConfigService.js; Purpose: triggered from server/services/Config/ConfigService.js to parse optional float
- parseOptionalInt: status=используется; callers: server/services/Config/ConfigService.js; Purpose: triggered from server/services/Config/ConfigService.js to parse optional int
- sanitizeOptionalString: status=используется; callers: server/services/Config/ConfigService.js; Purpose: triggered from server/services/Config/ConfigService.js to sanitize optional string
- sanitizeUrl: status=используется; callers: server/services/Config/ConfigService.js; Purpose: triggered from server/services/Config/ConfigService.js to sanitize url
- splitStringList: status=используется; callers: server/services/Config/ConfigService.js; Purpose: triggered from server/services/Config/ConfigService.js to split string list
Logging status: ⚠️ использует общий logger; после расширения logging-секции обновить уровни.
Outgoing Calls:
- parseOptionalInt: count=108; defined_in=server/services/Config/ConfigService.js; Purpose: invokes parse optional int
- number: count=99; defined_in=external/unknown; Purpose: invokes number
- int: count=90; defined_in=external/unknown; Purpose: invokes int
- optional: count=77; defined_in=external/unknown; Purpose: invokes optional
- object: count=61; defined_in=external/unknown; Purpose: invokes object
- min: count=61; defined_in=external/unknown; Purpose: invokes min
- string: count=60; defined_in=external/unknown; Purpose: invokes string
- sanitizeOptionalString: count=50; defined_in=server/services/Config/ConfigService.js; Purpose: invokes sanitize optional string
- positive: count=48; defined_in=external/unknown; Purpose: invokes positive
- nonnegative: count=46; defined_in=external/unknown; Purpose: invokes nonnegative
- parseOptionalBool: count=33; defined_in=server/services/Config/ConfigService.js; Purpose: invokes parse optional bool
- boolean: count=29; defined_in=external/unknown; Purpose: invokes boolean
- nullable: count=11; defined_in=external/unknown; Purpose: invokes nullable
- max: count=9; defined_in=external/unknown; Purpose: invokes max
- parseOptionalFloat: count=9; defined_in=server/services/Config/ConfigService.js; Purpose: invokes parse optional float
- has: count=6; defined_in=external/unknown; Purpose: invokes has
- sanitizeUrl: count=6; defined_in=server/services/Config/ConfigService.js; Purpose: invokes sanitize url
- trim: count=5; defined_in=external/unknown; Purpose: invokes trim
- getSection: count=5; defined_in=external/unknown; Purpose: invokes get section
- require: count=4; defined_in=external/unknown; Purpose: invokes require
- toLowerCase: count=4; defined_in=external/unknown; Purpose: invokes to lower case
- String: count=4; defined_in=external/unknown; Purpose: invokes string
- deepFreeze: count=4; defined_in=server/services/Config/ConfigService.js; Purpose: invokes deep freeze
- warn: count=4; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- keys: count=3; defined_in=external/unknown; Purpose: invokes keys
- url: count=3; defined_in=external/unknown; Purpose: invokes url
- info: count=3; defined_in=external/unknown; Purpose: invokes info
- get: count=3; defined_in=external/unknown; Purpose: invokes get
- set: count=3; defined_in=external/unknown; Purpose: invokes set
- error: count=3; defined_in=external/unknown; Purpose: invokes error
- isNaN: count=2; defined_in=external/unknown; Purpose: invokes is na n
- split: count=2; defined_in=external/unknown; Purpose: invokes split
- replace: count=2; defined_in=external/unknown; Purpose: invokes replace
- default: count=2; defined_in=external/unknown; Purpose: invokes default
- parseInt: count=1; defined_in=external/unknown; Purpose: invokes parse int
- parseFloat: count=1; defined_in=external/unknown; Purpose: invokes parse float
- filter: count=1; defined_in=external/unknown; Purpose: invokes filter
- map: count=1; defined_in=external/unknown; Purpose: invokes map
- isFrozen: count=1; defined_in=external/unknown; Purpose: invokes is frozen
- freeze: count=1; defined_in=external/unknown; Purpose: invokes freeze
- reloadAll: count=1; defined_in=external/unknown; Purpose: invokes reload all
- superRefine: count=1; defined_in=external/unknown; Purpose: invokes super refine
- array: count=1; defined_in=external/unknown; Purpose: invokes array
- addIssue: count=1; defined_in=external/unknown; Purpose: invokes add issue
- record: count=1; defined_in=external/unknown; Purpose: invokes record
- enum: count=1; defined_in=external/unknown; Purpose: invokes enum
- splitStringList: count=1; defined_in=server/services/Config/ConfigService.js; Purpose: invokes split string list
- includes: count=1; defined_in=external/unknown; Purpose: invokes includes
- entries: count=1; defined_in=external/unknown; Purpose: invokes entries
- startsWith: count=1; defined_in=external/unknown; Purpose: invokes starts with
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- parse: count=1; defined_in=external/unknown; Purpose: invokes parse
- loader: count=1; defined_in=external/unknown; Purpose: invokes loader
- flatten: count=1; defined_in=external/unknown; Purpose: invokes flatten
- clear: count=1; defined_in=external/unknown; Purpose: invokes clear
- forEach: count=1; defined_in=external/unknown; Purpose: invokes for each
- existsSync: count=1; defined_in=external/unknown; Purpose: invokes exists sync
- readFileSync: count=1; defined_in=external/unknown; Purpose: invokes read file sync
- load: count=1; defined_in=external/unknown; Purpose: invokes load
- Boolean: count=1; defined_in=external/unknown; Purpose: invokes boolean
- Number: count=1; defined_in=external/unknown; Purpose: invokes number
- isFinite: count=1; defined_in=external/unknown; Purpose: invokes is finite
- add: count=1; defined_in=external/unknown; Purpose: invokes add
- debug: count=1; defined_in=external/unknown; Purpose: invokes debug
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify

## server/services/Deduplication/clearDedupeKey.js
Purpose: Server services
Inbound Links: none detected
Exports: clearDedupeKey
Functions:
- canPublish: status=используется; callers: server/services/Deduplication/clearDedupeKey.js; Purpose: triggered from server/services/Deduplication/clearDedupeKey.js to can publish
- clearDedupeKey: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to clear dedupe key
- publishClearRequest: status=используется; callers: server/services/Deduplication/clearDedupeKey.js; Purpose: triggered from server/services/Deduplication/clearDedupeKey.js to publish clear request
Logging status: ⚠️ debug/warn есть, но без requestId. Перейти на scoped logger `dedupe.clearKey`.
Outgoing Calls:
- require: count=3; defined_in=external/unknown; Purpose: invokes require
- Boolean: count=2; defined_in=external/unknown; Purpose: invokes boolean
- debug: count=2; defined_in=external/unknown; Purpose: invokes debug
- canPublish: count=1; defined_in=server/services/Deduplication/clearDedupeKey.js; Purpose: invokes can publish
- publishNats: count=1; defined_in=external/unknown; Purpose: invokes publish nats
- publishClearRequest: count=1; defined_in=server/services/Deduplication/clearDedupeKey.js; Purpose: invokes publish clear request
- clearIngestedMark: count=1; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes clear ingested mark
- warn: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn

## server/services/Deduplication/ingestDeduplicator.js
Purpose: Server services
Inbound Links: none detected
Exports: initialize, markAsIngested, clearIngestedMark, getMetrics, shutdown
Functions:
- cacheDelete: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to cache delete
- clearIngestedMark: status=используется; callers: server/services/Deduplication/clearDedupeKey.js; Purpose: triggered from server/services/Deduplication/clearDedupeKey.js to clear ingested mark
- ensureBucket: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to ensure bucket
- getBucketName: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to get bucket name
- getMetrics: status=используется; callers: server/services/RAG/RagCache.js; Purpose: triggered from server/services/RAG/RagCache.js to get metrics
- initialize: status=используется | опасность, дублируется в: server/routes/files/index.js, server/routes/files/rag.js, server/services/Deduplication/ingestDeduplicator.js; callers: server/routes/agents/chat.js, server/routes/files/index.js, server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/routes/agents/chat.js, server/routes/files/index.js, server/services/Deduplication/ingestDeduplicator.js to initialize
- isTransientKvError: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to is transient kv error
- markAsIngested: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to mark as ingested
- markHit: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to mark hit
- markMiss: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to mark miss
- retryTransient: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to retry transient
- safeLabel: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to safe label
- shutdown: status=используется; callers: server/routes/agents/chat.js, server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/routes/agents/chat.js, server/services/Deduplication/ingestDeduplicator.js to shutdown
- startWatcher: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to start watcher
- stopWatcher: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to stop watcher
Logging status: ⚠️ warn/info присутствуют, требуется unified формат + метрики.
Outgoing Calls:
- warn: count=9; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- markMiss: count=7; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes mark miss
- require: count=6; defined_in=external/unknown; Purpose: invokes require
- set: count=6; defined_in=external/unknown; Purpose: invokes set
- info: count=4; defined_in=external/unknown; Purpose: invokes info
- isTransientKvError: count=3; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes is transient kv error
- error: count=3; defined_in=external/unknown; Purpose: invokes error
- retryTransient: count=3; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes retry transient
- isFinite: count=2; defined_in=external/unknown; Purpose: invokes is finite
- safeLabel: count=2; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes safe label
- delete: count=2; defined_in=external/unknown; Purpose: invokes delete
- test: count=2; defined_in=external/unknown; Purpose: invokes test
- stopWatcher: count=2; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes stop watcher
- cacheDelete: count=2; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes cache delete
- initialize: count=2; defined_in=server/routes/files/index.js, server/routes/files/rag.js, server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes initialize
- markHit: count=2; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes mark hit
- Boolean: count=2; defined_in=external/unknown; Purpose: invokes boolean
- StringCodec: count=1; defined_in=external/unknown; Purpose: invokes string codec
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- recordIngestDedupeHit: count=1; defined_in=utils/metrics.js; Purpose: invokes record ingest dedupe hit
- recordIngestDedupeMiss: count=1; defined_in=utils/metrics.js; Purpose: invokes record ingest dedupe miss
- del: count=1; defined_in=external/unknown; Purpose: invokes del
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- operation: count=1; defined_in=app/clients/BaseClient.js; Purpose: invokes operation
- random: count=1; defined_in=external/unknown; Purpose: invokes random
- setTimeout: count=1; defined_in=external/unknown; Purpose: invokes set timeout
- stop: count=1; defined_in=external/unknown; Purpose: invokes stop
- watch: count=1; defined_in=external/unknown; Purpose: invokes watch
- catch: count=1; defined_in=external/unknown; Purpose: invokes catch
- decode: count=1; defined_in=external/unknown; Purpose: invokes decode
- isNatsEnabled: count=1; defined_in=utils/temporalClient.js; Purpose: invokes is nats enabled
- getOrCreateKV: count=1; defined_in=utils/natsClient.js; Purpose: invokes get or create kv
- startWatcher: count=1; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes start watcher
- getBucketName: count=1; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes get bucket name
- shutdown: count=1; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes shutdown
- has: count=1; defined_in=external/unknown; Purpose: invokes has
- ensureBucket: count=1; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes ensure bucket
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- put: count=1; defined_in=external/unknown; Purpose: invokes put
- encode: count=1; defined_in=external/unknown; Purpose: invokes encode
- debug: count=1; defined_in=external/unknown; Purpose: invokes debug

## server/services/Endpoints/agents/title.js
Purpose: Agent orchestration helpers
Inbound Links: none detected
Exports: None
Functions:
- addTitle: status=используется | опасность, дублируется в: server/services/Endpoints/agents/title.js, server/services/Endpoints/google/title.js; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to add title
Logging status: ❌ разношёрстные warn/debug. Нужен scoped logger `endpoints.agents.title`.
Outgoing Calls:
- require: count=8; defined_in=external/unknown; Purpose: invokes require
- slice: count=6; defined_in=external/unknown; Purpose: invokes slice
- String: count=6; defined_in=external/unknown; Purpose: invokes string
- error: count=5; defined_in=external/unknown; Purpose: invokes error
- warn: count=5; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- set: count=5; defined_in=external/unknown; Purpose: invokes set
- saveConvo: count=5; defined_in=external/unknown; Purpose: invokes save convo
- trim: count=4; defined_in=external/unknown; Purpose: invokes trim
- replace: count=4; defined_in=external/unknown; Purpose: invokes replace
- debug: count=3; defined_in=external/unknown; Purpose: invokes debug
- now: count=3; defined_in=external/unknown; Purpose: invokes now
- catch: count=2; defined_in=external/unknown; Purpose: invokes catch
- abort: count=2; defined_in=external/unknown; Purpose: invokes abort
- clearTimeout: count=2; defined_in=external/unknown; Purpose: invokes clear timeout
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- isEnabled: count=1; defined_in=utils/natsClient.js; Purpose: invokes is enabled
- getLogStores: count=1; defined_in=external/unknown; Purpose: invokes get log stores
- setTimeout: count=1; defined_in=external/unknown; Purpose: invokes set timeout
- reject: count=1; defined_in=external/unknown; Purpose: invokes reject
- runWithResilience: count=1; defined_in=server/utils/resilience.js; Purpose: invokes run with resilience
- race: count=1; defined_in=external/unknown; Purpose: invokes race
- titleConvo: count=1; defined_in=external/unknown; Purpose: invokes title convo
- info: count=1; defined_in=external/unknown; Purpose: invokes info
- observeAgentTitle: count=1; defined_in=external/unknown; Purpose: invokes observe agent title
- incAgentTitleFailure: count=1; defined_in=external/unknown; Purpose: invokes inc agent title failure

## server/services/Endpoints/google/title.js
Purpose: Server services
Inbound Links: none detected
Exports: None
Functions:
- addTitle: status=используется | опасность, дублируется в: server/services/Endpoints/agents/title.js, server/services/Endpoints/google/title.js; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to add title
Logging status: ❌ аналогично агентскому; добавить scoped logger `endpoints.google.title`.
Outgoing Calls:
- require: count=7; defined_in=external/unknown; Purpose: invokes require
- debug: count=3; defined_in=external/unknown; Purpose: invokes debug
- getSection: count=2; defined_in=external/unknown; Purpose: invokes get section
- error: count=2; defined_in=external/unknown; Purpose: invokes error
- isEnabled: count=1; defined_in=utils/natsClient.js; Purpose: invokes is enabled
- initializeClient: count=1; defined_in=external/unknown; Purpose: invokes initialize client
- warn: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- titleConvo: count=1; defined_in=external/unknown; Purpose: invokes title convo
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- getLogStores: count=1; defined_in=external/unknown; Purpose: invokes get log stores
- set: count=1; defined_in=external/unknown; Purpose: invokes set
- saveConvo: count=1; defined_in=external/unknown; Purpose: invokes save convo

## server/services/Graph/LongTextWorker.js
Purpose: Server services
Inbound Links: none detected
Exports: chunkStore, createChunks, calcAdaptiveTimeout, LongTextGraphWorker, workerEvents
Functions:
- calcAdaptiveTimeout: status=используется; callers: server/services/Graph/LongTextWorker.js; Purpose: triggered from server/services/Graph/LongTextWorker.js to calc adaptive timeout
- createChunks: status=используется; callers: server/services/Graph/LongTextWorker.js; Purpose: triggered from server/services/Graph/LongTextWorker.js to create chunks
- flush: status=используется | опасность, дублируется в: server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; callers: server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; Purpose: triggered from server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js to flush
- sanitizeKeyPart: status=используется; callers: server/services/Graph/LongTextWorker.js; Purpose: triggered from server/services/Graph/LongTextWorker.js to sanitize key part
- sha1: status=используется | опасность, дублируется в: server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; callers: server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; Purpose: triggered from server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js to sha1
Logging status: ⚠️ присутствуют warn/info, но без requestId/taskId; требуется унификация и trace для chunking.
Outgoing Calls:
- require: count=10; defined_in=external/unknown; Purpose: invokes require
- trim: count=7; defined_in=external/unknown; Purpose: invokes trim
- warn: count=6; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- info: count=6; defined_in=external/unknown; Purpose: invokes info
- getNumber: count=4; defined_in=server/controllers/agents/client.js; Purpose: invokes get number
- sha1: count=4; defined_in=server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; Purpose: invokes sha1
- get: count=4; defined_in=external/unknown; Purpose: invokes get
- error: count=4; defined_in=external/unknown; Purpose: invokes error
- toISOString: count=4; defined_in=external/unknown; Purpose: invokes to isostring
- slice: count=3; defined_in=external/unknown; Purpose: invokes slice
- debug: count=3; defined_in=external/unknown; Purpose: invokes debug
- filter: count=2; defined_in=external/unknown; Purpose: invokes filter
- split: count=2; defined_in=external/unknown; Purpose: invokes split
- flush: count=2; defined_in=server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; Purpose: invokes flush
- isNatsEnabled: count=2; defined_in=utils/temporalClient.js; Purpose: invokes is nats enabled
- sanitizeKeyPart: count=2; defined_in=server/services/Graph/LongTextWorker.js; Purpose: invokes sanitize key part
- init: count=2; defined_in=external/unknown; Purpose: invokes init
- set: count=2; defined_in=external/unknown; Purpose: invokes set
- emitProgress: count=2; defined_in=external/unknown; Purpose: invokes emit progress
- merge: count=2; defined_in=external/unknown; Purpose: invokes merge
- incLongTextGraphChunk: count=2; defined_in=utils/metrics.js; Purpose: invokes inc long text graph chunk
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- digest: count=1; defined_in=external/unknown; Purpose: invokes digest
- update: count=1; defined_in=external/unknown; Purpose: invokes update
- createHash: count=1; defined_in=external/unknown; Purpose: invokes create hash
- map: count=1; defined_in=external/unknown; Purpose: invokes map
- flatMap: count=1; defined_in=external/unknown; Purpose: invokes flat map
- push: count=1; defined_in=external/unknown; Purpose: invokes push
- min: count=1; defined_in=external/unknown; Purpose: invokes min
- getOrCreateKV: count=1; defined_in=utils/natsClient.js; Purpose: invokes get or create kv
- parse: count=1; defined_in=external/unknown; Purpose: invokes parse
- decode: count=1; defined_in=external/unknown; Purpose: invokes decode
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- put: count=1; defined_in=external/unknown; Purpose: invokes put
- encode: count=1; defined_in=external/unknown; Purpose: invokes encode
- replace: count=1; defined_in=external/unknown; Purpose: invokes replace
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- resolve: count=1; defined_in=external/unknown; Purpose: invokes resolve
- on: count=1; defined_in=external/unknown; Purpose: invokes on
- enqueue: count=1; defined_in=external/unknown; Purpose: invokes enqueue
- finally: count=1; defined_in=external/unknown; Purpose: invokes finally
- process: count=1; defined_in=external/unknown; Purpose: invokes process
- createChunks: count=1; defined_in=server/services/Graph/LongTextWorker.js; Purpose: invokes create chunks
- processChunk: count=1; defined_in=external/unknown; Purpose: invokes process chunk
- enqueueVectorChunk: count=1; defined_in=external/unknown; Purpose: invokes enqueue vector chunk
- enqueueGraphChunk: count=1; defined_in=external/unknown; Purpose: invokes enqueue graph chunk
- enqueueMemoryTasks: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes enqueue memory tasks
- calcAdaptiveTimeout: count=1; defined_in=server/services/Graph/LongTextWorker.js; Purpose: invokes calc adaptive timeout
- runWithResilience: count=1; defined_in=server/utils/resilience.js; Purpose: invokes run with resilience
- enqueueGraphTask: count=1; defined_in=utils/temporalClient.js; Purpose: invokes enqueue graph task
- sendEvent: count=1; defined_in=external/unknown; Purpose: invokes send event

## server/services/pricing/PricingCalculator.js
Purpose: Server services
Inbound Links: none detected
Exports: None
Functions: none detected
Logging status: ❌ нет логов, добавить info/debug для загрузки тарифов.
Outgoing Calls:
- parseUsdRate: count=10; defined_in=server/controllers/agents/client.js; Purpose: invokes parse usd rate
- add: count=10; defined_in=external/unknown; Purpose: invokes add
- resolvePricingRates: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes resolve pricing rates
- info: count=2; defined_in=external/unknown; Purpose: invokes info
- require: count=1; defined_in=external/unknown; Purpose: invokes require
- Number: count=1; defined_in=external/unknown; Purpose: invokes number
- isFinite: count=1; defined_in=external/unknown; Purpose: invokes is finite
- join: count=1; defined_in=external/unknown; Purpose: invokes join
- from: count=1; defined_in=external/unknown; Purpose: invokes from
- round: count=1; defined_in=external/unknown; Purpose: invokes round
- toFixed: count=1; defined_in=external/unknown; Purpose: invokes to fixed
- formatCost: count=1; defined_in=external/unknown; Purpose: invokes format cost

## server/services/RAG/condense.js
Purpose: RAG pipeline utilities
Inbound Links: none detected
Exports: condenseContext, getCondenseProvidersPreview
Functions:
- addDescriptor: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to add descriptor
- cacheKeyChunk: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to cache key chunk
- cacheKeyReduce: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to cache key reduce
- callOllama: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to call ollama
- callOpenRouter: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to call open router
- condenseContext: status=сирота; callers: —; Purpose: local helper to condense context
- describeProviderChain: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to describe provider chain
- flush: status=используется | опасность, дублируется в: server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; callers: server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; Purpose: triggered from server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js to flush
- getCondenseProvidersPreview: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to get condense providers preview
- getPLimit: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to get plimit
- localFallback: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to local fallback
- mapPrompt: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to map prompt
- prepareGraphExtras: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to prepare graph extras
- reducePrompt: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to reduce prompt
- resolveFirstNonEmpty: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to resolve first non empty
- resolveSummarizerProviders: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to resolve summarizer providers
- sanitizeProviderName: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to sanitize provider name
- sha1: status=используется | опасность, дублируется в: server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; callers: server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; Purpose: triggered from server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js to sha1
- splitIntoChunks: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to split into chunks
- summarizeWithChain: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to summarize with chain
- summarizeWithDescriptor: status=используется; callers: server/services/RAG/condense.js; Purpose: triggered from server/services/RAG/condense.js to summarize with descriptor
Logging status: ⚠️ ragLogger частично есть; нужно перевести на новый слой + статус по каждому провайдеру.
Outgoing Calls:
- info: count=18; defined_in=external/unknown; Purpose: invokes info
- push: count=17; defined_in=external/unknown; Purpose: invokes push
- trim: count=12; defined_in=external/unknown; Purpose: invokes trim
- warn: count=11; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- resolveFirstNonEmpty: count=10; defined_in=server/services/RAG/condense.js; Purpose: invokes resolve first non empty
- join: count=8; defined_in=external/unknown; Purpose: invokes join
- flush: count=6; defined_in=server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; Purpose: invokes flush
- require: count=5; defined_in=external/unknown; Purpose: invokes require
- String: count=5; defined_in=external/unknown; Purpose: invokes string
- now: count=5; defined_in=external/unknown; Purpose: invokes now
- slice: count=4; defined_in=external/unknown; Purpose: invokes slice
- isArray: count=4; defined_in=external/unknown; Purpose: invokes is array
- map: count=4; defined_in=external/unknown; Purpose: invokes map
- localFallback: count=4; defined_in=server/services/RAG/condense.js; Purpose: invokes local fallback
- getSection: count=3; defined_in=external/unknown; Purpose: invokes get section
- Boolean: count=3; defined_in=external/unknown; Purpose: invokes boolean
- sanitizeProviderName: count=3; defined_in=server/services/RAG/condense.js; Purpose: invokes sanitize provider name
- addDescriptor: count=3; defined_in=server/services/RAG/condense.js; Purpose: invokes add descriptor
- some: count=3; defined_in=external/unknown; Purpose: invokes some
- summarizeWithChain: count=3; defined_in=server/services/RAG/condense.js; Purpose: invokes summarize with chain
- floor: count=2; defined_in=external/unknown; Purpose: invokes floor
- split: count=2; defined_in=external/unknown; Purpose: invokes split
- sha1: count=2; defined_in=server/services/Graph/LongTextWorker.js, server/services/RAG/condense.js; Purpose: invokes sha1
- mapPrompt: count=2; defined_in=server/services/RAG/condense.js; Purpose: invokes map prompt
- reducePrompt: count=2; defined_in=server/services/RAG/condense.js; Purpose: invokes reduce prompt
- filter: count=2; defined_in=external/unknown; Purpose: invokes filter
- includes: count=2; defined_in=external/unknown; Purpose: invokes includes
- post: count=2; defined_in=external/unknown; Purpose: invokes post
- error: count=2; defined_in=external/unknown; Purpose: invokes error
- resolveSummarizerProviders: count=2; defined_in=server/services/RAG/condense.js; Purpose: invokes resolve summarizer providers
- describeProviderChain: count=2; defined_in=server/services/RAG/condense.js; Purpose: invokes describe provider chain
- get: count=2; defined_in=external/unknown; Purpose: invokes get
- parse: count=2; defined_in=external/unknown; Purpose: invokes parse
- startsWith: count=2; defined_in=external/unknown; Purpose: invokes starts with
- setex: count=2; defined_in=external/unknown; Purpose: invokes setex
- stringify: count=2; defined_in=external/unknown; Purpose: invokes stringify
- toLowerCase: count=1; defined_in=external/unknown; Purpose: invokes to lower case
- max: count=1; defined_in=external/unknown; Purpose: invokes max
- digest: count=1; defined_in=external/unknown; Purpose: invokes digest
- update: count=1; defined_in=external/unknown; Purpose: invokes update
- createHash: count=1; defined_in=external/unknown; Purpose: invokes create hash
- callOpenRouter: count=1; defined_in=server/services/RAG/condense.js; Purpose: invokes call open router
- callOllama: count=1; defined_in=server/services/RAG/condense.js; Purpose: invokes call ollama
- summarizeWithDescriptor: count=1; defined_in=server/services/RAG/condense.js; Purpose: invokes summarize with descriptor
- forEach: count=1; defined_in=external/unknown; Purpose: invokes for each
- splitIntoChunks: count=1; defined_in=server/services/RAG/condense.js; Purpose: invokes split into chunks
- prepareGraphExtras: count=1; defined_in=server/services/RAG/condense.js; Purpose: invokes prepare graph extras
- getRedisClient: count=1; defined_in=utils/rag_redis.js; Purpose: invokes get redis client
- getPLimit: count=1; defined_in=server/services/RAG/condense.js; Purpose: invokes get plimit
- actualPLimit: count=1; defined_in=external/unknown; Purpose: invokes actual plimit
- all: count=1; defined_in=external/unknown; Purpose: invokes all
- limit: count=1; defined_in=external/unknown; Purpose: invokes limit
- cacheKeyChunk: count=1; defined_in=server/services/RAG/condense.js; Purpose: invokes cache key chunk
- cacheKeyReduce: count=1; defined_in=server/services/RAG/condense.js; Purpose: invokes cache key reduce

## server/services/RAG/intentAnalyzer.js
Purpose: RAG pipeline utilities
Inbound Links: none detected
Exports: analyzeIntent
Functions:
- analyzeIntent: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to analyze intent
- buildHints: status=используется; callers: server/services/RAG/intentAnalyzer.js; Purpose: triggered from server/services/RAG/intentAnalyzer.js to build hints
- extractEntities: status=используется; callers: server/services/RAG/intentAnalyzer.js; Purpose: triggered from server/services/RAG/intentAnalyzer.js to extract entities
- runAnalysis: status=используется; callers: server/services/RAG/intentAnalyzer.js; Purpose: triggered from server/services/RAG/intentAnalyzer.js to run analysis
Logging status: ❌ (кроме warn). Требуется scoped logger `rag.intentAnalyzer`.
Outgoing Calls:
- test: count=5; defined_in=external/unknown; Purpose: invokes test
- map: count=4; defined_in=external/unknown; Purpose: invokes map
- add: count=3; defined_in=external/unknown; Purpose: invokes add
- now: count=3; defined_in=external/unknown; Purpose: invokes now
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- from: count=2; defined_in=external/unknown; Purpose: invokes from
- warn: count=2; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- exec: count=1; defined_in=external/unknown; Purpose: invokes exec
- trim: count=1; defined_in=external/unknown; Purpose: invokes trim
- toLowerCase: count=1; defined_in=external/unknown; Purpose: invokes to lower case
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- set: count=1; defined_in=external/unknown; Purpose: invokes set
- values: count=1; defined_in=external/unknown; Purpose: invokes values
- min: count=1; defined_in=external/unknown; Purpose: invokes min
- createAbortError: count=1; defined_in=utils/async.js; Purpose: invokes create abort error
- isArray: count=1; defined_in=external/unknown; Purpose: invokes is array
- join: count=1; defined_in=external/unknown; Purpose: invokes join
- extractEntities: count=1; defined_in=server/services/RAG/intentAnalyzer.js; Purpose: invokes extract entities
- buildHints: count=1; defined_in=server/services/RAG/intentAnalyzer.js; Purpose: invokes build hints
- some: count=1; defined_in=external/unknown; Purpose: invokes some
- runAnalysis: count=1; defined_in=server/services/RAG/intentAnalyzer.js; Purpose: invokes run analysis
- withTimeout: count=1; defined_in=server/controllers/agents/client.js, utils/async.js; Purpose: invokes with timeout
- info: count=1; defined_in=external/unknown; Purpose: invokes info
- error: count=1; defined_in=external/unknown; Purpose: invokes error

## server/services/RAG/memoryQueue.js
Purpose: RAG pipeline utilities
Inbound Links: none detected
Exports: enqueueMemoryTasks, disableTemporal
Functions:
- callToolsGatewayDelete: status=сирота; callers: —; Purpose: local helper to call tools gateway delete
- chunk: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to chunk
- disableTemporal: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to disable temporal
- enqueueBatch: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to enqueue batch
- enqueueMemoryTasks: status=используется; callers: server/controllers/agents/client.js, server/controllers/agents/request.js, server/routes/convos.js, server/services/Graph/LongTextWorker.js, server/services/RAG/multiStepOrchestrator.js, server/services/agents/MessageHistoryManager.js, sync_history.js; Purpose: triggered from server/controllers/agents/client.js, server/controllers/agents/request.js, server/routes/convos.js, server/services/Graph/LongTextWorker.js, server/services/RAG/multiStepOrchestrator.js, server/services/agents/MessageHistoryManager.js, sync_history.js to enqueue memory tasks
- enqueueMemoryTasksSync: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to enqueue memory tasks sync
- getToolsGatewayConfig: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to get tools gateway config
- initTemporalClient: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to init temporal client
- isTransientError: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to is transient error
Logging status: ⚠️ info/warn есть, но нет requestId/conversationId. Добавить scoped logger `rag.memoryQueue`.
Outgoing Calls:
- error: count=7; defined_in=external/unknown; Purpose: invokes error
- incMemoryQueueSkipped: count=7; defined_in=utils/metrics.js; Purpose: invokes inc memory queue skipped
- now: count=7; defined_in=external/unknown; Purpose: invokes now
- warn: count=6; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- info: count=6; defined_in=external/unknown; Purpose: invokes info
- require: count=5; defined_in=external/unknown; Purpose: invokes require
- debug: count=5; defined_in=external/unknown; Purpose: invokes debug
- setTemporalStatus: count=4; defined_in=utils/metrics.js; Purpose: invokes set temporal status
- push: count=4; defined_in=external/unknown; Purpose: invokes push
- filter: count=3; defined_in=external/unknown; Purpose: invokes filter
- get: count=2; defined_in=external/unknown; Purpose: invokes get
- slice: count=2; defined_in=external/unknown; Purpose: invokes slice
- join: count=2; defined_in=external/unknown; Purpose: invokes join
- disableTemporal: count=2; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes disable temporal
- enqueueMemoryTasksSync: count=2; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes enqueue memory tasks sync
- Boolean: count=1; defined_in=external/unknown; Purpose: invokes boolean
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- some: count=1; defined_in=external/unknown; Purpose: invokes some
- test: count=1; defined_in=external/unknown; Purpose: invokes test
- getNumber: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes get number
- getToolsGatewayConfig: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes get tools gateway config
- post: count=1; defined_in=external/unknown; Purpose: invokes post
- incMemoryQueueToolsGatewayFailure: count=1; defined_in=utils/metrics.js; Purpose: invokes inc memory queue tools gateway failure
- toString: count=function toString() { [native code] }1; defined_in=external/unknown; Purpose: invokes to string
- random: count=1; defined_in=external/unknown; Purpose: invokes random
- enqueueMemoryTask: count=1; defined_in=utils/temporalClient.js; Purpose: invokes enqueue memory task
- isArray: count=1; defined_in=external/unknown; Purpose: invokes is array
- initTemporalClient: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes init temporal client
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- max: count=1; defined_in=external/unknown; Purpose: invokes max
- setImmediate: count=1; defined_in=external/unknown; Purpose: invokes set immediate
- setTimeout: count=1; defined_in=external/unknown; Purpose: invokes set timeout
- reject: count=1; defined_in=external/unknown; Purpose: invokes reject
- race: count=1; defined_in=external/unknown; Purpose: invokes race
- isTransientError: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes is transient error
- clearTimeout: count=1; defined_in=external/unknown; Purpose: invokes clear timeout
- chunk: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes chunk
- enqueueBatch: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes enqueue batch
- map: count=1; defined_in=external/unknown; Purpose: invokes map

## server/services/RAG/multiStepOrchestrator.js
Purpose: RAG pipeline utilities
Inbound Links: none detected
Exports: runMultiStepRag
Functions:
- accumulateTokens: status=используется; callers: server/services/RAG/multiStepOrchestrator.js; Purpose: triggered from server/services/RAG/multiStepOrchestrator.js to accumulate tokens
- createEntityState: status=сирота; callers: —; Purpose: local helper to create entity state
- enqueueFollowUp: status=используется; callers: server/services/RAG/multiStepOrchestrator.js; Purpose: triggered from server/services/RAG/multiStepOrchestrator.js to enqueue follow up
- fetchGraph: status=используется; callers: server/services/RAG/multiStepOrchestrator.js; Purpose: triggered from server/services/RAG/multiStepOrchestrator.js to fetch graph
- normalizeEntities: status=используется; callers: server/services/RAG/multiStepOrchestrator.js; Purpose: triggered from server/services/RAG/multiStepOrchestrator.js to normalize entities
- runMultiStepRag: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to run multi step rag
Logging status: ⚠️ ограниченные info/warn; нужна детализация шагов multi-step.
Outgoing Calls:
- info: count=7; defined_in=external/unknown; Purpose: invokes info
- map: count=4; defined_in=external/unknown; Purpose: invokes map
- require: count=3; defined_in=external/unknown; Purpose: invokes require
- isArray: count=3; defined_in=external/unknown; Purpose: invokes is array
- now: count=3; defined_in=external/unknown; Purpose: invokes now
- withTimeout: count=2; defined_in=server/controllers/agents/client.js, utils/async.js; Purpose: invokes with timeout
- error: count=2; defined_in=external/unknown; Purpose: invokes error
- join: count=2; defined_in=external/unknown; Purpose: invokes join
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- sort: count=1; defined_in=external/unknown; Purpose: invokes sort
- filter: count=1; defined_in=external/unknown; Purpose: invokes filter
- Number: count=1; defined_in=external/unknown; Purpose: invokes number
- enqueueMemoryTasks: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes enqueue memory tasks
- fetchGraphContext: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes fetch graph context
- observeSegmentTokens: count=1; defined_in=utils/ragMetrics.js; Purpose: invokes observe segment tokens
- setContextLength: count=1; defined_in=utils/ragMetrics.js; Purpose: invokes set context length
- warn: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- normalizeEntities: count=1; defined_in=server/services/RAG/multiStepOrchestrator.js; Purpose: invokes normalize entities
- createAbortError: count=1; defined_in=utils/async.js; Purpose: invokes create abort error
- fetchGraph: count=1; defined_in=server/services/RAG/multiStepOrchestrator.js; Purpose: invokes fetch graph
- push: count=1; defined_in=external/unknown; Purpose: invokes push
- accumulateTokens: count=1; defined_in=server/services/RAG/multiStepOrchestrator.js; Purpose: invokes accumulate tokens
- enqueueFollowUp: count=1; defined_in=server/services/RAG/multiStepOrchestrator.js; Purpose: invokes enqueue follow up
- every: count=1; defined_in=external/unknown; Purpose: invokes every

## server/services/RAG/RagCache.js
Purpose: RAG pipeline utilities
Inbound Links: none detected
Exports: None
Functions: none detected
Logging status: ❌ отсутствует. Добавить debug для cache hits/evictions (size-aware план).
Outgoing Calls:
- delete: count=7; defined_in=external/unknown; Purpose: invokes delete
- now: count=5; defined_in=external/unknown; Purpose: invokes now
- set: count=3; defined_in=external/unknown; Purpose: invokes set
- debug: count=2; defined_in=external/unknown; Purpose: invokes debug
- clear: count=2; defined_in=external/unknown; Purpose: invokes clear
- info: count=2; defined_in=external/unknown; Purpose: invokes info
- require: count=1; defined_in=external/unknown; Purpose: invokes require
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- has: count=1; defined_in=external/unknown; Purpose: invokes has
- evictLRU: count=1; defined_in=external/unknown; Purpose: invokes evict lru
- next: count=1; defined_in=external/unknown; Purpose: invokes next
- keys: count=1; defined_in=external/unknown; Purpose: invokes keys
- entries: count=1; defined_in=external/unknown; Purpose: invokes entries
- round: count=1; defined_in=external/unknown; Purpose: invokes round
- getMetrics: count=1; defined_in=server/services/Deduplication/ingestDeduplicator.js; Purpose: invokes get metrics

## server/services/RAG/RagContextBuilder.js
Purpose: RAG pipeline utilities
Inbound Links: none detected
Exports: None
Functions: none detected
Logging status: ⚠️ есть info/error, но без структуры. Требуется scoped logger `rag.contextBuilder`.
Outgoing Calls:
- slice: count=10; defined_in=external/unknown; Purpose: invokes slice
- Number: count=8; defined_in=external/unknown; Purpose: invokes number
- trim: count=7; defined_in=external/unknown; Purpose: invokes trim
- require: count=6; defined_in=external/unknown; Purpose: invokes require
- map: count=6; defined_in=external/unknown; Purpose: invokes map
- isArray: count=5; defined_in=external/unknown; Purpose: invokes is array
- getTokenCount: count=4; defined_in=external/unknown; Purpose: invokes get token count
- hashPayload: count=3; defined_in=server/controllers/agents/client.js; Purpose: invokes hash payload
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- toString: count=function toString() { [native code] }1; defined_in=external/unknown; Purpose: invokes to string
- info: count=7; defined_in=external/unknown; Purpose: invokes info
- filter: count=4; defined_in=external/unknown; Purpose: invokes filter
- error: count=4; defined_in=external/unknown; Purpose: invokes error
- join: count=4; defined_in=external/unknown; Purpose: invokes join
- post: count=3; defined_in=external/unknown; Purpose: invokes post
- now: count=2; defined_in=external/unknown; Purpose: invokes now
- max: count=2; defined_in=external/unknown; Purpose: invokes max
- observeCache: count=2; defined_in=utils/ragMetrics.js; Purpose: invokes observe cache
- sanitizeVectorChunks: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes sanitize vector chunks
- has: count=2; defined_in=external/unknown; Purpose: invokes has
- add: count=2; defined_in=external/unknown; Purpose: invokes add
- push: count=2; defined_in=external/unknown; Purpose: invokes push
- observeSegmentTokens: count=2; defined_in=utils/ragMetrics.js; Purpose: invokes observe segment tokens
- replace: count=2; defined_in=external/unknown; Purpose: invokes replace
- digest: count=1; defined_in=external/unknown; Purpose: invokes digest
- update: count=1; defined_in=external/unknown; Purpose: invokes update
- createHash: count=1; defined_in=external/unknown; Purpose: invokes create hash
- entries: count=1; defined_in=external/unknown; Purpose: invokes entries
- delete: count=1; defined_in=external/unknown; Purpose: invokes delete
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- Boolean: count=1; defined_in=external/unknown; Purpose: invokes boolean
- warn: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- pruneExpiredCache: count=1; defined_in=external/unknown; Purpose: invokes prune expired cache
- createCacheKey: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes create cache key
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- fetchGraphContext: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes fetch graph context
- sanitizeGraphContext: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes sanitize graph context
- condenseRagQuery: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes condense rag query
- fetchVectorContext: count=1; defined_in=external/unknown; Purpose: invokes fetch vector context
- fetchRecentTurns: count=1; defined_in=external/unknown; Purpose: invokes fetch recent turns
- isFinite: count=1; defined_in=external/unknown; Purpose: invokes is finite
- mapReduceContext: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes map reduce context
- sanitizeInput: count=1; defined_in=utils/security.js; Purpose: invokes sanitize input
- setContextLength: count=1; defined_in=utils/ragMetrics.js; Purpose: invokes set context length
- set: count=1; defined_in=external/unknown; Purpose: invokes set
- assign: count=1; defined_in=external/unknown; Purpose: invokes assign
- split: count=1; defined_in=external/unknown; Purpose: invokes split
- floor: count=1; defined_in=external/unknown; Purpose: invokes floor

## server/services/tokens/TokenCounter.js
Purpose: Server services
Inbound Links: none detected
Exports: None
Functions:
- countTokens: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/services/tokens/TokenCounter.js, server/utils/tokenBreakdown.js; callers: server/utils/tokenBreakdown.js; Purpose: triggered from server/utils/tokenBreakdown.js to count tokens
Logging status: ❌ нет. Добавить debug-level счётчики tokenization.
Outgoing Calls:
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- getTokenCount: count=2; defined_in=external/unknown; Purpose: invokes get token count
- createCacheKey: count=2; defined_in=server/controllers/agents/client.js; Purpose: invokes create cache key
- getTokenCountForMessage: count=2; defined_in=external/unknown; Purpose: invokes get token count for message
- reduce: count=2; defined_in=external/unknown; Purpose: invokes reduce
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- warn: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- ceil: count=1; defined_in=external/unknown; Purpose: invokes ceil
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- next: count=1; defined_in=external/unknown; Purpose: invokes next
- keys: count=1; defined_in=external/unknown; Purpose: invokes keys
- delete: count=1; defined_in=external/unknown; Purpose: invokes delete
- countText: count=1; defined_in=external/unknown; Purpose: invokes count text
- set: count=1; defined_in=external/unknown; Purpose: invokes set
- isArray: count=1; defined_in=external/unknown; Purpose: invokes is array
- countMessage: count=1; defined_in=external/unknown; Purpose: invokes count message
- values: count=1; defined_in=external/unknown; Purpose: invokes values
- Number: count=1; defined_in=external/unknown; Purpose: invokes number
- isNaN: count=1; defined_in=external/unknown; Purpose: invokes is na n
- clear: count=1; defined_in=external/unknown; Purpose: invokes clear
- debug: count=1; defined_in=external/unknown; Purpose: invokes debug

## server/utils/messageUtils.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: extractMessageText, normalizeMemoryText, makeIngestKey, condenseRagQuery
Functions:
- condenseRagQuery: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js to condense rag query
- extractMessageText: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: server/services/agents/MessageHistoryManager.js; Purpose: triggered from server/services/agents/MessageHistoryManager.js to extract message text
- makeIngestKey: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: server/controllers/agents/client.js, server/services/agents/MessageHistoryManager.js; Purpose: triggered from server/controllers/agents/client.js, server/services/agents/MessageHistoryManager.js to make ingest key
- normalizeMemoryText: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: server/services/agents/MessageHistoryManager.js; Purpose: triggered from server/services/agents/MessageHistoryManager.js to normalize memory text
- warn: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/utils/messageUtils.js; callers: app/clients/AnthropicClient.js, app/clients/BaseClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, app/clients/utils/instructions.js, db/indexSync.js, manage_summaries.js, models/Conversation.js, models/Message.js, server/controllers/agents/client.js, server/controllers/agents/request.js, server/middleware/requestValidators.js, server/routes/convos.js, server/services/Config/ConfigService.js, server/services/Deduplication/clearDedupeKey.js, server/services/Deduplication/ingestDeduplicator.js, server/services/Endpoints/agents/title.js, server/services/Endpoints/google/title.js, server/services/Graph/LongTextWorker.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/condense.js, server/services/RAG/intentAnalyzer.js, server/services/RAG/memoryQueue.js, server/services/RAG/multiStepOrchestrator.js, server/services/agents/MessageHistoryManager.js, server/services/agents/RetryStrategy.js, server/services/agents/historyTrimmer.js, server/services/tokens/TokenCounter.js, server/utils/messageUtils.js, utils/metrics.js, utils/natsClient.js, utils/temporalClient.js; Purpose: triggered from app/clients/AnthropicClient.js, app/clients/BaseClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, app/clients/utils/instructions.js, db/indexSync.js, manage_summaries.js, models/Conversation.js, models/Message.js, server/controllers/agents/client.js, server/controllers/agents/request.js, server/middleware/requestValidators.js, server/routes/convos.js, server/services/Config/ConfigService.js, server/services/Deduplication/clearDedupeKey.js, server/services/Deduplication/ingestDeduplicator.js, server/services/Endpoints/agents/title.js, server/services/Endpoints/google/title.js, server/services/Graph/LongTextWorker.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/condense.js, server/services/RAG/intentAnalyzer.js, server/services/RAG/memoryQueue.js, server/services/RAG/multiStepOrchestrator.js, server/services/agents/MessageHistoryManager.js, server/services/agents/RetryStrategy.js, server/services/agents/historyTrimmer.js, server/services/tokens/TokenCounter.js, server/utils/messageUtils.js, utils/metrics.js, utils/natsClient.js, utils/temporalClient.js to warn
Logging status: ⚠️ warn существует, но нужен scoped logger `utils.message` и структурные поля для ingest key/condense.
Outgoing Calls:
- trim: count=6; defined_in=external/unknown; Purpose: invokes trim
- warn: count=5; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- replace: count=3; defined_in=external/unknown; Purpose: invokes replace
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- isArray: count=2; defined_in=external/unknown; Purpose: invokes is array
- join: count=2; defined_in=external/unknown; Purpose: invokes join
- map: count=2; defined_in=external/unknown; Purpose: invokes map
- filter: count=2; defined_in=external/unknown; Purpose: invokes filter
- slice: count=2; defined_in=external/unknown; Purpose: invokes slice
- normalize: count=1; defined_in=external/unknown; Purpose: invokes normalize
- digest: count=1; defined_in=external/unknown; Purpose: invokes digest
- update: count=1; defined_in=external/unknown; Purpose: invokes update
- createHash: count=1; defined_in=external/unknown; Purpose: invokes create hash
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- split: count=1; defined_in=external/unknown; Purpose: invokes split
- has: count=1; defined_in=external/unknown; Purpose: invokes has
- push: count=1; defined_in=external/unknown; Purpose: invokes push
- add: count=1; defined_in=external/unknown; Purpose: invokes add
- max: count=1; defined_in=external/unknown; Purpose: invokes max
- floor: count=1; defined_in=external/unknown; Purpose: invokes floor

## server/utils/resilience.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: runWithResilience, normalizeLabelValue, DEFAULT_RESILIENCE_CONFIG
Functions:
- attemptExecutor: status=используется; callers: server/utils/resilience.js; Purpose: triggered from server/utils/resilience.js to attempt executor
- normalizeLabelValue: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to normalize label value
- runWithResilience: status=используется; callers: server/controllers/agents/request.js, server/services/Endpoints/agents/title.js, server/services/Graph/LongTextWorker.js; Purpose: triggered from server/controllers/agents/request.js, server/services/Endpoints/agents/title.js, server/services/Graph/LongTextWorker.js to run with resilience
Logging status: ❌ нет scoped логов; добавить при попытках/ретраях.
Outgoing Calls:
- max: count=5; defined_in=external/unknown; Purpose: invokes max
- isFinite: count=4; defined_in=external/unknown; Purpose: invokes is finite
- now: count=3; defined_in=external/unknown; Purpose: invokes now
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- error: count=2; defined_in=external/unknown; Purpose: invokes error
- min: count=1; defined_in=external/unknown; Purpose: invokes min
- Boolean: count=1; defined_in=external/unknown; Purpose: invokes boolean
- resolve: count=1; defined_in=external/unknown; Purpose: invokes resolve
- fn: count=1; defined_in=external/unknown; Purpose: invokes fn
- withTimeout: count=1; defined_in=server/controllers/agents/client.js, utils/async.js; Purpose: invokes with timeout
- attemptExecutor: count=1; defined_in=server/utils/resilience.js; Purpose: invokes attempt executor
- info: count=1; defined_in=external/unknown; Purpose: invokes info
- onRetry: count=1; defined_in=external/unknown; Purpose: invokes on retry
- retryAsync: count=1; defined_in=utils/async.js; Purpose: invokes retry async
- debug: count=1; defined_in=external/unknown; Purpose: invokes debug
- trim: count=1; defined_in=external/unknown; Purpose: invokes trim

## server/utils/responseUtils.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: canWrite, isResponseFinalized, makeDetachableRes, safeEndResponse, safeWrite
Functions:
- canWrite: status=используется; callers: server/controllers/agents/client.js, server/controllers/agents/request.js, server/utils/responseUtils.js; Purpose: triggered from server/controllers/agents/client.js, server/controllers/agents/request.js, server/utils/responseUtils.js to can write
- isResponseFinalized: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to is response finalized
- makeDetachableRes: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to make detachable res
- safeEndResponse: status=сирота; callers: —; Purpose: local helper to safe end response
- safeWrite: status=сирота; callers: —; Purpose: local helper to safe write
Logging status: ❌ отсутствует. Добавить debug/trace для detachable responses.
Outgoing Calls:
- canWrite: count=4; defined_in=server/utils/responseUtils.js; Purpose: invokes can write
- Boolean: count=2; defined_in=external/unknown; Purpose: invokes boolean
- write: count=2; defined_in=external/unknown; Purpose: invokes write
- end: count=2; defined_in=external/unknown; Purpose: invokes end
- debug: count=2; defined_in=external/unknown; Purpose: invokes debug
- require: count=1; defined_in=external/unknown; Purpose: invokes require
- flushHeaders: count=1; defined_in=external/unknown; Purpose: invokes flush headers
- on: count=1; defined_in=external/unknown; Purpose: invokes on
- removeListener: count=1; defined_in=external/unknown; Purpose: invokes remove listener

## server/utils/tokenBreakdown.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: computePromptTokenBreakdown, logPromptTokenBreakdown, analyzeTokenization
Functions:
- analyzeTokenization: status=сирота; callers: —; Purpose: local helper to analyze tokenization
- applyPreview: status=используется; callers: server/utils/tokenBreakdown.js; Purpose: triggered from server/utils/tokenBreakdown.js to apply preview
- buildSumLine: status=используется; callers: server/utils/tokenBreakdown.js; Purpose: triggered from server/utils/tokenBreakdown.js to build sum line
- computePromptTokenBreakdown: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to compute prompt token breakdown
- countTokens: status=используется | опасность, дублируется в: server/controllers/agents/client.js, server/services/tokens/TokenCounter.js, server/utils/tokenBreakdown.js; callers: server/utils/tokenBreakdown.js; Purpose: triggered from server/utils/tokenBreakdown.js to count tokens
- logPromptTokenBreakdown: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to log prompt token breakdown
- normalizeMessages: status=используется; callers: server/utils/tokenBreakdown.js; Purpose: triggered from server/utils/tokenBreakdown.js to normalize messages
- toNumber: status=используется; callers: server/utils/tokenBreakdown.js; Purpose: triggered from server/utils/tokenBreakdown.js to to number
- toText: status=используется; callers: server/utils/tokenBreakdown.js; Purpose: triggered from server/utils/tokenBreakdown.js to to text
Logging status: ❌ нет. Нужен scoped logger `utils.tokenBreakdown` для отчётов.
Outgoing Calls:
- toNumber: count=12; defined_in=server/utils/tokenBreakdown.js; Purpose: invokes to number
- isArray: count=4; defined_in=external/unknown; Purpose: invokes is array
- map: count=3; defined_in=external/unknown; Purpose: invokes map
- Boolean: count=3; defined_in=external/unknown; Purpose: invokes boolean
- join: count=2; defined_in=external/unknown; Purpose: invokes join
- toText: count=2; defined_in=server/utils/tokenBreakdown.js; Purpose: invokes to text
- countTokens: count=2; defined_in=server/controllers/agents/client.js, server/services/tokens/TokenCounter.js, server/utils/tokenBreakdown.js; Purpose: invokes count tokens
- applyPreview: count=2; defined_in=server/utils/tokenBreakdown.js; Purpose: invokes apply preview
- logLevel: count=2; defined_in=external/unknown; Purpose: invokes log level
- require: count=1; defined_in=external/unknown; Purpose: invokes require
- Number: count=1; defined_in=external/unknown; Purpose: invokes number
- isFinite: count=1; defined_in=external/unknown; Purpose: invokes is finite
- toLowerCase: count=1; defined_in=external/unknown; Purpose: invokes to lower case
- trim: count=1; defined_in=external/unknown; Purpose: invokes trim
- has: count=1; defined_in=external/unknown; Purpose: invokes has
- filter: count=1; defined_in=external/unknown; Purpose: invokes filter
- encode: count=1; defined_in=external/unknown; Purpose: invokes encode
- push: count=1; defined_in=external/unknown; Purpose: invokes push
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- normalizeMessages: count=1; defined_in=server/utils/tokenBreakdown.js; Purpose: invokes normalize messages
- reduce: count=1; defined_in=external/unknown; Purpose: invokes reduce
- max: count=1; defined_in=external/unknown; Purpose: invokes max
- toISOString: count=1; defined_in=external/unknown; Purpose: invokes to isostring
- buildSumLine: count=1; defined_in=server/utils/tokenBreakdown.js; Purpose: invokes build sum line

## sync_history.js
Purpose: General purpose module
Inbound Links: none detected
Exports: None
Functions:
- detectContextFlags: status=используется; callers: sync_history.js; Purpose: triggered from sync_history.js to detect context flags
- extractFullText: status=используется; callers: sync_history.js; Purpose: triggered from sync_history.js to extract full text
- main: status=используется; callers: sync_history.js; Purpose: triggered from sync_history.js to main
Logging status: ❌ использует raw `console.log`. Внедрить scoped logger `scripts.syncHistory`.
Outgoing Calls:
- log: count=13; defined_in=external/unknown; Purpose: invokes log
- includes: count=7; defined_in=external/unknown; Purpose: invokes includes
- push: count=5; defined_in=external/unknown; Purpose: invokes push
- require: count=4; defined_in=external/unknown; Purpose: invokes require
- error: count=4; defined_in=external/unknown; Purpose: invokes error
- exit: count=2; defined_in=external/unknown; Purpose: invokes exit
- model: count=2; defined_in=external/unknown; Purpose: invokes model
- trim: count=2; defined_in=external/unknown; Purpose: invokes trim
- find: count=2; defined_in=external/unknown; Purpose: invokes find
- toISOString: count=2; defined_in=external/unknown; Purpose: invokes to isostring
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- getNumber: count=1; defined_in=server/controllers/agents/client.js; Purpose: invokes get number
- isArray: count=1; defined_in=external/unknown; Purpose: invokes is array
- connect: count=1; defined_in=external/unknown; Purpose: invokes connect
- lean: count=1; defined_in=external/unknown; Purpose: invokes lean
- sort: count=1; defined_in=external/unknown; Purpose: invokes sort
- extractFullText: count=1; defined_in=sync_history.js; Purpose: invokes extract full text
- detectContextFlags: count=1; defined_in=sync_history.js; Purpose: invokes detect context flags
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- reduce: count=1; defined_in=external/unknown; Purpose: invokes reduce
- enqueueMemoryTasks: count=1; defined_in=server/services/RAG/memoryQueue.js; Purpose: invokes enqueue memory tasks
- updateMany: count=1; defined_in=external/unknown; Purpose: invokes update many
- disconnect: count=1; defined_in=external/unknown; Purpose: invokes disconnect
- main: count=1; defined_in=sync_history.js; Purpose: invokes main

## utils/async.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: withTimeout, retryAsync, sleep, createAbortError
Functions:
- cleanup: status=используется; callers: utils/async.js; Purpose: triggered from utils/async.js to cleanup
- computeDelay: status=используется; callers: utils/async.js; Purpose: triggered from utils/async.js to compute delay
- createAbortError: status=используется; callers: server/services/RAG/intentAnalyzer.js, server/services/RAG/multiStepOrchestrator.js, utils/async.js; Purpose: triggered from server/services/RAG/intentAnalyzer.js, server/services/RAG/multiStepOrchestrator.js, utils/async.js to create abort error
- onAbort: status=сирота; callers: —; Purpose: local helper to on abort
- retryAsync: status=используется; callers: app/clients/BaseClient.js, server/utils/resilience.js, utils/natsClient.js; Purpose: triggered from app/clients/BaseClient.js, server/utils/resilience.js, utils/natsClient.js to retry async
- sleep: status=используется; callers: app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, utils/async.js; Purpose: triggered from app/clients/AnthropicClient.js, app/clients/GoogleClient.js, app/clients/OpenAIClient.js, utils/async.js to sleep
- withTimeout: status=используется | опасность, дублируется в: server/controllers/agents/client.js, utils/async.js; callers: app/clients/BaseClient.js, server/controllers/agents/client.js, server/services/RAG/intentAnalyzer.js, server/services/RAG/multiStepOrchestrator.js, server/utils/resilience.js; Purpose: triggered from app/clients/BaseClient.js, server/controllers/agents/client.js, server/services/RAG/intentAnalyzer.js, server/services/RAG/multiStepOrchestrator.js, server/utils/resilience.js to with timeout
Logging status: ❌ нет. Добавить trace для retryAsync/withTimeout (по флагу).
Outgoing Calls:
- reject: count=4; defined_in=external/unknown; Purpose: invokes reject
- createAbortError: count=4; defined_in=utils/async.js; Purpose: invokes create abort error
- cleanup: count=4; defined_in=utils/async.js; Purpose: invokes cleanup
- resolve: count=2; defined_in=external/unknown; Purpose: invokes resolve
- setTimeout: count=2; defined_in=external/unknown; Purpose: invokes set timeout
- unref: count=2; defined_in=external/unknown; Purpose: invokes unref
- clearTimeout: count=2; defined_in=external/unknown; Purpose: invokes clear timeout
- removeEventListener: count=2; defined_in=external/unknown; Purpose: invokes remove event listener
- addEventListener: count=2; defined_in=external/unknown; Purpose: invokes add event listener
- finally: count=1; defined_in=external/unknown; Purpose: invokes finally
- race: count=1; defined_in=external/unknown; Purpose: invokes race
- min: count=1; defined_in=external/unknown; Purpose: invokes min
- pow: count=1; defined_in=external/unknown; Purpose: invokes pow
- random: count=1; defined_in=external/unknown; Purpose: invokes random
- max: count=1; defined_in=external/unknown; Purpose: invokes max
- fn: count=1; defined_in=external/unknown; Purpose: invokes fn
- onRetry: count=1; defined_in=external/unknown; Purpose: invokes on retry
- computeDelay: count=1; defined_in=utils/async.js; Purpose: invokes compute delay
- sleep: count=1; defined_in=utils/async.js; Purpose: invokes sleep

## utils/branchLogger.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: None
Functions: none detected
Logging status: ⚠️ отдельный Winston инстанс; нужно влить в общий логгер.
Outgoing Calls:
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- combine: count=2; defined_in=external/unknown; Purpose: invokes combine
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- printf: count=1; defined_in=external/unknown; Purpose: invokes printf
- createLogger: count=1; defined_in=external/unknown; Purpose: invokes create logger
- timestamp: count=1; defined_in=external/unknown; Purpose: invokes timestamp
- colorize: count=1; defined_in=external/unknown; Purpose: invokes colorize

## utils/memoryConfig.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: getMemoryConfig, refreshMemoryConfig
Functions:
- buildMemoryConfig: status=используется; callers: utils/memoryConfig.js; Purpose: triggered from utils/memoryConfig.js to build memory config
- getMemoryConfig: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to get memory config
- refreshMemoryConfig: status=сирота; callers: —; Purpose: local helper to refresh memory config
Logging status: ❌ нет. Добавить info/debug при reload.
Outgoing Calls:
- freeze: count=12; defined_in=external/unknown; Purpose: invokes freeze
- getSection: count=6; defined_in=external/unknown; Purpose: invokes get section
- buildMemoryConfig: count=2; defined_in=utils/memoryConfig.js; Purpose: invokes build memory config
- require: count=1; defined_in=external/unknown; Purpose: invokes require
- get: count=1; defined_in=external/unknown; Purpose: invokes get

## utils/metrics.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: register, renderMetrics, recordIngestDedupeHit, recordIngestDedupeMiss, observeSendMessage, incSendMessageFailure, observeMemoryQueueLatency, incMemoryQueueFailure, incMemoryQueueSkipped, incMemoryQueueToolsGatewayFailure, observeSummaryEnqueue, incSummaryEnqueueFailure, incSummaryEnqueueTotal, observeGraphEnqueue, incGraphEnqueueFailure, incGraphEnqueueTotal, setTemporalStatus, incLongTextTask, incLongTextGraphChunk
Functions:
- incGraphEnqueueFailure: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to inc graph enqueue failure
- incGraphEnqueueTotal: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to inc graph enqueue total
- incLongTextGraphChunk: status=используется; callers: server/services/Graph/LongTextWorker.js; Purpose: triggered from server/services/Graph/LongTextWorker.js to inc long text graph chunk
- incLongTextTask: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to inc long text task
- incMemoryQueueFailure: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to inc memory queue failure
- incMemoryQueueSkipped: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to inc memory queue skipped
- incMemoryQueueToolsGatewayFailure: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to inc memory queue tools gateway failure
- incSendMessageFailure: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to inc send message failure
- incSummaryEnqueueFailure: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to inc summary enqueue failure
- incSummaryEnqueueTotal: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to inc summary enqueue total
- observeGraphEnqueue: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to observe graph enqueue
- observeMemoryQueueLatency: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to observe memory queue latency
- observeMs: status=используется; callers: utils/metrics.js; Purpose: triggered from utils/metrics.js to observe ms
- observeSendMessage: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to observe send message
- observeSummaryEnqueue: status=используется; callers: server/controllers/agents/request.js; Purpose: triggered from server/controllers/agents/request.js to observe summary enqueue
- recordIngestDedupeHit: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to record ingest dedupe hit
- recordIngestDedupeMiss: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js to record ingest dedupe miss
- renderMetrics: status=используется; callers: server/routes/agents/chat.js; Purpose: triggered from server/routes/agents/chat.js to render metrics
- safeLabels: status=используется; callers: utils/metrics.js; Purpose: triggered from utils/metrics.js to safe labels
- setTemporalStatus: status=используется; callers: server/controllers/agents/request.js, server/services/RAG/memoryQueue.js; Purpose: triggered from server/controllers/agents/request.js, server/services/RAG/memoryQueue.js to set temporal status
Logging status: ⚠️ только warn. Нужен scoped logger `utils.metrics` для регистраций и ошибок.
Outgoing Calls:
- safeLabels: count=14; defined_in=utils/metrics.js; Purpose: invokes safe labels
- inc: count=12; defined_in=external/unknown; Purpose: invokes inc
- observeMs: count=4; defined_in=utils/metrics.js; Purpose: invokes observe ms
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- getSingleMetric: count=1; defined_in=external/unknown; Purpose: invokes get single metric
- collectDefaultMetrics: count=1; defined_in=external/unknown; Purpose: invokes collect default metrics
- fromEntries: count=1; defined_in=external/unknown; Purpose: invokes from entries
- map: count=1; defined_in=external/unknown; Purpose: invokes map
- entries: count=1; defined_in=external/unknown; Purpose: invokes entries
- isNaN: count=1; defined_in=external/unknown; Purpose: invokes is na n
- observe: count=1; defined_in=external/unknown; Purpose: invokes observe
- metrics: count=1; defined_in=external/unknown; Purpose: invokes metrics
- set: count=1; defined_in=external/unknown; Purpose: invokes set
- warn: count=1; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn

## utils/natsClient.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: isEnabled, sc, getJetStream, getJetStreamManager, resolveKvNames, ensureKvStream, createKvStream, getOrCreateStream, getOrCreateKV, publish, subscribe, close
Functions:
- close: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to close
- connectOnce: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to connect once
- createKvStream: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to create kv stream
- ensureConnection: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to ensure connection
- ensureKvStream: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to ensure kv stream
- getJetStream: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to get jet stream
- getJetStreamManager: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to get jet stream manager
- getNatsConfig: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to get nats config
- getOrCreateKV: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js, server/services/Graph/LongTextWorker.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js, server/services/Graph/LongTextWorker.js to get or create kv
- getOrCreateStream: status=сирота; callers: —; Purpose: local helper to get or create stream
- getRetrySettings: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to get retry settings
- isEnabled: status=используется; callers: app/clients/OpenAIClient.js, server/routes/convos.js, server/services/Endpoints/agents/title.js, server/services/Endpoints/google/title.js; Purpose: triggered from app/clients/OpenAIClient.js, server/routes/convos.js, server/services/Endpoints/agents/title.js, server/services/Endpoints/google/title.js to is enabled
- publish: status=используется; callers: utils/natsClient.js, utils/temporalClient.js; Purpose: triggered from utils/natsClient.js, utils/temporalClient.js to publish
- resetConnectionState: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to reset connection state
- resolveKvNames: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to resolve kv names
- subscribe: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to subscribe
- ttlToNanosNumber: status=используется; callers: utils/natsClient.js; Purpose: triggered from utils/natsClient.js to ttl to nanos number
Outgoing Calls:
- info: count=8; defined_in=external/unknown; Purpose: invokes info
- getNatsConfig: count=5; defined_in=utils/natsClient.js; Purpose: invokes get nats config
- warn: count=5; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- require: count=4; defined_in=external/unknown; Purpose: invokes require
- resetConnectionState: count=3; defined_in=utils/natsClient.js; Purpose: invokes reset connection state
- resolveKvNames: count=3; defined_in=utils/natsClient.js; Purpose: invokes resolve kv names
- getJetStream: count=3; defined_in=utils/natsClient.js; Purpose: invokes get jet stream
- isClosed: count=2; defined_in=external/unknown; Purpose: invokes is closed
- error: count=2; defined_in=external/unknown; Purpose: invokes error
- ensureConnection: count=2; defined_in=utils/natsClient.js; Purpose: invokes ensure connection
- getJetStreamManager: count=2; defined_in=utils/natsClient.js; Purpose: invokes get jet stream manager
- test: count=2; defined_in=external/unknown; Purpose: invokes test
- add: count=2; defined_in=external/unknown; Purpose: invokes add
- StringCodec: count=1; defined_in=external/unknown; Purpose: invokes string codec
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- Boolean: count=1; defined_in=external/unknown; Purpose: invokes boolean
- connect: count=1; defined_in=external/unknown; Purpose: invokes connect
- then: count=1; defined_in=external/unknown; Purpose: invokes then
- closed: count=1; defined_in=external/unknown; Purpose: invokes closed
- join: count=1; defined_in=external/unknown; Purpose: invokes join
- getRetrySettings: count=1; defined_in=utils/natsClient.js; Purpose: invokes get retry settings
- catch: count=1; defined_in=external/unknown; Purpose: invokes catch
- retryAsync: count=1; defined_in=utils/async.js; Purpose: invokes retry async
- connectOnce: count=1; defined_in=utils/natsClient.js; Purpose: invokes connect once
- jetstream: count=1; defined_in=external/unknown; Purpose: invokes jetstream
- jetstreamManager: count=1; defined_in=external/unknown; Purpose: invokes jetstream manager
- replace: count=1; defined_in=external/unknown; Purpose: invokes replace
- trim: count=1; defined_in=external/unknown; Purpose: invokes trim
- String: count=1; defined_in=external/unknown; Purpose: invokes string
- ttlToNanosNumber: count=1; defined_in=utils/natsClient.js; Purpose: invokes ttl to nanos number
- ensureKvStream: count=1; defined_in=utils/natsClient.js; Purpose: invokes ensure kv stream
- createKvStream: count=1; defined_in=utils/natsClient.js; Purpose: invokes create kv stream
- kv: count=1; defined_in=external/unknown; Purpose: invokes kv
- isBuffer: count=1; defined_in=external/unknown; Purpose: invokes is buffer
- encode: count=1; defined_in=external/unknown; Purpose: invokes encode
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- publish: count=1; defined_in=utils/natsClient.js; Purpose: invokes publish
- subscribe: count=1; defined_in=utils/natsClient.js; Purpose: invokes subscribe
- drain: count=1; defined_in=external/unknown; Purpose: invokes drain
- close: count=1; defined_in=utils/natsClient.js; Purpose: invokes close

## utils/rag_redis.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: getRedisClient, publishToRedis, acquireLock, releaseLock
Functions:
- acquireLock: status=сирота; callers: —; Purpose: local helper to acquire lock
- getRedisClient: status=используется; callers: server/routes/convos.js, server/services/RAG/condense.js; Purpose: triggered from server/routes/convos.js, server/services/RAG/condense.js to get redis client
- publishToRedis: status=сирота; callers: —; Purpose: local helper to publish to redis
- releaseLock: status=сирота; callers: —; Purpose: local helper to release lock
Outgoing Calls:
- require: count=1; defined_in=external/unknown; Purpose: invokes require
- info: count=1; defined_in=external/unknown; Purpose: invokes info

## utils/ragMetrics.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: register, segmentCounter, cacheCounter, costCounter, ragContextGauge, observeSegmentTokens, observeCache, observeCost, setContextLength
Functions:
- observeCache: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js to observe cache
- observeCost: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to observe cost
- observeSegmentTokens: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/multiStepOrchestrator.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/multiStepOrchestrator.js to observe segment tokens
- reuseMetric: status=используется; callers: utils/ragMetrics.js; Purpose: triggered from utils/ragMetrics.js to reuse metric
- setContextLength: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/multiStepOrchestrator.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js, server/services/RAG/multiStepOrchestrator.js to set context length
Outgoing Calls:
- reuseMetric: count=4; defined_in=utils/ragMetrics.js; Purpose: invokes reuse metric
- labels: count=4; defined_in=external/unknown; Purpose: invokes labels
- inc: count=3; defined_in=external/unknown; Purpose: invokes inc
- require: count=1; defined_in=external/unknown; Purpose: invokes require
- getSingleMetric: count=1; defined_in=external/unknown; Purpose: invokes get single metric
- factory: count=1; defined_in=external/unknown; Purpose: invokes factory
- registerMetric: count=1; defined_in=external/unknown; Purpose: invokes register metric
- set: count=1; defined_in=external/unknown; Purpose: invokes set

## utils/security.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: sanitizeInput
Functions:
- escapeHtml: status=используется; callers: utils/security.js; Purpose: triggered from utils/security.js to escape html
- fromArray: status=используется; callers: utils/security.js; Purpose: triggered from utils/security.js to from array
- normalizeString: status=используется; callers: utils/security.js; Purpose: triggered from utils/security.js to normalize string
- sanitizeInput: status=используется; callers: server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js; Purpose: triggered from server/controllers/agents/client.js, server/services/RAG/RagContextBuilder.js to sanitize input
- tryFastPath: status=используется; callers: utils/security.js; Purpose: triggered from utils/security.js to try fast path
Outgoing Calls:
- escapeHtml: count=7; defined_in=utils/security.js; Purpose: invokes escape html
- normalizeString: count=6; defined_in=utils/security.js; Purpose: invokes normalize string
- String: count=4; defined_in=external/unknown; Purpose: invokes string
- push: count=4; defined_in=external/unknown; Purpose: invokes push
- replace: count=3; defined_in=external/unknown; Purpose: invokes replace
- isBuffer: count=2; defined_in=external/unknown; Purpose: invokes is buffer
- test: count=1; defined_in=external/unknown; Purpose: invokes test
- normalize: count=1; defined_in=external/unknown; Purpose: invokes normalize
- toString: count=function toString() { [native code] }11; defined_in=external/unknown; Purpose: invokes to string
- slice: count=1; defined_in=external/unknown; Purpose: invokes slice
- join: count=1; defined_in=external/unknown; Purpose: invokes join
- tryFastPath: count=1; defined_in=utils/security.js; Purpose: invokes try fast path
- isArray: count=1; defined_in=external/unknown; Purpose: invokes is array
- fromArray: count=1; defined_in=utils/security.js; Purpose: invokes from array
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify

## utils/temporalClient.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: enqueueMemoryTask, enqueueGraphTask, enqueueSummaryTask
Functions:
- enqueueGraphTask: status=используется; callers: server/controllers/agents/request.js, server/services/Graph/LongTextWorker.js; Purpose: triggered from server/controllers/agents/request.js, server/services/Graph/LongTextWorker.js to enqueue graph task
- enqueueMemoryTask: status=используется; callers: server/services/RAG/memoryQueue.js; Purpose: triggered from server/services/RAG/memoryQueue.js to enqueue memory task
- enqueueSummaryTask: status=используется; callers: manage_summaries.js, server/controllers/agents/request.js; Purpose: triggered from manage_summaries.js, server/controllers/agents/request.js to enqueue summary task
- getQueueConfig: status=используется; callers: utils/temporalClient.js; Purpose: triggered from utils/temporalClient.js to get queue config
- isNatsEnabled: status=используется; callers: server/services/Deduplication/ingestDeduplicator.js, server/services/Graph/LongTextWorker.js, utils/temporalClient.js; Purpose: triggered from server/services/Deduplication/ingestDeduplicator.js, server/services/Graph/LongTextWorker.js, utils/temporalClient.js to is nats enabled
- publishWithFallback: status=используется; callers: utils/temporalClient.js; Purpose: triggered from utils/temporalClient.js to publish with fallback
- resolveSubject: status=используется; callers: utils/temporalClient.js; Purpose: triggered from utils/temporalClient.js to resolve subject
Outgoing Calls:
- require: count=4; defined_in=external/unknown; Purpose: invokes require
- warn: count=3; defined_in=server/controllers/agents/client.js, server/utils/messageUtils.js; Purpose: invokes warn
- publishWithFallback: count=3; defined_in=utils/temporalClient.js; Purpose: invokes publish with fallback
- getQueueConfig: count=2; defined_in=utils/temporalClient.js; Purpose: invokes get queue config
- isNatsEnabled: count=2; defined_in=utils/temporalClient.js; Purpose: invokes is nats enabled
- info: count=2; defined_in=external/unknown; Purpose: invokes info
- getSection: count=1; defined_in=external/unknown; Purpose: invokes get section
- get: count=1; defined_in=external/unknown; Purpose: invokes get
- resolveSubject: count=1; defined_in=utils/temporalClient.js; Purpose: invokes resolve subject
- publish: count=1; defined_in=utils/natsClient.js; Purpose: invokes publish
- error: count=1; defined_in=external/unknown; Purpose: invokes error
- fetch: count=1; defined_in=external/unknown; Purpose: invokes fetch
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
- catch: count=1; defined_in=external/unknown; Purpose: invokes catch
- text: count=1; defined_in=external/unknown; Purpose: invokes text
- json: count=1; defined_in=external/unknown; Purpose: invokes json

## utils/tokenReport.js
Purpose: Utility helpers
Inbound Links: none detected
Exports: writeTokenReport
Functions:
- writeTokenReport: status=используется; callers: server/controllers/agents/client.js; Purpose: triggered from server/controllers/agents/client.js to write token report
Outgoing Calls:
- require: count=2; defined_in=external/unknown; Purpose: invokes require
- resolve: count=1; defined_in=external/unknown; Purpose: invokes resolve
- existsSync: count=1; defined_in=external/unknown; Purpose: invokes exists sync
- mkdirSync: count=1; defined_in=external/unknown; Purpose: invokes mkdir sync
- join: count=1; defined_in=external/unknown; Purpose: invokes join
- writeFileSync: count=1; defined_in=external/unknown; Purpose: invokes write file sync
- stringify: count=1; defined_in=external/unknown; Purpose: invokes stringify
