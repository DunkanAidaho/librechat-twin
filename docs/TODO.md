# LibreChat RAG & Memory Improvement Plan

–≠—Ç–∞ –¥–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ –≤–∫–ª—é—á–∞–µ—Ç **–≤–µ—Å—å –ø—É–ª –∑–∞–¥–∞—á** –ø–æ –∫–∞—Å—Ç–æ–º–Ω–æ–º—É LibreChat ‚Äî –∫–∞–∫ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ, —Ç–∞–∫ –∏ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è.
–î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –¥–µ—Ç–∞–ª–∏ ¬´—á—Ç–æ —Å–¥–µ–ª–∞—Ç—å¬ª, ¬´–∫–∞–∫ –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å¬ª, ¬´–∫–∞–∫ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å¬ª, –∞ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏ –∏–ª–∏
–≤–æ–∑–º–æ–∂–Ω—ã–µ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥—Ö–æ–¥–æ–≤)

1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è sanitizeInput (fast-path + –ª–∏–º–∏—Ç –º–∞—Å—Å–∏–≤–æ–≤)**
   - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω –±—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö ASCII-—Å—Ç—Ä–æ–∫, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏ —Å–∫–ª–µ–π–∫–µ –º–∞—Å—Å–∏–≤–æ–≤.
   - –ö–∞–∫ –Ω–µ–ª—å–∑—è: –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ JSON.stringify –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å—Ç—Ä–æ–∫; –¥–æ–±–∞–≤–ª—è—Ç—å —Ç—è–∂—ë–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ hot-path.
   - –ö–∞–∫ –Ω—É–∂–Ω–æ: –æ—Å—Ç–∞–≤–ª—è—Ç—å fast-path, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ª–∏–º–∏—Ç—ã, –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–ª–ª–æ–∫–∞—Ü–∏–∏.

2. **Temporal client: –ø—Ä–æ–≤–µ—Ä–∫–∞ subject –∏ fallback**
   - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ: –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–µ–º—ã NATS –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è HTTP fallback —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
   - –ö–∞–∫ –Ω–µ–ª—å–∑—è: —Å–ª–µ–ø–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ queueConfig.subjects –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏.
   - –ö–∞–∫ –Ω—É–∂–Ω–æ: –ø–µ—Ä–µ–¥ publish –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, —Ñ–æ–ª–±–µ—á–∏—Ç—å.

3. **NATS client: –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π backoff + auth fallbacks**
   - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π backoff, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (user/pass –∏–ª–∏ token).
   - –ö–∞–∫ –Ω–µ–ª—å–∑—è: –∂—ë—Å—Ç–∫–æ –∑–∞–±–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∫–æ–¥, –¥–µ—Ä–∂–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π backoff.
   - –ö–∞–∫ –Ω—É–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å retryAsync —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º, –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ø—ã—Ç–∫–∏.

4. **Memory config cache —Å TTL**
   - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ: –∫–µ—à —Å–µ–∫—Ü–∏–∏ memory/bin —Å —Ç–∞–π–º-–∞—É—Ç–æ–º, refresh –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é.
   - –ö–∞–∫ –Ω–µ–ª—å–∑—è: —Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞–≤—Å–µ–≥–¥–∞, –∑–∞—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
   - –ö–∞–∫ –Ω—É–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TTL –∏ refreshCache().

5. **RAG logger –∏ keep-alive –∞–≥–µ–Ω—Ç—ã**
   - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ: ragLogger –¥–ª—è –µ–¥–∏–Ω—ã—Ö –ª–æ–≥–æ–≤, httpAgents –¥–ª—è axios keep-alive.
   - –ö–∞–∫ –Ω–µ–ª—å–∑—è: –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ö–∞–æ—Ç–∏—á–Ω–æ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö, –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ TCP –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å.
   - –ö–∞–∫ –Ω—É–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ragLogger.* –∏ httpAgents.getKeepAliveAgents().

6. **–û—á–µ—Ä–µ–¥—å memoryStorageQueue –¥–ª—è isMemoryStored**
   - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ: –±–∞—Ç—á–µ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å + flush/retry –ª–æ–≥–∏–∫–∞.
   - –ö–∞–∫ –Ω–µ–ª—å–∑—è: –¥–µ—Ä–≥–∞—Ç—å updateMany –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
   - –ö–∞–∫ –Ω—É–∂–Ω–æ: enqueue(userId, messageIds, meta) –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ flush‚Äô–∏.

7. **TTL-–æ—á–∏—Å—Ç–∫–∞ –¥–ª—è ingest dedupe –∫–ª—é—á–µ–π**
   - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ: –∫–∞—Ä—Ç–∞ —Å expiresAt, –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞, LRU –ø—Ä–∏ –∏–∑–±—ã—Ç–∫–µ.
   - –ö–∞–∫ –Ω–µ–ª—å–∑—è: —Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏ –±–µ—Å—Å—Ä–æ—á–Ω–æ, –æ—Ç—ä–µ–¥–∞—è –ø–∞–º—è—Ç—å.
   - –ö–∞–∫ –Ω—É–∂–Ω–æ: —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ registerIngestMark, –æ—á–∏—â–∞—Ç—å sweepExpiredIngestMarks.

8. **Memory guard –≤ Mongo**
   - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ: ensureConversationMemoryFlags() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥–∏, –¥–æ–≥–æ–Ω—è–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
   - –ö–∞–∫ –Ω–µ–ª—å–∑—è: –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –≤–Ω–µ—à–Ω–∏–π RAG –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ Mongo.
   - –ö–∞–∫ –Ω—É–∂–Ω–æ: –±—Ä–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Message.find, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å add_turn, —Å—Ç–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ enqueue.

---

## üîú –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏ (–ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è)

### 1. Transparent logging initiative (—Å–∫–≤–æ–∑–Ω–æ–µ API-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- **–°—Ç–∞—Ç—É—Å**
  - memoryQueue + temporalClient, scripts (manage_summaries/sync_history), routes/files (+ RAG –ø–æ–¥—Ä–æ—É—Ç—ã) –∏ response utils —É–∂–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ scoped –ª–æ–≥–≥–µ—Ä—ã –∏ `buildContext`.
  - ‚úÖ RAG core (`condense`, `multiStepOrchestrator`, `LongTextWorker`, `RagContextBuilder`, `RagCache`, `intentAnalyzer`) –∑–∞–≤–µ—Ä—à—ë–Ω, Map/Reduce –ª–æ–≥–∏—Ä—É–µ—Ç `rag.condense.*` –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π `rag.condense.mr_finished`.
  - –í —Ä–∞–±–æ—Ç–µ: –º–∞—Ä—à—Ä—É—Ç—ã SSE.
  - –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç: LLM clients (`Anthropic`, `OpenAI`, `Google`, `BaseClient`).
- [x] RAG core: RagContextBuilder / RagCache / intentAnalyzer / multiStepOrchestrator / LongTextWorker / condense  
- [ ] LLM clients: BaseClient / Anthropic / OpenAI / Google (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –æ–±–Ω–æ–≤–∏—Ç—å `docs/1_Trasparent_logging.md` –∏ —á–µ–∫–ª–∏—Å—Ç)
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –µ–¥–∏–Ω—ã–π —Å–ª–æ–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö API-–ø—Ä–æ—Ö–æ–¥–æ–≤ (–∫–ª–∏–µ–Ω—Ç—ã, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, —Å–µ—Ä–≤–∏—Å—ã, –æ—á–µ—Ä–µ–¥–∏, —É—Ç–∏–ª–∏—Ç—ã), —á—Ç–æ–±—ã –∫–∞–∂–¥–∞—è —Å—Ç–∞–¥–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∞—Å—å —Å –µ–¥–∏–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –∏ requestId.
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–∞–Ω –∏–∑ `docs/1_Trasparent_logging.md`, –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –æ–±–ª–∞—Å—Ç—è–º–∏ –∏–∑ `docs/project_map`.
- **–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è**
  1. **Config & –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**
     - –†–∞—Å—à–∏—Ä–∏—Ç—å `logging` —Å–µ–∫—Ü–∏—é `ConfigService`: –≥–ª–æ–±–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å, —Ñ–æ—Ä–º–∞—Ç (json/text), –æ–ø—Ü–∏–∏ –∫–æ–Ω—Å–æ–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤, —Ñ–∞–π–ª–æ–≤—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, feature-—Ñ–ª–∞–≥–∏ (`tracePipeline`, `debugSse`, `tokenUsageReportMode`).
     - –û–±–Ω–æ–≤–∏—Ç—å `.env` –ø—Ä–∏–º–µ—Ä—ã –∏ README —Å –Ω–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏.
  2. **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
     - ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `api/utils/logger` (Winston + `createScopedLogger`, `sanitizePlainObject`).
     - –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `branchLogger`, —á—Ç–æ–±—ã –≤–µ—Ç–≤–µ–≤–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–ª scoped –ª–æ–≥–≥–µ—Ä.
  3. **Request context & middleware**
     - –í `server/routes/agents/chat.js` –∏ –¥—Ä—É–≥–∏—Ö –≤—Ö–æ–¥–Ω—ã—Ö —Ç–æ—á–∫–∞—Ö –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `requestId`, –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—Ç—å –≤ `req.context`.
     - –û–±–Ω–æ–≤–∏—Ç—å SSE/response utils (`server/utils/responseUtils.js`) –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è `requestId`/`conversationId` –≤ –ª–æ–≥–∞—Ö.
  4. **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π (–ø–æ project_map)**
     - **–ö–ª–∏–µ–Ω—Ç—ã LLM** (`app/clients/AnthropicClient.js`, `BaseClient.js`, `GoogleClient.js`, `OpenAIClient.js`, `app/clients/utils/instructions.js`): *–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ* ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è `request:start`, `stream:token`, `request:retry`, `request:error`.
     - **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã** (`server/controllers/agents/client.js`, `server/controllers/agents/request.js`, middleware, routes/files/*, response utils): *—á–∞—Å—Ç–∏—á–Ω–æ –≥–æ—Ç–æ–≤–æ* ‚Äî requestId middleware –≤ `/agents`, `/files`, response utils –æ–±–Ω–æ–≤–ª–µ–Ω—ã.
     - **RAG / Memory —Å–µ—Ä–≤–∏—Å—ã** (`server/services/RAG/*`, `Graph/LongTextWorker`, `memoryQueue` –∏ –¥—Ä.): *memoryQueue + temporalClient –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, Map/Reduce condense –∏ MessageHistoryManager –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã*, –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–µ—Ä–≤–∏—Å—ã –≤ –º–∏–≥—Ä–∞—Ü–∏–∏.
     - **–£—Ç–∏–ª–∏—Ç—ã –∏ –æ—á–µ—Ä–µ–¥–∏** (`utils/metrics.js`, `utils/ragMetrics.js`, `utils/memoryConfig.js`, `utils/natsClient.js`, `utils/async.js`, `manage_summaries.js`, `sync_history.js`, `server/routes/files/*`, `server/routes/convos.js`): *routes/files –∏ core scripts –æ–±–Ω–æ–≤–ª–µ–Ω—ã*, –æ—Å—Ç–∞–ª—å–Ω—ã–µ queued.
  5. **–§–æ—Ä–º–∞—Ç—ã –∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è**
     - –£—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–∞–±–æ—Ä –ø–æ–ª–µ–π (`timestamp`, `level`, `scope`, `message`, `requestId`, `conversationId`, `userId`, `context`).
     - –î–ª—è trace-—Ä–µ–∂–∏–º–∞ –ø–∏—Å–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–∫–µ–Ω–∞–π–∑–µ—Ä, RAG cache hits) –≤ `meta`.
  6. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞**
     - –û–±–Ω–æ–≤–∏—Ç—å `docs/1_Trasparent_logging.md` –ø–æ –º–µ—Ä–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Å—Ç–∞—Ç—É—Å, –ø—Ä–∏–º–µ—Ä—ã JSON/console).
     - –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª –≤ `docs/project_map` –æ —Å—Ç–∞—Ç—É—Å–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —Ñ–∞–π–ª–∞–º (–≥–æ—Ç–æ–≤–æ/–≤ —Ä–∞–±–æ—Ç–µ).
     - –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: smoke-—Ç–µ—Å—Ç—ã —Å `TRACE_PIPELINE=true`, –ø—Ä–æ–≥–æ–Ω unit/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≥–æ, —á—Ç–æ `DEBUG_SSE`/`tokenUsageReportMode` –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ ENV.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - –°–º–µ—à–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ª–æ–≥–∏ –∏ —Å—Ç–∞—Ä—ã–π `debug` –ø–∞–∫–µ—Ç, –æ—Å—Ç–∞–≤–ª—è—è —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã.
  - –î–æ–±–∞–≤–ª—è—Ç—å —Ç—è–∂—ë–ª—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä (–Ω—É–∂–µ–Ω –ª—ë–≥–∫–∏–π JSON/printf).
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å scoped loggers –ø–æ–≤—Å–µ–º–µ—Å—Ç–Ω–æ, –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–Ω–µ Logger-–º–æ–¥—É–ª—è.
  - –î–ª—è —à—É–º–Ω—ã—Ö –ø—É—Ç–µ–π (RAG trace) –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –≤—ã–≤–æ–¥ –∫ –∫–æ–Ω—Ñ–∏–≥-—Ñ–ª–∞–≥–∞–º.

### 2. Multi-step RAG + Graph resilience (–∏–Ω—Ü–∏–¥–µ–Ω—Ç 18‚Äì20 —Ñ–µ–≤ 2026)
- **–°—Ç–∞—Ç—É—Å**
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–Ω—Ü–∏–¥–µ–Ω—Ç `18‚Äì20.02.2026`) —Å–æ–æ–±—â–∏–ª, —á—Ç–æ multi-step RAG+Graph –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –¥–∞–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–∞—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ —á–µ—Ä–µ–∑ LongText-–æ–±—ë—Ä—Ç–∫–∏.
  - –ù–∞–±–ª—é–¥–∞—é—Ç—Å—è —Ç–∞–π–º–∞—É—Ç—ã –∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –º–µ–∂–¥—É LongTextWorker ‚Üí RagContextBuilder ‚Üí multiStepOrchestrator; –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –ª–∏ fallback‚Äô–∏.
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - –†–∞—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∫–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã (pipeline, –∫–æ–Ω—Ñ–∏–≥, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞), –æ—Ñ–æ—Ä–º–∏—Ç—å –æ—Ç—á—ë—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ —Ä–µ—à–µ–Ω–∏—è –∏ —Å—Ä–æ–∫–∞–º–∏.
  - –ó–∞–∫–∞–ª–∏—Ç—å multi-step RAG+Graph: –≤—ã–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫—Ä—É–ø–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã, –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Graph+Vector –æ—Ç–≤–µ—Ç—ã –∏ LongText ingest –±–µ–∑ —Ä—É—á–Ω—ã—Ö –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π.
  - –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (load/perf + regression) –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–¥–æ–±–Ω—ã–π —Ä–µ–≥—Ä–µ—Å—Å –ª–æ–≤–∏–ª—Å—è –¥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.
- **–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è**
  1. **–°–±–æ—Ä —Ñ–∞–∫—Ç–æ–≤**: –≤—ã–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏/–º–µ—Ç—Ä–∏–∫–∏ –∑–∞ `18‚Äì20.02.2026`, —Å–æ–±—Ä–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ conversationId, –¥–µ–¥—É–ø-–∫–ª—é—á–∏ LongTextWorker, —Å—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–µ–π.
  2. **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è**: –ø–æ–¥–Ω—è—Ç—å stand-alone —Å—Ü–µ–Ω–∞—Ä–∏–π (LongText ingestion ‚Üí multi-step RAG) —Å —Ç–µ–º –∂–µ –∫–æ–Ω—Ñ–∏–≥–æ–º –æ–±—ä–µ–º–æ–≤; –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å, –≥–¥–µ —Ä–≤—ë—Ç—Å—è (memoryQueue, Graph fetch, summarize).
  3. **–ê—É–¥–∏—Ç pipeline**: –ø—Ä–æ–π—Ç–∏ —Ü–µ–ø–æ—á–∫—É `LongTextWorker ‚Üí RagContextBuilder ‚Üí multiStepOrchestrator ‚Üí condenseContext`, –≤—ã—è–≤–∏—Ç—å: –∞) –∑–∞–≤–∏—Å–∞–Ω–∏—è –Ω–∞ cache-miss, –±) –Ω–µ–≤–µ—Ä–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã/–±—é–¥–∂–µ—Ç—ã, –≤) –∫–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ summarization vs. LongText.
  4. **–§–∏–∫—Å—ã**: 
     - –≤—ã—Ä–æ–≤–Ω—è—Ç—å timeout/–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É Graph –∏ summarizer (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π `timeoutMs`, budget-aware chunking),
     - –¥–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π (backpressure, –¥–µ–¥—É–ø),
     - –æ–±–µ—Å–ø–µ—á–∏—Ç—å, —á—Ç–æ LongText-—á–∞–Ω–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∏ –Ω–µ –ª–æ–º–∞—é—Ç multi-step —Å–ª–æ–∏.
  5. **–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–≤–µ –æ–ø—Ü–∏–∏ (–±—ã—Å—Ç—Ä—ã–π workaround + –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–∞—Ç—á), –æ–ø–∏—Å–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ: –∫–æ–≥–¥–∞ –≤–∫–ª—é—á–∞—Ç—å degraded mode, –∫–æ–≥–¥–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å multi-step.
  6. **–¢–µ—Å—Ç—ã –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å**: –∞–≤—Ç–æ—Ç–µ—Å—Ç –Ω–∞ large-context, –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –ø—Ä–æ–≥–æ–Ω —Å LongText wrappers, –∞–ª–µ—Ä—Ç—ã –ø–æ —Ç–∞–π–º–∞—É—Ç–∞–º `multiStepRag`/`graph.enqueue`.
  7. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –æ–±–Ω–æ–≤–∏—Ç—å `docs/LongTextWorker.md`/`docs/RAG.md` (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ) –∏ —á–µ–∫–ª–∏—Å—Ç `docs/coder_checklist.md` –ø—É–Ω–∫—Ç–æ–º –ø—Ä–æ multi-step.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - ¬´–ü–æ–¥–∫—Ä—É—á–∏–≤–∞—Ç—å¬ª —Ç–∞–π–º–∞—É—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ –±–µ–∑ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω, –æ—Ç–∫–ª–∞–¥—ã–≤–∞—è RCA.
  - –ü—Ä–∞–≤–∏—Ç—å LongTextWorker –≤ –æ–±—Ö–æ–¥ –¥–µ–¥—É–ø/–æ—á–µ—Ä–µ–¥–µ–π –∏–ª–∏ –æ—Ç–∫–ª—é—á–∞—Ç—å multi-step –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –î–µ–ª–∞—Ç—å RCA —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (requestId, conversationId, ded—É–øKey).
  - –í—ã–∫–∞—Ç—ã–≤–∞—Ç—å —Ñ–∏–∫—Å—ã –ø–æ–¥ feature-flag/–∫–æ–Ω—Ñ–∏–≥–æ–º, —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–º —Ç–µ—Å—Ç–æ–º –∏ –ø—É–±–ª–∏—á–Ω—ã–º –ø–æ—Å—Ç–º–æ—Ä—Ç–µ–º.

#### –ü–ª–∞–Ω —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ multi-step RAG (v0 ‚Üí v2)

**–≠—Ç–∞–ø 0 ‚Äî Hotfix (—Ç–µ–∫—É—â–∏–π —Ä–µ–ª–∏–∑)**
- –¶–µ–ª—å: —É–±—Ä–∞—Ç—å —Ä–∞–∑—Ä—É—à–∞—é—â–∏–π prompt-shrink, –ø–æ–∫–∞ –Ω–µ –≤–Ω–µ–¥—Ä—ë–Ω –Ω–æ–≤—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä.
- –î–µ–π—Å—Ç–≤–∏—è:
  - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –≤ prompt, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ —É—à–ª–∏ –≤ –ø–∞–º—è—Ç—å;
  - –æ—Å—Ç–∞–≤–ª—è–µ–º ingest –≤ –ø–∞–º—è—Ç—å (RAG –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç);
  - –ª–æ–≥–∏—Ä—É–µ–º `rag.history.prompt_passthrough`, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å, —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ ¬´—Ç—è–∂—ë–ª—ã–µ¬ª.
- Smoke-—Ç–µ—Å—Ç –ø–µ—Ä–µ–¥ –≤—ã–∫–ª–∞–¥–∫–æ–π:
  - –∑–∞–≥—Ä—É–∑–∏—Ç—å LongText (>60k —Ç–æ–∫–µ–Ω–æ–≤) –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –±–æ–ª—å—à–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `[..., truncated ...]`;
  - –ø–æ –ª–æ–≥–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ ingestion –æ—Å—Ç–∞—ë—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º (`rag.history.memory_task_prepared`, `memoryQueue.start`);
  - –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É `rag_history_passthrough_total` ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Ç—è–∂—ë–ª—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.
- –ö–∞–∫ –Ω–µ–ª—å–∑—è: –æ—Å—Ç–∞–≤–ª—è—Ç—å `[[moved_to_memory]]` –≤ prompt; —Å–º–µ—à–∏–≤–∞—Ç—å —É—Å–µ—á—ë–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ –∏ —Å–≤–µ–∂–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.
- –ö–∞–∫ –Ω—É–∂–Ω–æ: –¥–æ –≤—ã–≤–æ–¥–∞ –Ω–æ–≤–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å LLM –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç, –Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Ç–æ–∫–µ–Ω–∞–º–∏ (–ª–æ–≥ + –º–µ—Ç—Ä–∏–∫–∏).

**–≠—Ç–∞–ø 1 ‚Äî –ñ–∏–≤–æ–µ –æ–∫–Ω–æ –∏ history-orchestrator**
- –ñ–∏–≤–æ–µ –æ–∫–Ω–æ (N –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π) –¥–µ—Ä–∂–∏–º —Ü–µ–ª–∏–∫–æ–º, –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤.
- –û—Å—Ç–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç—å (vector/graph). –í prompt ‚Äî –ª–∏–±–æ —Å—Å—ã–ª–∫–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏), –ª–∏–±–æ –Ω–∏—á–µ–≥–æ (–µ—Å–ª–∏ RAG –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ç—è–Ω–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç).
- –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥ `RAG_HISTORY_MODE=full|memory_ref|drop`.
  - full ‚Äî legacy —Ä–µ–∂–∏–º;
  - memory_ref ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∂–∏–≤–æ–µ –æ–∫–Ω–æ + –ø–∞–º—è—Ç—å;
  - drop ‚Äî –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (fallback –¥–ª—è headless).

**–≠—Ç–∞–ø 2 ‚Äî Context orchestrator + —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏**
- –í–≤–æ–¥–∏–º `RAG_STRATEGY=simple|multistep|cascade`.
  - simple ‚Äî vector + graph –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ö–æ–¥–æ–≤;
  - multistep ‚Äî —Ç–µ–∫—É—â–∏–π –∫–∞—Å–∫–∞–¥ —Å intent ‚Üí follow-up;
  - cascade ‚Äî multi-step + condense + –∫—ç—à.
- –ö—ç—à (`RAG_CACHE_ENABLED`) –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–µ—à–∞–µ—Ç, –∫–∞–∫–∏–µ –∫–ª–∞—Å—Ç–µ—Ä—ã –∏–∑ –ø–∞–º—è—Ç–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ prompt; placeholder –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∫ LLM.

**–≠—Ç–∞–ø 3 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏/—Ç—Ä–µ–π—Å–∏–Ω–≥**
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ (`history_window`, `memory_ingest`, `rag_fetch`, `multi_step`, `prompt_build`) –ª–æ–≥–∏—Ä—É–µ–º `rag.pipeline.stage`.
- –î–æ–±–∞–≤–ª—è–µ–º gauge —Ç–∏–ø–∞ `rag_context_window_tokens`, `rag_history_passthrough_total`.
- `requestId`/`messageId` –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –≤–æ –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –ª–æ–≥–∞—Ö.

**Best practices (–¥–ª—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤)**
- –ò—Å—Ç–æ—Ä–∏—è: –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è.
- Multi-step: –ª—é–±—ã–µ —Å—Ä–µ–∑—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–æ–ª–∂–Ω—ã —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã, –∞ –Ω–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ `[...truncated...]`.
- Graph/vector: —Ç–∞–π–º–∞—É—Ç—ã –∑–∞–≤—è–∑–∞–Ω—ã –Ω–∞ –æ–±—ä—ë–º –∑–∞–ø—Ä–æ—Å–∞ (`timeoutMs = base + contextLength/50`).
- –†–µ–∂–∏–º—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ ENV (–Ω–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ –∫–æ–¥–µ).
- –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –≤–∫–ª—é—á–∞–µ–º `TRACE_PIPELINE`, –ø—Ä–æ–≤–µ—Ä—è–µ–º pipeline-stage.

### 3. Size-aware RAG cache (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è #6)
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - –í–µ—Å—Ç–∏ —É—á—ë—Ç ¬´–≤–µ—Å–∞¬ª –∑–∞–ø–∏—Å–µ–π (—Å–∏–º–≤–æ–ª—ã/—Ç–æ–∫–µ–Ω—ã) –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –∫—ç—à –Ω–µ —Ç–æ–ª—å–∫–æ TTL, –Ω–æ –∏ —Å—É–º–º–∞—Ä–Ω—ã–º –±—é–¥–∂–µ—Ç–æ–º.
  - –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏ –ª–∏–º–∏—Ç; –µ—Å–ª–∏ –¥–∞ ‚Äî —É–¥–∞–ª—è—Ç—å —Å–∞–º—ã–µ ¬´—Ç—è–∂—ë–ª—ã–µ¬ª –∏–ª–∏ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - –£–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å–∏ –±–µ–∑ —É—á—ë—Ç–∞ –≤–µ—Å–∞ (–ø—Ä–æ—Å—Ç–æ –ø–æ FIFO).
  - –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –±–æ–ª—å—à–µ –±—é–¥–∂–µ—Ç–∞: –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –µ—ë –≤–æ–≤—Å–µ).
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ `memory.ragCache.maxSizeTokens`/`maxSizeChars`.
  - –•—Ä–∞–Ω–∏—Ç—å –≤ ragCache —Å—Ç—Ä—É–∫—Ç—É—Ä—É `{sizeTokens, ...}` –∏ –≤–µ—Å—Ç–∏ —Ç–µ–∫—É—â—É—é —Å—É–º–º—É.
  - –ü–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –æ—á–∏—â–∞—Ç—å –ø–æ–∫–∞ —Å—É–º–º–∞ + –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å > –ª–∏–º–∏—Ç–∞, –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —ç–≤–∏–∫—Ü–∏–∏.

### 4. Unified AbortController chain (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è #10)
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - –°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π AbortController –Ω–∞ –∑–∞–ø—Ä–æ—Å –∏ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—Ç—å –µ–≥–æ –≤–æ –≤—Å–µ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å—ã (RAG, –≥—Ä–∞—Ñ, vector search, memory queue).
  - –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - –°–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –±–µ–∑ —Å–≤—è–∑–∫–∏ (–Ω–µ–ª—å–∑—è, —á—Ç–æ–±—ã –ø–∞–º—è—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞).
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å helper `createLinkedAbortSignal(parentSignal, ...children)` –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –æ–¥–∏–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ req.context.
  - –í `buildRagContext`, `enqueueMemoryTasksSafe`, `fetchGraphContext` –∏ —Ç.–¥. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–∏–π signal.

### 5. Adaptive RAG retry strategy (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è #8)
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏/–º–µ—Ç—Ä–∏–∫ RAG-–ø–∞–π–ø–ª–∞–π–Ω–∞ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è `429`).
  - –°–æ–±–∏—Ä–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–æ—Ç–≤–µ—Ç 503, —Ç–∞–π–º–∞—É—Ç—ã) –∏ —É—Å–∏–ª–∏–≤–∞—Ç—å backoff.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - –õ–µ–∑—Ç—å –≤ `retryAsync` —Å –∂—ë—Å—Ç–∫–∏–º delay; –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã –æ—à–∏–±–æ–∫.
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –í `runWithResilience` —Ä–∞—Å—à–∏—Ä–∏—Ç—å onRetry, –ø–µ—Ä–µ–¥–∞–≤–∞—è —Ç–∏–ø –æ—à–∏–±–∫–∏.
  - –í RAG-–∑–∞–ø—Ä–æ—Å–∞—Ö (graph, vector) –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å: 5xx -> —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏, 4xx -> –±—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞–∑.

### 6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–≤–µ—Ä–∫–∞ Mongo ‚Üî pgvector (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - –ï—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è API –≤ tools-gateway, –¥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ pgvector –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ `isMemoryStored`.
  - –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–µ—Ä–≥–∞—Ç—å `/rag/status` —Å messageId, —Å–≤–µ—Ä—è—Ç—å —Å–ø–∏—Å–æ–∫.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞—Ç—å, —á—Ç–æ pgvector –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω (–¥–æ–±–∞–≤–∏—Ç—å guard).
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –û–±–Ω–∞—Ä—É–∂–∏–≤ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ, –∑–∞–ø—É—Å–∫–∞—Ç—å repair (–ø–æ—Ö–æ–∂–µ –Ω–∞ memoryGuard).
  - –ü—Ä–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –≤ –ª–æ–≥–∞—Ö –∏ –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É.

### 7. Size-aware ragCache + TTL –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∏
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ Prometheus: —Ç–µ–∫—É—â–∏–π –æ–±—ä—ë–º –∫—ç—à–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–≤–∏–∫—Ü–∏–π, –¥–æ–ª—è —Ö–∏—Ç/–º–∏—Å—Å.
  - –¢—Ä–∏–≥–≥–µ—Ä–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ >80% –∑–∞–≥—Ä—É–∑–∫–µ.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - –ü–æ–ª–∞–≥–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –ª–æ–≥–∏; –±–µ–∑ –º–µ—Ç—Ä–∏–∫ —Å–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é.
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –û–±–Ω–æ–≤–∏—Ç—å `observeCache` (–∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–µ—Ç—Ä–∏–∫—É).
  - –ó–∞–≤–µ—Å—Ç–∏ —Å—á–µ—Ç—á–∏–∫ `ragCacheEvictions{reason="size"}`.

### 8. Abort-safe memory queue (—Å–ª–µ–¥—Å—Ç–≤–∏–µ –∏–∑ #10)
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - –í—Å–µ –≤—ã–∑–æ–≤—ã `enqueueMemoryTasksSafe` –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å signal; –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –Ω–µ –Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ø—ã—Ç–∫–∏.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - –°—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å enqueue –¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É–∂–µ –æ—Ç–º–µ–Ω—ë–Ω.
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –ü–µ—Ä–µ–¥ `runWithResilience` –ø—Ä–æ–≤–µ—Ä—è—Ç—å `signal?.aborted`; –≤ onRetry —Å–º–æ—Ç—Ä–µ—Ç—å `signal`.
  - –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ—á–∏—â–∞—Ç—å pendingIngestMarks, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª–∏.

### 9. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Token Breakdown –ª–æ–≥–∏–∫–∏ (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - `emitPromptTokenBreakdown` –¥–æ–ª–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å `req.promptTokenBreakdown`.
  - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ caching —Ä–µ–∂–∏–º—ã –Ω–µ –ª–æ–º–∞—é—Ç –ø–æ–¥—Å—á—ë—Ç.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å ¬´unknown¬ª conversationId (–µ—Å–ª–∏ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π id).
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞—Ç—å conversationId —á–µ—Ä–µ–∑ req.
  - –ï—Å–ª–∏ breakdown –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –æ—Ç–∫–ª—é—á–∞—Ç—å —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥.

### 10. Headless –∏ non-headless: –µ–¥–∏–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –ª–æ–≥–æ–≤
- **–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å**
  - –ü—Ä–∏–≤–µ—Å—Ç–∏ –ª–æ–≥–∏ –≤ `AgentController` –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É `[agent.controller.<phase>]`.
  - –û—Ç–¥–µ–ª—å–Ω–æ –ø–æ–º–µ—á–∞—Ç—å headless-case.
- **–ö–∞–∫ –Ω–µ–ª—å–∑—è**
  - –ú–∏–∫—Å–æ–≤–∞—Ç—å —Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç –ª–æ–≥–æ–≤ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.
- **–ö–∞–∫ –Ω—É–∂–Ω–æ**
  - –í–≤–µ—Å—Ç–∏ helper `logAgentEvent(phase, meta)`.

---

## ‚Ñπ –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- **–ù–µ —É–¥–∞–ª—è—Ç—å** —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –±–∞—Ç—á-–æ—á–µ—Ä–µ–¥—å `memoryStorageQueue` (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Ñ–∏—á).
- **–ù–µ —Å–º–µ—à–∏–≤–∞—Ç—å** –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –ª–æ–≥–∏ ragLogger —Å –æ–±—ã—á–Ω—ã–º–∏ logger.* ‚Äî ragLogger —Ç–æ–ª—å–∫–æ –¥–ª—è RAG-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
- **–ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å** –¥–æ—Ä–æ–≥–æ—Å—Ç–æ—è—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (vector search) –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ `req?.user?.id` –∏ `conversationId`.
- **–ü—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ—Ç—å** –∫–æ–Ω—Ñ–∏–≥–∏ –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –ª–∏–º–∏—Ç–æ–≤ / TTL (—á–µ—Ä–µ–∑ ConfigService).
- **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å** –∫–∞–∂–¥—É—é –Ω–æ–≤—É—é –º–µ—Ç—Ä–∏–∫—É –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ README/ENV –ø—Ä–∏–º–µ—Ä–∞—Ö.

## –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —á–µ–∫–ª–∏—Å—Ç–æ–º
1. –ü–µ—Ä–µ–¥ —Ä–µ–≤—å—é —Å–≤–µ—Ä—è–µ–º—Å—è —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ (–º–∏–Ω–∏–º—É–º —Ä–∞–∑–¥–µ–ª—ã 1‚Äì5 + –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏).
2. –§–∏–∫—Å–∏—Ä—É–µ–º –∑–∞–º–µ—á–∞–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞—Ä—É—à–µ–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `¬ß3 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ` + —Ñ–∞–π–ª/—Å—Ç—Ä–æ–∫–∞).
3. –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á –≤ `docs/TODO.md` –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, `docs/project_map`.

–ß–µ–∫–ª–∏—Å—Ç —è–≤–ª—è–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∏—á –∏ –∫–æ–¥-—Ä–µ–≤—å—é –¥–ª—è LibreChat Twin.

