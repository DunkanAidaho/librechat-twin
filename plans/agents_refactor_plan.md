# –ü–ª–∞–Ω —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ client.js –∏ request.js

## 1. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

- **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞** ‚Äî [`client.js`](api/server/controllers/agents/client.js)
  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RAG-–∫—ç—à–µ–º, —Å–±–æ—Ä –≥—Ä–∞—Ñ–∞/–≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –∏ –≤—Å—Ç–∞–≤–∫–∞ –±–ª–æ–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
  - –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç (HistoryTrimmer, MessageHistoryManager), —Ä–µ—à–µ–Ω–∏–µ –æ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –∏ –∑–∞–ø–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–∞–º—è—Ç—å.
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π, OCR, –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á –Ω–∞ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ deferred-condensation.
  - –ú—É–ª—å—Ç–∏—à–∞–≥–æ–≤—ã–π RAG, –∑–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–æ–≤/—Ü–µ–ø–æ—á–µ–∫, —Ä–∞–±–æ—Ç–∞ —Å MCP –∏ fallback-–ª–æ–≥–∏–∫–æ–π.
  - –£—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ —Ç–æ–∫–µ–Ω–æ–≤, –æ—Ç—á—ë—Ç—ã, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ—Ç–æ–∫–∞.

- **HTTP-–æ—Ächestrator** ‚Äî [`request.js`](api/server/controllers/agents/request.js)
  - –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSE/Headless –ø–æ—Ç–æ–∫–æ–º.
  - –û—á–µ—Ä–µ–¥–∏ –ø–∞–º—è—Ç–∏/–≥—Ä–∞—Ñ–∞/—Å–∞–º–º–∞—Ä–∏ —Å resilience, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, –º–µ—Ç—Ä–∏–∫–∏.
  - –ü—Ä–∏–Ω—è—Ç–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è, —Ç—Ä–∏–≥–≥–µ—Ä —Å–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏.
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ abort.

## 2. –ù–∞—Ä—É—à–µ–Ω–∏—è –µ–¥–∏–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

1. **–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–µ –∫–ª–∞—Å—Å—ã**: `AgentClient` –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∏—Å—Ç–æ—Ä–∏—é, –ø–∞–º—è—Ç—å, –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ–¥—Å–∏—Å—Ç–µ–º—É –±–∏–ª–ª–∏–Ω–≥–∞.
2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ RAG-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**: –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –∫–µ—à –∏ deferred-—Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å–º–µ—à–∞–Ω—ã —Å HTTP-–ª–æ–≥–∏–∫–æ–π.
3. **–ñ—ë—Å—Ç–∫–∏–µ —Å–≤—è–∑–∏**: controller –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã (axios, redis, temporal) –≤–º–µ—Å—Ç–æ —Ç–æ–Ω–∫–∏—Ö —Ñ–∞—Å–∞–¥–æ–≤.
4. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫**: retry/context overflow –∏ –ø–∞–º—è—Ç—å/–≥—Ä–∞—Ñ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ç–µ—Ö –∂–µ –º–µ—Ç–æ–¥–æ–≤, —É—Å–ª–æ–∂–Ω—è—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
5. **–°–º–µ—à–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏**: –æ—á–∏—Å—Ç–∫–∞ –¥–µ–¥—É–ø-–∫–ª—é—á–µ–π –∏ dispose –∫–ª–∏–µ–Ω—Ç–∞ ¬´—Ä–∞–∑–º–∞–∑–∞–Ω—ã¬ª –ø–æ –≤—Å–µ–º—É –∫–æ–¥—É.

## 3. –¶–µ–ª–µ–≤–∞—è –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```mermaid
graph TD
  HTTP[HTTP Controller]
  Runtime[Agent Runtime Service]
  Context[RAG Context Orchestrator]
  History[History & Memory Service]
  Attach[Attachment Processor]
  Usage[Usage & Pricing Reporter]
  Queue[Background Queue Gateway]

  HTTP --> Runtime
  Runtime --> Context
  Runtime --> History
  Runtime --> Attach
  Runtime --> Usage
  Runtime --> Queue
  Context --> Queue
  History --> Queue
```

**–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:

1. *Agent Runtime Service* ‚Äî –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç `AgentClient`, –æ—Å—Ç–∞–≤–ª—è—è –∫–ª–∞—Å—Å —Ç–æ–Ω–∫–∏–º –∞–¥–∞–ø—Ç–µ—Ä–æ–º –∫ runtime API.
2. *Context Orchestrator* ‚Äî –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ graph/vector fetch, sanitize, summarization –∏ cache API.
3. *History & Memory Service* ‚Äî —Ä–∞–±–æ—Ç–∞ —Å MessageHistoryManager, HistoryTrimmer, mark-as-stored –∏ enqueue memory tasks.
4. *Attachment Processor* ‚Äî OCR/encode, –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –æ–± –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤/–¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤.
5. *Usage & Pricing Reporter* ‚Äî –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –ø–æ–¥—Å—á—ë—Ç–æ–≤, –æ—Ç—á—ë—Ç–æ–≤ –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π.
6. *Background Queue Gateway* ‚Äî —Ñ–∞—Å–∞–¥ –∫ Temporal/NATS/ingestDeduplicator —Å –µ–¥–∏–Ω—ã–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º retry/metrics.

## 4. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

| –§–∞–∑–∞ | –®–∞–≥–∏ | –¶–µ–ª–∏ | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ |
| --- | --- | --- | --- |
| 0. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ | –ö–∞—Ä—Ç–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤, unit-—Ñ–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è RAG/History | –ì–∞—Ä–∞–Ω—Ç–∏—è –∑–Ω–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è | –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ + QA |
| 1. –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞—Å–∞–¥–æ–≤ | –°–æ–∑–¥–∞—Ç—å Context/History/Usage —Ñ–∞—Å–∞–¥—ã —Å –ø—Ä–æ–∫—Å–∏-–º–µ—Ç–æ–¥–∞–º–∏, –ø–æ–∫—Ä—ã—Ç—å smoke-—Ç–µ—Å—Ç–∞–º–∏ | –û–±–µ—Å–ø–µ—á–∏—Ç—å seam –¥–ª—è refactor | Runtime –∫–æ–º–∞–Ω–¥–∞ |
| 2. –ü–µ—Ä–µ–Ω–æ—Å –ª–æ–≥–∏–∫–∏ | –ü–æ–æ—á–µ—Ä—ë–¥–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –±–ª–æ–∫–∏ –∏–∑ [`client.js`](api/server/controllers/agents/client.js) –≤ —Ñ–∞—Å–∞–¥—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º API | –†–∞–∑–≥—Ä—É–∑–∏—Ç—å AgentClient | RAG/Memory –∫–æ–º–∞–Ω–¥—ã |
| 3. –†–µ—Ñ–∞–∫—Ç–æ—Ä HTTP —Å–ª–æ—è | –û–±–Ω–æ–≤–∏—Ç—å [`request.js`](api/server/controllers/agents/request.js) –¥–ª—è –≤—ã–∑–æ–≤–∞ —Ñ–∞—Å–∞–¥–æ–≤, –≤—ã–¥–µ–ª–∏—Ç—å WorkflowCoordinator | –ß–∏—Å—Ç–∞—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è | Backend Core |
| 4. –£–¥–∞–ª–µ–Ω–∏–µ legacy | –û—á–∏—Å—Ç–∫–∞ dead code, —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã, –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ | –í—Å–µ –∫–æ–º–∞–Ω–¥—ã |

## 5. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

- **–ö–æ–º–∞–Ω–¥–∞ Runtime**: –≤–µ–¥—ë—Ç Agent Runtime Service, —Å–ª–µ–¥–∏—Ç –∑–∞ API –º–µ–∂–¥—É HTTP –∏ runtime, –≤–ª–∞–¥–µ–µ—Ç retry/pipeline logic.
- **RAG Team**: —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Context Orchestrator, –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ graph/vector pipeline, –∫—ç—à –∏ summarization.
- **Memory Team**: –≤–ª–∞–¥–µ–µ—Ç History & Memory Service –∏ Attachment Processor, –≤–∫–ª—é—á–∞—è dedupe –∏ mark-as-stored.
- **FinOps/Observability**: Usage & Pricing Reporter, –º–µ—Ç—Ä–∏–∫–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ alerting.
- **Platform/Infra**: Background Queue Gateway, SLA Temporal/NATS, –æ–±–≤—è–∑–∫–∞ resilience.

## 6. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

1. AgentClient –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä—è–º—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ axios/Temporal –∏ –∫ 3rd-party API.
2. HTTP-—Å–ª–æ–π –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã runtime/queue —Ñ–∞—Å–∞–¥–æ–≤.
3. –í—Å–µ –æ—á–µ—Ä–µ–¥–∏ –∏ –ø–∞–º—è—Ç—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Background Queue Gateway.
4. –ù–∞–ª–∏—á–∏–µ e2e/regression —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ RAG cache hit/miss, long-text ingest, multi-step chain.
5. –ú–µ—Ç—Ä–∏–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∏–º—ë–Ω.

## 7. –ò—Ç–µ—Ä–∞—Ü–∏—è 1 ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±—ä—ë–º

–¶–µ–ª—å: —Å–æ–∑–¥–∞—Ç—å *—Ç–æ–Ω–∫–∏–µ –ø—Ä–æ–∫—Å–∏-—Ñ–∞—Å–∞–¥—ã* –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ –∑–∞–º–µ–Ω–∏—Ç—å –ø—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–∞ –∞–¥–∞–ø—Ç–µ—Ä—ã. –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑–æ–ª—è—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

### 7.1 –ö–æ–º–ø–ª–µ–∫—Ç —Ñ–∞—Å–∞–¥–æ–≤

| –§–∞—Å–∞–¥ | –§–∞–π–ª (–ø–ª–∞–Ω) | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ –ø–µ—Ä–≤–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ |
| --- | --- | --- |
| `ContextOrchestrator` | `api/server/services/agents/context/index.js` | –û–±—ë—Ä—Ç–∫–∏ –¥–ª—è `fetchGraphContext`, `sanitizeGraphContext`, `sanitizeVectorChunks`, `mapReduceContext`, `buildRagBlock`, `replaceRagBlock`. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ `client.js` (–±—É–¥—É—Ç –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏).
| `HistoryMemoryService` | `api/server/services/agents/history/index.js` | –ü—Ä–æ–∫—Å–∏ –Ω–∞–¥ `MessageHistoryManager`, `HistoryTrimmer`, `markMessagesAsStored`, `enqueueMemoryTasks`. –í–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Å—Ç–æ —Ä–µ—ç–∫—Å–ø–æ—Ä—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–µ—Ç–æ–¥–æ–≤.
| `UsageReporter` | `api/server/services/agents/usage/index.js` | –û–±—ë—Ä—Ç–∫–∏ –Ω–∞–¥ `recordCollectedUsage`, `spendTokens`, `writeTokenReport`, `observeCost`, `computePromptTokenBreakdown`.
| `QueueGateway` | `api/server/services/agents/queue/index.js` | –ü—Ä–æ–∫—Å–∏ –¥–ª—è `enqueueMemoryTasks`, `enqueueGraphTask`, `enqueueSummaryTask`, `clearDedupeKey`, `ingestDeduplicator`.

### 7.2 –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å

1. **–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª—ã —Ñ–∞—Å–∞–¥–æ–≤** ‚Äî –∫–∞–∂–¥—ã–π —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –≤—ã–∑—ã–≤–∞—é—â–∏–µ —Ç–µ–∫—É—â–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –î–æ–±–∞–≤–∏—Ç—å unit-noop (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã) –ª–∏–±–æ –æ—Å—Ç–∞–≤–∏—Ç—å TODO.
2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `client.js`** ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å –ø—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Ñ–∞—Å–∞–¥–∞–º. –î–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `mapReduceContext`, `fetchGraphContext`) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å feature-flag `ENABLE_AGENT_FACADES` (–∑–Ω–∞—á–µ–Ω–∏–µ —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ env/config, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `false`). –ü—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–Ω–æ–º —Ñ–ª–∞–≥–µ –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ-—Å—Ç–∞—Ä–æ–º—É.
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `request.js`** ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π/–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.
4. **–ë—ç–∫—Å—Ç—Ä–∞–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** ‚Äî —Ñ–∞—Å–∞–¥—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—Ç –ª–æ–≥–≥–µ—Ä –∏–∑ –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ –∫–æ–¥–∞, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.
5. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤ README/CHANGELOG, —á—Ç–æ –≤—Å–µ –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞—Å–∞–¥—ã.

### 7.3 –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–∏

- –ù–æ–≤—ã–µ —Ñ–∞—Å–∞–¥—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –ø–æ–∫—Ä—ã–≤–∞—é—Ç 100% –∏–º–ø–æ—Ä—Ç–æ–≤ –∏–∑ `client.js`/`request.js` –¥–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
- –¢–µ—Å—Ç—ã/–ª–∏–Ω—Ç–µ—Ä—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π snapshot-–ª–æ–≥–∏–∫–∏.
- –§–ª–∞–≥ `ENABLE_AGENT_FACADES` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å –ø—Ä–æ–∫—Å–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `false`).
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∞ —Ä–∞–∑–¥–µ–ª–æ–º ¬´Iteration 1 Facades¬ª.

### 7.4 –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (—Å—Ç–∞—Ç—É—Å)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
| --- | --- | --- |
| Queue Gateway | [`queue/index.js`](api/server/services/agents/queue/index.js) | ‚úÖ —Å–æ–∑–¥–∞–Ω, –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç memory/graph/summary/ingest |
| Context Orchestrator | [`context/index.js`](api/server/services/agents/context/index.js) | ‚úÖ —Å–æ–¥–µ—Ä–∂–∏—Ç sanitize/fetch/map-reduce |
| History Service | [`history/index.js`](api/server/services/agents/history/index.js) | ‚úÖ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `MessageHistoryManager`, `HistoryTrimmer`, `enqueueMemoryTasks` |
| Usage Reporter | [`usage/index.js`](api/server/services/agents/usage/index.js) | ‚úÖ –ø—Ä–æ–∫—Å–∏ –¥–ª—è spend/report/breakdown |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `client.js` | [`client.js`](api/server/controllers/agents/client.js) | üîÑ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ (—á–∞—Å—Ç–∏—á–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã: history/usage/context) |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `request.js` | [`request.js`](api/server/controllers/agents/request.js) | ‚úÖ queueGateway –≤–Ω–µ–¥—Ä—ë–Ω –≤ resilience-—Ö–µ–ª–ø–µ—Ä—ã |

### 7.5 –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥ –≤—Å–µ—Ö –ø—Ä—è–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ (`axios`, `enqueueMemoryTasks`, `spendTokens`, `tokenBreakdown`, RAG helpers) –≤ `client.js` –Ω–∞ —Ñ–∞—Å–∞–¥—ã, –æ–±–µ—Å–ø–µ—á–∏—Ç—å feature-flag.
2. –î–æ–±–∞–≤–∏—Ç—å smoke-—Ç–µ—Å—Ç—ã/–ª–∏–Ω—Ç–µ—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, —É–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
3. –û–±–Ω–æ–≤–∏—Ç—å README/–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –Ω–æ–≤—ã–º —Ñ–∞—Å–∞–¥–∞–º –∏ –ø—Ä–∞–≤–∏–ª—É ¬´–Ω–æ–≤—ã–π –∫–æ–¥ –∏–¥—ë—Ç —á–µ—Ä–µ–∑ —Ñ–∞—Å–∞–¥—ã¬ª.
4. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å Iteration 2: –º–∏–≥—Ä–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ (Context builder ‚Üí Context orchestrator, History trimming ‚Üí History service).

## 8. –ò—Ç–µ—Ä–∞—Ü–∏—è 2 ‚Äî –ø–µ—Ä–µ–Ω–æ—Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

### 8.1 –ë–ª–æ–∫–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞

| –ó–æ–Ω–∞ | –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ |
| --- | --- | --- |
| RAG Context Builder | [`client.js`](api/server/controllers/agents/client.js) ‚Äî —Ñ—É–Ω–∫—Ü–∏–∏ `buildRagContext`, `fetchGraphContext`, `sanitizeGraphContext`, `sanitizeVectorChunks`, `mapReduceContext`, `calculateAdaptiveTimeout` | –í—ã–Ω–µ—Å—Ç–∏ –≤ Context Orchestrator. `client.js` –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã `contextOrchestrator.buildContext()` –∏ –ø–æ–ª—É—á–∞—Ç—å –æ–±—ä–µ–∫—Ç `patchedSystemContent`, `metrics`, `cacheStatus`. |
| History Compression & Memory Ingestion | [`client.js`](api/server/controllers/agents/client.js) ‚Äî –±–ª–æ–∫ `historyManager.processMessageHistory`, `HistoryTrimmer`, `markMessagesAsStored`, –≤—ã–∑–æ–≤—ã `enqueueMemoryTasks` –∏ –º–µ—Ç—Ä–∏–∫ | –û–±–µ—Ä–Ω—É—Ç—å –≤ History Service: –º–µ—Ç–æ–¥—ã `processHistory`, `scheduleMemoryTasks`, `markStored`. `client.js` —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞—ë—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –ø–æ–ª—É—á–∞–µ—Ç `modifiedMessages`, `stats`. |
| Usage / Token Reporting | [`client.js`](api/server/controllers/agents/client.js) ‚Äî `recordCollectedUsage`, `spendTokens`, `writeTokenReport`, `computePromptTokenBreakdown`, `logPromptTokenBreakdown` | –°–æ–∑–¥–∞—Ç—å Usage Reporter API (`usageReporter.recordUsage`, `usageReporter.emitPromptBreakdown`). `client.js` –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `spendTokens`. |

### 8.2 –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

1. **API —Ñ–∞—Å–∞–¥–æ–≤** ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç—å `context/index.js`, `history/index.js`, `usage/index.js` –º–µ—Ç–æ–¥–∞–º–∏ –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è (`buildContext`, `processHistory`, `recordUsage`).
2. **–ü–µ—Ä–µ–Ω–æ—Å RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** ‚Äî –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–æ–¥ `buildRagContext` —Ü–µ–ª–∏–∫–æ–º –≤ Context Orchestrator, –æ—Å—Ç–∞–≤–∏–≤ –≤ `client.js` —Ç–æ–ª—å–∫–æ –≤—ã–∑–æ–≤.
3. **–ü–µ—Ä–µ–Ω–æ—Å History** ‚Äî –≤—ã–Ω–µ—Å—Ç–∏ `historyManager.processMessageHistory` + enqueue/markStored. `client.js` –ø–æ–ª—É—á–∞–µ—Ç `historyResult` –∏ `ingestActions` –∏–∑ —Å–µ—Ä–≤–∏—Å–∞.
4. **Usage Reporter** ‚Äî –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞—Ç—å `recordCollectedUsage`, `emitPromptTokenBreakdown` –∏ –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã `spendTokens`.
5. **–ß–∏—Å—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤** ‚Äî —É–¥–∞–ª–∏—Ç—å –∏–∑ `client.js` –ø—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã `axios`, `enqueueMemoryTasks`, `spendTokens`, `tokenBreakdown`, `ragMetrics.observeCost`.
6. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã 6‚Äì8, –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ñ–∞—Å–∞–¥–æ–≤.

### 8.3 –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

1. `client.js` –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ —Å —Ñ–∞—Å–∞–¥–∞–º–∏ (`context`, `history`, `usage`, `queue`, `memory`).
2. –í—Å–µ RAG/History —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã –º–æ–¥—É–ª—å–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞ (–µ—Å–ª–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç) –∏–ª–∏ smoke-—Ç–µ—Å—Ç–∞–º–∏.
3. Usage Reporter –ª–æ–≥–∏—Ä—É–µ—Ç –∏ —Ç—Ä–∞—Ç–∏—Ç —Ç–æ–∫–µ–Ω—ã –µ–¥–∏–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.
4. README/plan —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ Iteration 2 –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ–≤—ã–µ API.
5. –ù–µ—Ç –ø—Ä—è–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ `enqueueMemoryTasks`, `spendTokens`, `computePromptTokenBreakdown` –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö.
